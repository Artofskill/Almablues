const players = [
    "Cole Palmer", "Nicolas Jackson", "Enzo Fernández", 
    "Moises Caicedo", "Levi Colwill", "Reece James", 
    "Robert Sánchez", "Noni Madueke", "Christopher Nkunku"
  ];

  // Берем userId из localStorage (как в твоем dashboard.html)
  const userId = localStorage.getItem('userId'); 

  async function init() {
    try {
      console.log("Запуск... ID пользователя:", userId);
      
      // 1. Ищем самый свежий матч "Chelsea - Pafos"
      const { data: event, error } = await supabase
        .from('events')
        .select('*')
        .order('match_date', { ascending: false })
        .limit(1)
        .single();

      if (error || !event) {
        document.getElementById('main-content').innerHTML = '<div class="card">Матчи не найдены</div>';
        return;
      }

      document.getElementById('match-title').innerText = event.match_name;
      document.getElementById('match-date').innerText = new Date(event.match_date).toLocaleString('ru-RU');
      
      // ПРОВЕРКА: Если таблица motm_votes пустая, мы в любом случае показываем форму голосования
      checkUserVote(event.id);

    } catch (err) {
      console.error("Ошибка:", err);
      document.getElementById('main-content').innerHTML = 'Ошибка загрузки данных.';
    }
  }

  async function checkUserVote(eventId) {
    if (!userId) {
      document.getElementById('main-content').innerHTML = `
        <div class="card" style="text-align:center;">
          <p>⚠️ Вы не авторизованы (userId не найден).</p>
          <p>Зайдите сначала в <a href="dashboard.html" style="color:var(--gold);">Dashboard</a></p>
        </div>`;
      return;
    }

    const { data: vote } = await supabase
      .from('motm_votes')
      .select('*')
      .eq('event_id', eventId)
      .eq('user_id', userId)
      .maybeSingle();

    if (vote) {
      console.log("Пользователь уже голосовал за:", vote.player_name);
      showResults(eventId, vote.player_name);
    } else {
      console.log("Пользователь еще не голосовал.");
      renderVotingForm(eventId);
    }
  }

  function renderVotingForm(eventId) {
    let html = '<div class="card"><h3>Кто лучший игрок матча?</h3>';
    players.forEach(p => {
      html += `
        <div class="player-row" onclick="castVote('${eventId}', '${p}')">
          <div class="player-info"><span>${p}</span></div>
          <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: 0%"></div></div>
        </div>`;
    });
    html += '</div>';
    document.getElementById('main-content').innerHTML = html;
  }

  async function castVote(eventId, playerName) {
    const { error } = await supabase
      .from('motm_votes')
      .insert({ 
        event_id: eventId, 
        user_id: userId, 
        player_name: playerName 
      });

    if (error) {
      alert("Ошибка при сохранении голоса: " + error.message);
    } else {
      // Пытаемся начислить баллы (если функция создана)
      try {
        await supabase.rpc('increment_points', { user_id: userId, amount: 5 });
      } catch(e) { console.log("Баллы не начислены: функция не найдена"); }
      
      showResults(eventId, playerName);
    }
  }

  async function showResults(eventId, userChoice = null) {
    const { data: votes } = await supabase
      .from('motm_votes')
      .select('player_name')
      .eq('event_id', eventId);

    const total = votes ? votes.length : 0;
    const stats = {};
    if (votes) {
      votes.forEach(v => stats[v.player_name] = (stats[v.player_name] || 0) + 1);
    }

    let html = '<div class="card"><h3>Текущие результаты</h3>';
    
    // Сортируем игроков по количеству голосов
    const sortedPlayers = [...players].sort((a,b) => (stats[b]||0) - (stats[a]||0));

    sortedPlayers.forEach(p => {
      const count = stats[p] || 0;
      const percent = total > 0 ? Math.round((count / total) * 100) : 0;
      const isSelected = p === userChoice;

      html += `
        <div class="player-row ${isSelected ? 'selected' : ''}">
          <div class="player-info">
            <span>${p} ${isSelected ? '⭐' : ''}</span>
            <span>${percent}% (${count})</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" style="width: ${percent}%"></div>
          </div>
        </div>`;
    });
    html += `<p style="text-align:center; margin-top:15px; font-size:12px; opacity:0.6;">Всего голосов: ${total}</p></div>`;
    document.getElementById('main-content').innerHTML = html;
  }

  init();
