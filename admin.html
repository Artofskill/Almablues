<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel ‚Äî Chelsea FC KZ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-dark: #001028;
      --chelsea-blue: #034694;
      --chelsea-blue-dark: #002366;
      --gold: #D4A017;
      --gold-hover: #E8B923;
      --text-light: #e0e0e0;
      --white: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      padding: 15px;
      font-size: 16px;
      line-height: 1.5;
    }

    h1, h2 {
      font-family: 'Oswald', sans-serif;
      color: var(--gold);
      text-align: center;
      word-break: break-word;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }

    h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    .login-form, .admin-content {
      max-width: 100%;
      margin: 20px auto;
      padding: 0 10px;
    }

    input, textarea, button, select {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #444;
      background: #112;
      color: white;
      font-size: 16px; /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —á—Ç–æ–±—ã –Ω–µ –∑—É–º–∏–ª–æ—Å—å */
      -webkit-appearance: none;
      appearance: none;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    button {
      background: var(--gold);
      color: var(--bg-dark);
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      padding: 16px;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    button:hover {
      background: var(--gold-hover);
    }

    .section {
      margin: 30px 0;
      padding: 20px;
      background: rgba(3,70,148,0.15);
      border-radius: 12px;
      border: 1px solid rgba(3,70,148,0.3);
      word-break: break-word;
    }

    .event-list, .pending-list, .registrations-list {
      margin-top: 15px;
    }

    .event-item, .pending-item, .registration-item {
      background: #0a1a3a;
      padding: 15px;
      margin: 12px 0;
      border-radius: 8px;
      border-left: 4px solid #034694;
      word-break: break-word;
    }

    .pending-item {
      border-left-color: #FFC107;
    }

    .approved-item {
      border-left-color: #4CAF50;
    }

    .event-item.past {
      border-left-color: #666;
      opacity: 0.8;
    }

    .event-item.current {
      border-left-color: #FF9800;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { border-left-color: #FF9800; }
      50% { border-left-color: #FFC107; }
      100% { border-left-color: #FF9800; }
    }

    .hidden {
      display: none !important;
    }

    #status, #login-status {
      text-align: center;
      margin: 15px 0;
      font-size: 1rem;
      padding: 0 10px;
    }

    #login-status {
      color: #ff6666;
    }

    .user-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .user-info div {
      background: rgba(255,255,255,0.05);
      padding: 10px;
      border-radius: 5px;
      overflow: hidden;
    }

    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .action-buttons button {
      flex: 1;
      padding: 10px 12px;
      min-width: 120px;
      font-size: 0.9rem;
      margin: 0;
    }

    .btn-approve {
      background: #4CAF50;
      color: white;
    }

    .btn-reject {
      background: #f44336;
      color: white;
    }

    .btn-checkin {
      background: #2196F3;
      color: white;
    }

    .btn-cancel {
      background: #FF9800;
      color: white;
    }

    .btn-delete {
      background: #9C27B0;
      color: white;
    }

    .btn-delete-event {
      background: #f44336;
      color: white;
      margin-top: 10px;
      padding: 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: rgba(3,70,148,0.2);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      min-width: 0;
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--gold);
      line-height: 1;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #aaa;
      line-height: 1.2;
    }

    .registration-details {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (min-width: 768px) {
      .registration-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 8px;
      white-space: nowrap;
    }

    .status-registered {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
      border: 1px solid #2196F3;
    }

    .status-cancelled {
      background: rgba(244, 67, 54, 0.2);
      color: #F44336;
      border: 1px solid #F44336;
    }

    .status-checked_in {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      border: 1px solid #4CAF50;
    }

    .filters {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    @media (min-width: 640px) {
      .filters {
        flex-direction: row;
      }
      
      .filters input,
      .filters select {
        flex: 1;
        min-width: 0;
      }
    }

    .qr-scanner-section {
      text-align: center;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      margin-top: 20px;
    }

    #qr-video {
      width: 100%;
      max-width: 300px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .event-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .event-tab {
      padding: 12px 20px;
      white-space: nowrap;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      flex-shrink: 0;
    }

    .event-tab.active {
      border-bottom-color: var(--gold);
      color: var(--gold);
    }

    .event-tab-content {
      display: none;
    }

    .event-tab-content.active {
      display: block;
    }

    .event-time-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      margin-left: 8px;
      vertical-align: middle;
    }

    .badge-future {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      border: 1px solid #4CAF50;
    }

    .badge-current {
      background: rgba(255, 152, 0, 0.2);
      color: #FF9800;
      border: 1px solid #FF9800;
    }

    .badge-past {
      background: rgba(158, 158, 158, 0.2);
      color: #9E9E9E;
      border: 1px solid #9E9E9E;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #aaa;
      font-size: 1rem;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
    @media (max-width: 480px) {
      body {
        padding: 10px;
        font-size: 14px;
      }
      
      h1 {
        font-size: 1.6rem;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      .section {
        padding: 15px;
        margin: 20px 0;
      }
      
      .stat-card {
        padding: 12px;
      }
      
      .stat-number {
        font-size: 1.5rem;
      }
      
      .action-buttons button {
        min-width: 100%;
        margin-bottom: 5px;
      }
      
      button {
        padding: 14px;
        font-size: 0.95rem;
      }
      
      input, textarea, select {
        padding: 12px;
        font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
      }
      
      .event-tab {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
    }

    /* –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
    @media (min-width: 1200px) {
      .container {
        max-width: 1100px;
      }
      
      .admin-content {
        max-width: 1100px;
      }
    }

    /* –£–ª—É—á—à–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--chelsea-blue);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--chelsea-blue-dark);
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Admin Panel ‚Ä¢ Chelsea FC KZ</h1>

    <div id="login-section" class="login-form">
      <h2>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
      <input type="text" id="admin-login" placeholder="–õ–æ–≥–∏–Ω" value="Admin">
      <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="login-button">–í–æ–π—Ç–∏</button>
      <div id="login-status"></div>
    </div>

    <div id="admin-content" class="hidden">
      <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="stats" id="stats-section">
        <div class="stat-card">
          <div class="stat-number" id="total-users">0</div>
          <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-events">0</div>
          <div class="stat-label">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-registrations">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="active-registrations">0</div>
          <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="checked-in-count">0</div>
          <div class="stat-label">–û—Ç–º–µ—Ç–∏–≤—à–∏—Ö—Å—è</div>
        </div>
      </div>

      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
      <div class="section">
        <h2>–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h2>
        <input type="text" id="match_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞ (Chelsea vs Arsenal)">
        <input type="datetime-local" id="match_date">
        <input type="text" id="bar_address" placeholder="–ê–¥—Ä–µ—Å –±–∞—Ä–∞">
        <textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" rows="3"></textarea>
        <input type="number" id="max_participants" placeholder="–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        <label style="display:block; margin:10px 0;">
          <input type="checkbox" id="is_open" checked> –û—Ç–∫—Ä—ã—Ç–∞ –∑–∞–ø–∏—Å—å
        </label>
        <button id="create-event-button">–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
      <div class="section">
        <h2>üé´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
        
        <div class="filters">
          <input type="text" id="search-registration" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é">
          <select id="filter-event">
            <option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>
          </select>
          <select id="filter-status">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="registered">–ó–∞–ø–∏—Å–∞–Ω</option>
            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
            <option value="checked_in">–û—Ç–º–µ—Ç–∏–ªc—è</option>
          </select>
        </div>
        
        <div id="registrations-list" class="registrations-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button id="refresh-registrations" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π</button>
        
        <!-- QR —Å–∫–∞–Ω–µ—Ä -->
        <div class="qr-scanner-section">
          <h3>üì± QR –∫–æ–¥ —Å–∫–∞–Ω–µ—Ä</h3>
          <video id="qr-video" style="display: none;"></video>
          <button id="start-scanner" class="btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä QR</button>
          <button id="stop-scanner" class="btn" style="background: #f44336; display: none;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
          <div id="scanner-result" style="margin-top: 15px;"></div>
        </div>
      </div>

      <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
      <div class="section">
        <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h2>
        
        <!-- –¢–∞–±—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
        <div class="event-tabs">
          <div class="event-tab active" onclick="switchEventTab('upcoming')">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</div>
          <div class="event-tab" onclick="switchEventTab('current')">–¢–µ–∫—É—â–∏–µ</div>
          <div class="event-tab" onclick="switchEventTab('past')">–ü—Ä–æ—à–µ–¥—à–∏–µ</div>
          <div class="event-tab" onclick="switchEventTab('all')">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        </div>
        
        <div id="upcoming-events" class="event-tab-content active">
          <div id="upcoming-events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
        </div>
        
        <div id="current-events" class="event-tab-content">
          <div id="current-events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
        </div>
        
        <div id="past-events" class="event-tab-content">
          <div id="past-events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
        </div>
        
        <div id="all-events" class="event-tab-content">
          <div id="all-events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
        </div>
        
        <button id="refresh-events" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
      </div>

      <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ Membership -->
      <div class="section">
        <h2>üìã –ó–∞—è–≤–∫–∏ –Ω–∞ Membership</h2>
        <div id="pending-list" class="pending-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button id="refresh-pending" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>

      <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
      <div class="section">
        <h2>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <div style="margin-bottom: 15px;">
          <input type="text" id="search-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username" onkeyup="searchUsers()">
        </div>
        <div id="all-users-list" class="pending-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button id="refresh-users" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
      <div class="section">
        <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h2>
        <input type="text" id="user-id-input" placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <input type="number" id="add-points" placeholder="–î–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏">
          <input type="number" id="remove-points" placeholder="–£–±—Ä–∞—Ç—å –æ—á–∫–∏">
        </div>
        <select id="user-status-select">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
          <option value="New">New - –ù–æ–≤—ã–π</option>
          <option value="pending">pending - –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
          <option value="approved">approved - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
          <option value="rejected">rejected - –û—Ç–∫–ª–æ–Ω–µ–Ω</option>
        </select>
        <button id="update-user-btn" class="btn">–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
      </div>

      <button id="logout-button" style="background:#c00; margin-top:40px; width:100%;">–í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</button>
    </div>
  </div>
<script>
    // === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
    const supabaseUrl = 'https://zuapiixwzkleygaijulx.supabase.co';
    const supabaseKey = 'sb_publishable_Jsth-2GViNz5Ev3UWtrWTg_fbg4GAKx';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const ADMIN_LOGIN = 'Admin';
    const ADMIN_PASS = '44mnUr8Xz';
    const TIMEZONE_OFFSET = 5 * 60 * 60 * 1000; // UTC+5 –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞

    // === –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å UTC+5 ===
    function getCurrentTimeUTC5() {
      const now = new Date();
      return new Date(now.getTime() + TIMEZONE_OFFSET);
    }
    
    function convertToUTC5(dateString) {
      const date = new Date(dateString);
      return new Date(date.getTime() + TIMEZONE_OFFSET);
    }
    
    function formatDateTimeUTC5(dateString) {
      const date = convertToUTC5(dateString);
      return date.toLocaleString('ru-RU', {
        weekday: 'short',
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    function getEventStatus(eventTime) {
      const now = getCurrentTimeUTC5();
      const eventTimeUTC5 = convertToUTC5(eventTime);
      const diff = eventTimeUTC5 - now;
      const twoHours = 2 * 60 * 60 * 1000;
      const threeHours = 3 * 60 * 60 * 1000;
      
      if (diff > twoHours) {
        return 'future'; // –ë–æ–ª–µ–µ —á–µ–º —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞
      } else if (diff > 0) {
        return 'current'; // –í –±–ª–∏–∂–∞–π—à–∏–µ 2 —á–∞—Å–∞
      } else if (diff > -threeHours) {
        return 'current'; // –í —Ç–µ—á–µ–Ω–∏–µ 3 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞
      } else {
        return 'past'; // –ë–æ–ª–µ–µ 3 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
      }
    }
    
    function getEventStatusBadge(eventTime) {
      const status = getEventStatus(eventTime);
      const badges = {
        'future': { class: 'badge-future', text: '–ü—Ä–µ–¥—Å—Ç–æ—è—â–µ–µ' },
        'current': { class: 'badge-current', text: '–°–µ–π—á–∞—Å' },
        'past': { class: 'badge-past', text: '–ü—Ä–æ—à–µ–¥—à–µ–µ' }
      };
      return badges[status] || { class: '', text: '' };
    }

    // === –ü–æ–º–æ–≥–∞—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
    function showMsg(id, text, isError = false) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = text;
        el.style.color = isError ? '#ff6666' : '#88ff88';
      }
    }

    // === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ===
    function tryLogin() {
      const login = document.getElementById('admin-login')?.value?.trim();
      const pass = document.getElementById('admin-pass')?.value?.trim();

      if (!login || !pass) {
        showMsg('login-status', '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', true);
        return;
      }

      if (login === ADMIN_LOGIN && pass === ADMIN_PASS) {
        localStorage.setItem('adminLoggedIn', 'true');
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        showMsg('status', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å');
        loadStats();
        loadAllEvents();
        loadPending();
        loadAllUsers();
        loadRegistrations();
        loadEventsForFilter();
      } else {
        showMsg('login-status', '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', true);
      }
    }

    function logout() {
      localStorage.removeItem('adminLoggedIn');
      location.reload();
    }

    // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π ===
    function switchEventTab(tabName) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–∞–±—ã
      document.querySelectorAll('.event-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.event-tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[onclick="switchEventTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-events`).classList.add('active');
    }

    // === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===
    async function loadStats() {
      try {
        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const { count: totalUsers } = await supabaseClient
          .from('users')
          .select('*', { count: 'exact', head: true });
        
        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
        const { count: totalEvents } = await supabaseClient
          .from('events')
          .select('*', { count: 'exact', head: true });
        
        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        const { count: totalRegistrations } = await supabaseClient
          .from('registrations')
          .select('*', { count: 'exact', head: true });
        
        // –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –Ω–∞ –±—É–¥—É—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
        const { count: activeRegistrations } = await supabaseClient
          .from('registrations')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'registered');
        
        // –û—Ç–º–µ—Ç–∏–≤—à–∏–µ—Å—è
        const { count: checkedInCount } = await supabaseClient
          .from('registrations')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'checked_in');
        
        document.getElementById('total-users').textContent = totalUsers || 0;
        document.getElementById('total-events').textContent = totalEvents || 0;
        document.getElementById('total-registrations').textContent = totalRegistrations || 0;
        document.getElementById('active-registrations').textContent = activeRegistrations || 0;
        document.getElementById('checked-in-count').textContent = checkedInCount || 0;
        
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ ===
    async function loadEventsForFilter() {
      try {
        const { data, error } = await supabaseClient
          .from('events')
          .select('id, match_name, match_date')
          .order('match_date', { ascending: false });

        if (error) return;

        const filterSelect = document.getElementById('filter-event');
        filterSelect.innerHTML = '<option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>';
        
        data.forEach(event => {
          const eventDate = new Date(event.match_date);
          const formattedDate = eventDate.toLocaleDateString('ru-RU');
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = `${event.match_name} (${formattedDate})`;
          filterSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading events for filter:', error);
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–µ–π ===
    async function loadAllEvents() {
      try {
        const { data: events, error } = await supabaseClient
          .from('events')
          .select('*')
          .order('match_date', { ascending: false });

        if (error) {
          console.error('Error loading events:', error);
          showEmptyState('upcoming-events-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyState('current-events-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyState('past-events-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyState('all-events-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          return;
        }
        
        if (!events || events.length === 0) {
          showEmptyState('upcoming-events-list', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyState('current-events-list', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyState('past-events-list', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyState('all-events-list', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          return;
        }

        const now = getCurrentTimeUTC5();
        const upcoming = [];
        const current = [];
        const past = [];
        
        for (const event of events) {
          const eventTimeUTC5 = convertToUTC5(event.match_date);
          const status = getEventStatus(event.match_date);
          
          // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
          const { count: registeredCount } = await supabaseClient
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .eq('event_id', event.id)
            .eq('status', 'registered');
          
          event.registeredCount = registeredCount || 0;
          
          if (status === 'future') {
            upcoming.push(event);
          } else if (status === 'current') {
            current.push(event);
          } else {
            past.push(event);
          }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        renderEvents('upcoming-events-list', upcoming, 'future');
        renderEvents('current-events-list', current, 'current');
        renderEvents('past-events-list', past, 'past');
        renderEvents('all-events-list', events, 'all');
        
      } catch (error) {
        console.error('Unexpected error loading events:', error);
      }
    }
    
    function showEmptyState(containerId, message) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <p>${message}</p>
        </div>
      `;
    }
    
    function renderEvents(containerId, events, category) {
      const container = document.getElementById(containerId);
      
      if (!events || events.length === 0) {
        const messages = {
          'future': '–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'current': '–ù–µ—Ç —Ç–µ–∫—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'past': '–ù–µ—Ç –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'all': '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç'
        };
        showEmptyState(containerId, messages[category] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
        return;
      }
      
      let html = '';
      
      events.forEach(event => {
        const eventTimeUTC5 = convertToUTC5(event.match_date);
        const formattedDate = formatDateTimeUTC5(event.match_date);
        const statusBadge = getEventStatusBadge(event.match_date);
        const isFull = event.max_participants && event.registeredCount >= event.max_participants;
        
        const itemClass = category === 'past' ? 'event-item past' : 
                         category === 'current' ? 'event-item current' : 'event-item';
        
        html += `
          <div class="${itemClass}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 0;">
                <strong style="font-size: 1.1rem; display: block; margin-bottom: 5px;">${event.match_name}</strong>
                <div style="color: #aaa; font-size: 0.9rem;">
                  üìÖ ${formattedDate} (UTC+5)<br>
                  üìç ${event.bar_address}
                </div>
              </div>
              <div style="text-align: right;">
                <span class="event-time-badge ${statusBadge.class}">${statusBadge.text}</span>
              </div>
            </div>
            
            <div style="margin-bottom: 10px; font-size: 0.9rem;">
              <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div>
                  <span style="color: #FFC107;">üë• ${event.registeredCount}${event.max_participants ? `/${event.max_participants}` : ''} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                  ${isFull ? '<span style="color: #f44336; margin-left: 10px;">(–ú–µ—Å—Ç –Ω–µ—Ç)</span>' : ''}
                </div>
                <div>
                  <span style="color: ${event.is_open ? '#4CAF50' : '#f44336'}">
                    ${event.is_open ? '‚úÖ –û—Ç–∫—Ä—ã—Ç–∞ –∑–∞–ø–∏—Å—å' : '‚ùå –ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞'}
                  </span>
                </div>
              </div>
              ${event.description ? `<div style="margin-top: 8px; color: #aaa; font-size: 0.85rem;">üìù ${event.description}</div>` : ''}
            </div>
            
            <div class="action-buttons">
              <button class="btn-delete-event" onclick="deleteEvent('${event.id}', '${event.match_name.replace(/'/g, "\\'")}')">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // === –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ===
    async function deleteEvent(eventId, eventName) {
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏!`)) {
        return;
      }
      
      try {
        // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
        const { error: registrationsError } = await supabaseClient
          .from('registrations')
          .delete()
          .eq('event_id', eventId);
        
        if (registrationsError) {
          console.error('Error deleting registrations:', registrationsError);
          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ —Å –∑–∞–ø–∏—Å—è–º–∏
        }
        
        // –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º —Å–∞–º–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
        const { error } = await supabaseClient
          .from('events')
          .delete()
          .eq('id', eventId);
        
        if (error) throw error;
        
        alert(`‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏
        loadStats();
        loadAllEvents();
        loadRegistrations();
        loadEventsForFilter();
        
      } catch (error) {
        console.error('Error deleting event:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ' + error.message);
      }
    }

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ===
    async function loadRegistrations() {
      try {
        let query = supabaseClient
          .from('registrations')
          .select(`
            id,
            status,
            checkin_time,
            created_at,
            users (
              id,
              full_name,
              username,
              telegram_id
            ),
            events (
              id,
              match_name,
              match_date,
              bar_address
            )
          `)
          .order('created_at', { ascending: false });

        const searchTerm = document.getElementById('search-registration').value.toLowerCase();
        const eventFilter = document.getElementById('filter-event').value;
        const statusFilter = document.getElementById('filter-status').value;

        if (eventFilter) {
          query = query.eq('event_id', eventFilter);
        }

        if (statusFilter) {
          query = query.eq('status', statusFilter);
        }

        const { data, error } = await query;

        const container = document.getElementById('registrations-list');
        
        if (error) {
          container.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
          return;
        }
        
        if (!data?.length) {
          container.innerHTML = '<p>–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
          return;
        }

        let filteredData = data;
        if (searchTerm) {
          filteredData = data.filter(reg => 
            reg.users?.full_name?.toLowerCase().includes(searchTerm) ||
            reg.users?.username?.toLowerCase().includes(searchTerm) ||
            reg.events?.match_name?.toLowerCase().includes(searchTerm)
          );
        }

        if (!filteredData.length) {
          container.innerHTML = '<p>–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –∑–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
          return;
        }

        renderRegistrations(filteredData);
        
      } catch (error) {
        console.error('Error loading registrations:', error);
        document.getElementById('registrations-list').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
      }
    }

    function renderRegistrations(registrations) {
      const container = document.getElementById('registrations-list');
      container.innerHTML = '';
      
      registrations.forEach(reg => {
        const user = reg.users;
        const event = reg.events;
        
        if (!user || !event) return;
        
        const eventDate = new Date(event.match_date);
        const formattedDate = eventDate.toLocaleDateString('ru-RU', {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const statusText = reg.status === 'registered' ? '–ó–∞–ø–∏—Å–∞–Ω' : 
                          reg.status === 'cancelled' ? '–û—Ç–º–µ–Ω–µ–Ω' : 
                          reg.status === 'checked_in' ? '–û—Ç–º–µ—Ç–∏–ªc—è' : reg.status;
        
        const statusClass = reg.status === 'registered' ? 'status-registered' :
                           reg.status === 'cancelled' ? 'status-cancelled' :
                           'status-checked_in';
        
        const now = new Date();
        const isEventPast = eventDate < now;
        
        const registrationItem = document.createElement('div');
        registrationItem.className = 'registration-item';
        
        registrationItem.innerHTML = `
          <div class="registration-details">
            <div>
              <strong>üë§ ${user.full_name || '–ê–Ω–æ–Ω–∏–º'}</strong><br>
              <small>Telegram: @${user.username || '–Ω–µ—Ç'} (ID: ${user.telegram_id})</small><br>
              <small>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${user.id.substring(0, 8)}...</small>
            </div>
            <div>
              <strong>üé´ ${event.match_name}</strong><br>
              <small>üìÖ ${formattedDate}</small><br>
              <small>üìç ${event.bar_address}</small>
            </div>
          </div>
          
          <div style="margin-bottom: 10px;">
            <span class="status-badge ${statusClass}">${statusText}</span>
            <small style="color: #aaa; display: block; margin-top: 5px;">
              –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞: ${new Date(reg.created_at).toLocaleDateString('ru-RU')}
              ${reg.checkin_time ? `‚Ä¢ –û—Ç–º–µ—Ç–∫–∞: ${new Date(reg.checkin_time).toLocaleString('ru-RU')}` : ''}
            </small>
          </div>
          
          <div class="action-buttons">
            ${reg.status === 'registered' && !isEventPast ? `
              <button class="btn-checkin" onclick="checkInUser('${reg.id}', '${user.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}', '${event.match_name}')">
                ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ
              </button>
            ` : ''}
            
            ${reg.status === 'registered' ? `
              <button class="btn-cancel" onclick="cancelRegistration('${reg.id}', '${user.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}', '${event.match_name}')">
                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
              </button>
            ` : ''}
            
            ${reg.status === 'cancelled' && !isEventPast ? `
              <button class="btn-approve" onclick="reRegisterUser('${reg.id}', '${user.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}', '${event.match_name}')">
                ‚Üª –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
              </button>
            ` : ''}
            
            <button class="btn-delete" onclick="deleteRegistration('${reg.id}', '${user.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}', '${event.match_name}')">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
            </button>
          </div>
        `;
        
        container.appendChild(registrationItem);
      });
    }

    // === –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ ===
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    async function createEvent() {
      const name = document.getElementById('match_name')?.value?.trim();
      const date = document.getElementById('match_date')?.value;
      const addr = document.getElementById('bar_address')?.value?.trim();
      const desc = document.getElementById('description')?.value?.trim() || null;
      const max = parseInt(document.getElementById('max_participants')?.value) || null;
      const open = document.getElementById('is_open')?.checked ?? true;

      if (!name || !date || !addr) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç–∞ –∏ –∞–¥—Ä–µ—Å');
        return;
      }

      const { error } = await supabaseClient.from('events').insert({
        match_name: name,
        match_date: new Date(date).toISOString(),
        bar_address: addr,
        description: desc,
        max_participants: max,
        is_open: open
      });

      if (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      } else {
        alert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!');
        document.getElementById('match_name').value = '';
        document.getElementById('match_date').value = '';
        document.getElementById('bar_address').value = '';
        document.getElementById('description').value = '';
        document.getElementById('max_participants').value = '';
        
        loadAllEvents();
        loadStats();
        loadEventsForFilter();
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ Membership
    async function loadPending() {
      try {
        const { data, error } = await supabaseClient
          .from('users')
          .select('id, full_name, username, email, created_at, points, telegram_id')
          .eq('membership_status', 'pending')
          .order('created_at', { ascending: true });

        const cont = document.getElementById('pending-list');
        
        if (error) {
          cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>';
          return;
        }
        
        if (!data?.length) {
          cont.innerHTML = '<p>–ó–∞—è–≤–æ–∫ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ –Ω–µ—Ç</p>';
          return;
        }

        cont.innerHTML = '';
        
        data.forEach(user => {
          const d = document.createElement('div');
          d.className = 'pending-item';
          d.innerHTML = `
            <div class="user-info">
              <div>
                <strong>üë§ ${user.full_name}</strong><br>
                <small>Telegram: @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small><br>
                <small>ID: ${user.id.substring(0, 8)}...</small>
              </div>
              <div>
                <small>üìß ${user.email || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small><br>
                <small>üìÖ ${new Date(user.created_at).toLocaleDateString('ru-RU')}</small><br>
                <small>‚≠ê –û—á–∫–æ–≤: ${user.points || 0}</small>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn-approve" onclick="approveApplication('${user.id}')">
                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å (+100 –æ—á–∫–æ–≤)
              </button>
              <button class="btn-reject" onclick="rejectApplication('${user.id}')">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
              </button>
            </div>
          `;
          cont.appendChild(d);
        });
      } catch (error) {
        console.error('Error loading pending applications:', error);
        document.getElementById('pending-list').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    async function loadAllUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('users')
          .select('id, full_name, username, email, points, membership_status, created_at')
          .order('created_at', { ascending: false });

        const cont = document.getElementById('all-users-list');
        
        if (error) {
          cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
          return;
        }
        
        if (!data?.length) {
          cont.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</p>';
          return;
        }

        window.allUsers = data;
        renderUsers(data);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('all-users-list').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function renderUsers(users) {
      const cont = document.getElementById('all-users-list');
      cont.innerHTML = '';
      
      users.forEach(user => {
        const statusColor = {
          'New': '#2196F3',
          'pending': '#FFC107',
          'approved': '#4CAF50',
          'rejected': '#F44336'
        }[user.membership_status] || '#9E9E9E';
        
        const d = document.createElement('div');
        d.className = 'event-item';
        d.style.borderLeftColor = statusColor;
        d.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <strong>${user.full_name}</strong><br>
              <small>@${user.username || '–Ω–µ—Ç'}</small><br>
              <small>${user.email || '–Ω–µ—Ç email'}</small>
            </div>
            <div style="text-align: right;">
              <span style="background: ${statusColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                ${user.membership_status}
              </span><br>
              <strong>‚≠ê ${user.points || 0}</strong>
            </div>
          </div>
          <div style="margin-top: 10px; font-size: 0.8rem; color: #aaa;">
            ID: ${user.id.substring(0, 8)}... ‚Ä¢ –†–µ–≥: ${new Date(user.created_at).toLocaleDateString('ru-RU')}
          </div>
        `;
        cont.appendChild(d);
      });
    }

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function searchUsers() {
      const searchTerm = document.getElementById('search-user').value.toLowerCase();
      if (!window.allUsers) return;
      
      const filtered = window.allUsers.filter(user => 
        user.full_name?.toLowerCase().includes(searchTerm) ||
        user.username?.toLowerCase().includes(searchTerm) ||
        user.email?.toLowerCase().includes(searchTerm) ||
        user.id?.toLowerCase().includes(searchTerm)
      );
      
      renderUsers(filtered);
    }

    // –û–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
    async function approveApplication(userId) {
      if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å 100 –±–æ–Ω—É—Å–Ω—ã—Ö –æ—á–∫–æ–≤?')) return;
      
      try {
        const { data: userData, error: fetchError } = await supabaseClient
          .from('users')
          .select('points')
          .eq('id', userId)
          .single();

        if (fetchError) throw fetchError;
        
        const currentPoints = userData.points || 0;
        const newPoints = currentPoints + 100;
        
        const { error: updateError } = await supabaseClient
          .from('users')
          .update({ 
            membership_status: 'approved',
            points: newPoints,
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (updateError) throw updateError;
        
        alert('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∞! +100 –æ—á–∫–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω—ã.');
        
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      }
    }

    // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
    async function rejectApplication(userId) {
      if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('users')
          .update({ 
            membership_status: 'rejected',
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (error) throw error;
        
        alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.');
        
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function updateUser() {
      const telegramIdInput = document.getElementById('user-id-input').value.trim();
      const addPoints = parseInt(document.getElementById('add-points').value) || 0;
      const removePoints = parseInt(document.getElementById('remove-points').value) || 0;
      const newStatus = document.getElementById('user-status-select').value;
      
      if (!telegramIdInput) {
        alert('–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      if (!addPoints && !removePoints && !newStatus) {
        alert('–£–∫–∞–∂–∏—Ç–µ —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å: –æ—á–∫–∏ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å');
        return;
      }
      
      try {
        const { data: userData, error: fetchError } = await supabaseClient
          .from('users')
          .select('id, points')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        if (fetchError) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + fetchError.message);
          return;
        }
        
        if (!userData) {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        const updates = {};
        const currentPoints = userData.points || 0;
        
        if (addPoints > 0 || removePoints > 0) {
          updates.points = currentPoints + addPoints - removePoints;
          if (updates.points < 0) updates.points = 0;
        }
        
        if (newStatus) {
          updates.membership_status = newStatus;
        }
        
        updates.updated_at = new Date().toISOString();
        
        const { error } = await supabaseClient
          .from('users')
          .update(updates)
          .eq('id', userData.id);
        
        if (error) throw error;
        
        alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
        
        document.getElementById('user-id-input').value = '';
        document.getElementById('add-points').value = '';
        document.getElementById('remove-points').value = '';
        document.getElementById('user-status-select').value = '';
        
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–ø–∏—Å—è–º–∏
    async function checkInUser(registrationId, userName, eventName) {
      if (!confirm(`–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –∫–∞–∫ –ø–æ—Å–µ—Ç–∏–≤—à–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"?`)) {
        return;
      }
      
      try {
        const { error: updateError } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'checked_in',
            checkin_time: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .eq('id', registrationId);

        if (updateError) throw updateError;

        const { data: registrationData } = await supabaseClient
          .from('registrations')
          .select('user_id')
          .eq('id', registrationId)
          .single();

        if (registrationData) {
          await supabaseClient
            .from('users')
            .update({
              points: supabaseClient.sql`points + 50`,
              updated_at: new Date().toISOString()
            })
            .eq('id', registrationData.user_id);
        }

        alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø–æ—Å–µ—Ç–∏–≤—à–∏–π –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ! +50 –æ—á–∫–æ–≤`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error checking in user:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å–µ—â–µ–Ω–∏—è: ' + error.message);
      }
    }

    async function cancelRegistration(registrationId, userName, eventName) {
      if (!confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"?`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'cancelled',
            updated_at: new Date().toISOString()
          })
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –æ—Ç–º–µ–Ω–µ–Ω–∞`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error cancelling registration:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    async function reRegisterUser(registrationId, userName, eventName) {
      if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"?`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'registered',
            checkin_time: null,
            updated_at: new Date().toISOString()
          })
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error re-registering user:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    async function deleteRegistration(registrationId, userName, eventName) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .delete()
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" —É–¥–∞–ª–µ–Ω–∞`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error deleting registration:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    document.addEventListener('DOMContentLoaded', () => {
      // –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞
      document.getElementById('login-button')?.addEventListener('click', tryLogin);

      // –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∞–¥–º–∏–Ω–∫–∏
      document.getElementById('create-event-button')?.addEventListener('click', createEvent);
      document.getElementById('refresh-pending')?.addEventListener('click', loadPending);
      document.getElementById('refresh-events')?.addEventListener('click', loadAllEvents);
      document.getElementById('refresh-users')?.addEventListener('click', loadAllUsers);
      document.getElementById('refresh-registrations')?.addEventListener('click', loadRegistrations);
      document.getElementById('update-user-btn')?.addEventListener('click', updateUser);
      document.getElementById('logout-button')?.addEventListener('click', logout);
      
      // –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∑–∞–ø–∏—Å–µ–π
      document.getElementById('search-registration')?.addEventListener('input', loadRegistrations);
      document.getElementById('filter-event')?.addEventListener('change', loadRegistrations);
      document.getElementById('filter-status')?.addEventListener('change', loadRegistrations);

      // –ê–≤—Ç–æ–≤—Ö–æ–¥ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–µ—Å—Å–∏–∏
      if (localStorage.getItem('adminLoggedIn') === 'true') {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        showMsg('status', '‚úÖ –ê–≤—Ç–æ–≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
        loadStats();
        loadAllEvents();
        loadPending();
        loadAllUsers();
        loadRegistrations();
        loadEventsForFilter();
      }
    });
  </script>

</body>
</html>
