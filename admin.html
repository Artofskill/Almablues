<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel ‚Äî Chelsea FC KZ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #001028;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    h1, h2 {
      font-family: 'Oswald', sans-serif;
      color: #D4A017;
      text-align: center;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .login-form, .admin-content { max-width: 500px; margin: 40px auto; }
    input, textarea, button, select {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #444;
      background: #112;
      color: white;
      font-size: 1.1rem;
    }
    button {
      background: #D4A017;
      color: #001028;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #E8B923; }
    .section { 
      margin: 40px 0; 
      padding: 25px; 
      background: rgba(3,70,148,0.15); 
      border-radius: 12px; 
      border: 1px solid rgba(3,70,148,0.3);
    }
    .event-list, .pending-list, .registrations-list { margin-top: 20px; }
    .event-item, .pending-item, .registration-item { 
      background: #0a1a3a; 
      padding: 15px; 
      margin: 12px 0; 
      border-radius: 8px;
      border-left: 4px solid #034694;
    }
    .pending-item { border-left-color: #FFC107; }
    .approved-item { border-left-color: #4CAF50; }
    .hidden { display: none !important; }
    #status, #login-status { 
      text-align: center; 
      margin: 20px 0; 
      font-size: 1.1rem; 
    }
    #login-status { color: #ff6666; }
    .user-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .user-info div {
      background: rgba(255,255,255,0.05);
      padding: 10px;
      border-radius: 5px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .action-buttons button {
      flex: 1;
      padding: 10px;
      min-width: 120px;
    }
    .btn-approve {
      background: #4CAF50;
      color: white;
    }
    .btn-reject {
      background: #f44336;
      color: white;
    }
    .btn-checkin {
      background: #2196F3;
      color: white;
    }
    .btn-cancel {
      background: #FF9800;
      color: white;
    }
    .btn-delete {
      background: #9C27B0;
      color: white;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(3,70,148,0.2);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #D4A017;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #aaa;
    }
    .registration-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .status-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .status-registered {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
      border: 1px solid #2196F3;
    }
    .status-cancelled {
      background: rgba(244, 67, 54, 0.2);
      color: #F44336;
      border: 1px solid #F44336;
    }
    .status-checked_in {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      border: 1px solid #4CAF50;
    }
    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .filters {
        grid-template-columns: 1fr;
      }
      .container {
        max-width: 100%;
        padding: 10px;
      }
    }
    .qr-scanner-section {
      text-align: center;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      margin-top: 20px;
    }
    #qr-video {
      width: 100%;
      max-width: 300px;
      border-radius: 8px;
      margin: 15px 0;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Admin Panel ‚Ä¢ Chelsea FC KZ</h1>

    <div id="login-section" class="login-form">
      <h2>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
      <input type="text" id="admin-login" placeholder="–õ–æ–≥–∏–Ω" value="Admin">
      <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="login-button">–í–æ–π—Ç–∏</button>
      <div id="login-status"></div>
    </div>

    <div id="admin-content" class="hidden">
      <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="stats" id="stats-section">
        <div class="stat-card">
          <div class="stat-number" id="total-users">0</div>
          <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-events">0</div>
          <div class="stat-label">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-registrations">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="active-registrations">0</div>
          <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="checked-in-count">0</div>
          <div class="stat-label">–û—Ç–º–µ—Ç–∏–≤—à–∏—Ö—Å—è</div>
        </div>
      </div>

      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
      <div class="section">
        <h2>–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h2>
        <input type="text" id="match_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞ (Chelsea vs Arsenal)">
        <input type="datetime-local" id="match_date">
        <input type="text" id="bar_address" placeholder="–ê–¥—Ä–µ—Å –±–∞—Ä–∞">
        <textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" rows="3"></textarea>
        <input type="number" id="max_participants" placeholder="–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        <label style="display:block; margin:10px 0;">
          <input type="checkbox" id="is_open" checked> –û—Ç–∫—Ä—ã—Ç–∞ –∑–∞–ø–∏—Å—å
        </label>
        <button id="create-event-button">–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
      <div class="section">
        <h2>üé´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
        
        <div class="filters">
          <input type="text" id="search-registration" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é">
          <select id="filter-event">
            <option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>
          </select>
          <select id="filter-status">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="registered">–ó–∞–ø–∏—Å–∞–Ω</option>
            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
            <option value="checked_in">–û—Ç–º–µ—Ç–∏–ªc—è</option>
          </select>
        </div>
        
        <div id="registrations-list" class="registrations-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button id="refresh-registrations" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π</button>
        
        <!-- QR —Å–∫–∞–Ω–µ—Ä -->
        <div class="qr-scanner-section">
          <h3>üì± QR –∫–æ–¥ —Å–∫–∞–Ω–µ—Ä</h3>
          <video id="qr-video" style="display: none;"></video>
          <button id="start-scanner" class="btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä QR</button>
          <button id="stop-scanner" class="btn" style="background: #f44336; display: none;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
          <div id="scanner-result" style="margin-top: 15px;"></div>
        </div>
      </div>

      <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ Membership -->
      <div class="section">
        <h2>üìã –ó–∞—è–≤–∫–∏ –Ω–∞ Membership</h2>
        <div id="pending-list" class="pending-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button id="refresh-pending" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>

      <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
      <div class="section">
        <h2>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <div style="margin-bottom: 15px;">
          <input type="text" id="search-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username" onkeyup="searchUsers()">
        </div>
        <div id="all-users-list" class="pending-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button id="refresh-users" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
      </div>

      <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
      <div class="section">
        <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h2>
        <div id="events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button id="refresh-events" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
      <div class="section">
        <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h2>
        <input type="text" id="user-id-input" placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <input type="number" id="add-points" placeholder="–î–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏">
          <input type="number" id="remove-points" placeholder="–£–±—Ä–∞—Ç—å –æ—á–∫–∏">
        </div>
        <select id="user-status-select">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
          <option value="New">New - –ù–æ–≤—ã–π</option>
          <option value="pending">pending - –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
          <option value="approved">approved - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
          <option value="rejected">rejected - –û—Ç–∫–ª–æ–Ω–µ–Ω</option>
        </select>
        <button id="update-user-btn" class="btn">–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
      </div>

      <button id="logout-button" style="background:#c00; margin-top:40px; width:100%;">–í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</button>
    </div>
  </div>

  <script>
    // =============================================
    //   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SUPABASE
    // =============================================
    const supabaseUrl  = 'https://zuapiixwzkleygaijulx.supabase.co';
    const supabaseKey  = 'sb_publishable_Jsth-2GViNz5Ev3UWtrWTg_fbg4GAKx';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const ADMIN_LOGIN = 'Admin';
    const ADMIN_PASS  = '44mnUr8Xz';

    // =============================================
    //   –ü–û–ú–û–ì–ê–Æ–©–ò–ï –§–£–ù–ö–¶–ò–ò
    // =============================================
    function showMsg(id, text, isError = false) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = text;
        el.style.color = isError ? '#ff6666' : '#88ff88';
      }
    }

    // =============================================
    //   –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
    // =============================================
    function tryLogin() {
      const login = document.getElementById('admin-login')?.value?.trim();
      const pass  = document.getElementById('admin-pass')?.value?.trim();

      if (!login || !pass) {
        showMsg('login-status', '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', true);
        return;
      }

      if (login === ADMIN_LOGIN && pass === ADMIN_PASS) {
        localStorage.setItem('adminLoggedIn', 'true');
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        showMsg('status', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å');
        loadStats();
        loadEvents();
        loadPending();
        loadAllUsers();
        loadRegistrations();
        loadEventsForFilter();
      } else {
        showMsg('login-status', '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', true);
      }
    }

    function logout() {
      localStorage.removeItem('adminLoggedIn');
      location.reload();
    }

    // =============================================
    //   –°–¢–ê–¢–ò–°–¢–ò–ö–ê
    // =============================================
    async function loadStats() {
      try {
        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const { count: totalUsers } = await supabaseClient
          .from('users')
          .select('*', { count: 'exact', head: true });
        
        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
        const { count: totalEvents } = await supabaseClient
          .from('events')
          .select('*', { count: 'exact', head: true });
        
        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        const { count: totalRegistrations } = await supabaseClient
          .from('registrations')
          .select('*', { count: 'exact', head: true });
        
        // –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –Ω–∞ –±—É–¥—É—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
        const { count: activeRegistrations } = await supabaseClient
          .from('registrations')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'registered');
        
        // –û—Ç–º–µ—Ç–∏–≤—à–∏–µ—Å—è
        const { count: checkedInCount } = await supabaseClient
          .from('registrations')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'checked_in');
        
        document.getElementById('total-users').textContent = totalUsers || 0;
        document.getElementById('total-events').textContent = totalEvents || 0;
        document.getElementById('total-registrations').textContent = totalRegistrations || 0;
        document.getElementById('active-registrations').textContent = activeRegistrations || 0;
        document.getElementById('checked-in-count').textContent = checkedInCount || 0;
        
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // =============================================
    //   –ó–ê–ì–†–£–ó–ö–ê –ú–ï–†–û–ü–†–ò–Ø–¢–ò–ô –î–õ–Ø –§–ò–õ–¨–¢–†–ê
    // =============================================
    async function loadEventsForFilter() {
      try {
        const { data, error } = await supabaseClient
          .from('events')
          .select('id, match_name, match_date')
          .order('match_date', { ascending: false });

        if (error) return;

        const filterSelect = document.getElementById('filter-event');
        filterSelect.innerHTML = '<option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>';
        
        data.forEach(event => {
          const eventDate = new Date(event.match_date);
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = `${event.match_name} (${eventDate.toLocaleDateString('ru-RU')})`;
          filterSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading events for filter:', error);
      }
    }

    // =============================================
    //   –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–Ø–ú–ò –ù–ê –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø
    // =============================================
    async function loadRegistrations() {
      try {
        let query = supabaseClient
          .from('registrations')
          .select(`
            id,
            status,
            checkin_time,
            created_at,
            users (
              id,
              full_name,
              username,
              telegram_id
            ),
            events (
              id,
              match_name,
              match_date,
              bar_address
            )
          `)
          .order('created_at', { ascending: false });

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        const searchTerm = document.getElementById('search-registration').value.toLowerCase();
        const eventFilter = document.getElementById('filter-event').value;
        const statusFilter = document.getElementById('filter-status').value;

        if (eventFilter) {
          query = query.eq('event_id', eventFilter);
        }

        if (statusFilter) {
          query = query.eq('status', statusFilter);
        }

        const { data, error } = await query;

        const container = document.getElementById('registrations-list');
        
        if (error) {
          container.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
          return;
        }
        
        if (!data?.length) {
          container.innerHTML = '<p>–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
          return;
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
        let filteredData = data;
        if (searchTerm) {
          filteredData = data.filter(reg => 
            reg.users?.full_name?.toLowerCase().includes(searchTerm) ||
            reg.users?.username?.toLowerCase().includes(searchTerm) ||
            reg.events?.match_name?.toLowerCase().includes(searchTerm)
          );
        }

        if (!filteredData.length) {
          container.innerHTML = '<p>–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –∑–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
          return;
        }

        renderRegistrations(filteredData);
        
      } catch (error) {
        console.error('Error loading registrations:', error);
        document.getElementById('registrations-list').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
      }
    }

    function renderRegistrations(registrations) {
      const container = document.getElementById('registrations-list');
      container.innerHTML = '';
      
      registrations.forEach(reg => {
        const user = reg.users;
        const event = reg.events;
        
        if (!user || !event) return;
        
        const eventDate = new Date(event.match_date);
        const formattedDate = eventDate.toLocaleDateString('ru-RU', {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const statusText = reg.status === 'registered' ? '–ó–∞–ø–∏—Å–∞–Ω' : 
                          reg.status === 'cancelled' ? '–û—Ç–º–µ–Ω–µ–Ω' : 
                          reg.status === 'checked_in' ? '–û—Ç–º–µ—Ç–∏–ªc—è' : reg.status;
        
        const statusClass = reg.status === 'registered' ? 'status-registered' :
                           reg.status === 'cancelled' ? 'status-cancelled' :
                           'status-checked_in';
        
        const now = new Date();
        const isEventPast = eventDate < now;
        
        const registrationItem = document.createElement('div');
        registrationItem.className = 'registration-item';
        
        registrationItem.innerHTML = `
          <div class="registration-details">
            <div>
              <strong>üë§ ${user.full_name || '–ê–Ω–æ–Ω–∏–º'}</strong><br>
              <small>Telegram: @${user.username || '–Ω–µ—Ç'} (ID: ${user.telegram_id})</small><br>
              <small>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${user.id}</small>
            </div>
            <div>
              <strong>üé´ ${event.match_name}</strong><br>
              <small>üìÖ ${formattedDate}</small><br>
              <small>üìç ${event.bar_address}</small>
            </div>
          </div>
          
          <div style="margin-bottom: 10px;">
            <span class="status-badge ${statusClass}">${statusText}</span>
            <small style="color: #aaa; margin-left: 10px;">
              –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞: ${new Date(reg.created_at).toLocaleDateString('ru-RU')}
              ${reg.checkin_time ? `‚Ä¢ –û—Ç–º–µ—Ç–∫–∞: ${new Date(reg.checkin_time).toLocaleString('ru-RU')}` : ''}
            </small>
          </div>
          
          <div class="action-buttons">
            ${reg.status === 'registered' && !isEventPast ? `
              <button class="btn-checkin" onclick="checkInUser('${reg.id}', '${user.full_name}', '${event.match_name}')">
                ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ
              </button>
            ` : ''}
            
            ${reg.status === 'registered' ? `
              <button class="btn-cancel" onclick="cancelRegistration('${reg.id}', '${user.full_name}', '${event.match_name}')">
                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
              </button>
            ` : ''}
            
            ${reg.status === 'cancelled' && !isEventPast ? `
              <button class="btn-approve" onclick="reRegisterUser('${reg.id}', '${user.full_name}', '${event.match_name}')">
                ‚Üª –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
              </button>
            ` : ''}
            
            <button class="btn-delete" onclick="deleteRegistration('${reg.id}', '${user.full_name}', '${event.match_name}')">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
            </button>
          </div>
        `;
        
        container.appendChild(registrationItem);
      });
    }

    // –û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ
    async function checkInUser(registrationId, userName, eventName) {
      if (!confirm(`–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –∫–∞–∫ –ø–æ—Å–µ—Ç–∏–≤—à–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"?`)) {
        return;
      }
      
      try {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏
        const { error: updateError } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'checked_in',
            checkin_time: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .eq('id', registrationId);

        if (updateError) throw updateError;

        // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ
        const { data: registrationData } = await supabaseClient
          .from('registrations')
          .select('user_id')
          .eq('id', registrationId)
          .single();

        if (registrationData) {
          await supabaseClient
            .from('users')
            .update({
              points: supabaseClient.sql`points + 50`, // 50 –æ—á–∫–æ–≤ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ
              updated_at: new Date().toISOString()
            })
            .eq('id', registrationData.user_id);
        }

        alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø–æ—Å–µ—Ç–∏–≤—à–∏–π –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ! +50 –æ—á–∫–æ–≤`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error checking in user:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å–µ—â–µ–Ω–∏—è: ' + error.message);
      }
    }

    // –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
    async function cancelRegistration(registrationId, userName, eventName) {
      if (!confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"?`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'cancelled',
            updated_at: new Date().toISOString()
          })
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –æ—Ç–º–µ–Ω–µ–Ω–∞`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error cancelling registration:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
    async function reRegisterUser(registrationId, userName, eventName) {
      if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"?`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'registered',
            checkin_time: null,
            updated_at: new Date().toISOString()
          })
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error re-registering user:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    // –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
    async function deleteRegistration(registrationId, userName, eventName) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .delete()
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" —É–¥–∞–ª–µ–Ω–∞`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error deleting registration:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    // QR —Å–∫–∞–Ω–µ—Ä (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
    let scannerActive = false;
    let videoStream = null;

    async function startQRScanner() {
      try {
        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner');
        const stopBtn = document.getElementById('stop-scanner');
        const resultDiv = document.getElementById('scanner-result');
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        
        video.srcObject = videoStream;
        video.style.display = 'block';
        video.play();
        
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        
        resultDiv.innerHTML = '<p style="color: #FFC107;">üîç –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥...</p>';
        scannerActive = true;
        
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è QR
        // –ù–∞–ø—Ä–∏–º–µ—Ä, https://github.com/schmich/instascan –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é
        
      } catch (error) {
        console.error('Error starting QR scanner:', error);
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: ' + error.message);
      }
    }

    function stopQRScanner() {
      const video = document.getElementById('qr-video');
      const startBtn = document.getElementById('start-scanner');
      const stopBtn = document.getElementById('stop-scanner');
      const resultDiv = document.getElementById('scanner-result');
      
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      
      video.style.display = 'none';
      video.srcObject = null;
      
      startBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      
      resultDiv.innerHTML = '<p style="color: #aaa;">–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</p>';
      scannerActive = false;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ QR –∫–æ–¥–∞
    function processQRCode(qrData) {
      const resultDiv = document.getElementById('scanner-result');
      
      try {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ QR –∫–æ–¥ –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // –ù–∞–ø—Ä–∏–º–µ—Ä: {"user_id": "uuid", "registration_id": "uuid"}
        const data = JSON.parse(qrData);
        
        if (data.user_id && data.registration_id) {
          resultDiv.innerHTML = `<p style="color: #4CAF50;">‚úÖ QR –∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω</p>
                                <p>–ò—â–µ–º –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</p>`;
          
          // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –∑–∞–ø–∏—Å–∏ –∏ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è
          // –ù–∞–ø—Ä–∏–º–µ—Ä: checkInUser(data.registration_id, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ");
          
        } else {
          resultDiv.innerHTML = '<p style="color: #f44336;">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞</p>';
        }
      } catch (error) {
        resultDiv.innerHTML = `<p style="color: #f44336;">‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞</p>
                              <p>${error.message}</p>`;
      }
    }

    // =============================================
    //   –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    // =============================================
    async function createEvent() {
      const name   = document.getElementById('match_name')?.value?.trim();
      const date   = document.getElementById('match_date')?.value;
      const addr   = document.getElementById('bar_address')?.value?.trim();
      const desc   = document.getElementById('description')?.value?.trim() || null;
      const max    = parseInt(document.getElementById('max_participants')?.value) || null;
      const open   = document.getElementById('is_open')?.checked ?? true;

      if (!name || !date || !addr) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç–∞ –∏ –∞–¥—Ä–µ—Å');
        return;
      }

      const { error } = await supabaseClient.from('events').insert({
        match_name: name,
        match_date: new Date(date).toISOString(),
        bar_address: addr,
        description: desc,
        max_participants: max,
        is_open: open
      });

      if (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      } else {
        alert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!');
        document.getElementById('match_name').value = '';
        document.getElementById('match_date').value = '';
        document.getElementById('bar_address').value = '';
        document.getElementById('description').value = '';
        document.getElementById('max_participants').value = '';
        
        loadEvents();
        loadStats();
        loadEventsForFilter();
      }
    }

    async function loadEvents() {
      const { data, error } = await supabaseClient
        .from('events')
        .select('*')
        .order('match_date', { ascending: true });

      const cont = document.getElementById('events-list');
      
      if (error) {
        cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>';
        return;
      }
      
      if (!data?.length) {
        cont.innerHTML = '<p>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç</p>';
        return;
      }

      cont.innerHTML = '';
      
      data.forEach(ev => {
        const eventDate = new Date(ev.match_date);
        const formattedDate = eventDate.toLocaleDateString('ru-RU', {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const d = document.createElement('div');
        d.className = 'event-item';
        d.innerHTML = `
          <strong>${ev.match_name}</strong><br>
          <small>üìÖ ${formattedDate}</small><br>
          <small>üìç ${ev.bar_address}</small><br>
          <small>üë• –ú–∞–∫—Å: ${ev.max_participants || '–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ'}</small><br>
          <small>${ev.is_open ? '‚úÖ –û—Ç–∫—Ä—ã—Ç–∞ –∑–∞–ø–∏—Å—å' : '‚ùå –ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞'}</small>
          ${ev.description ? `<br><small>üìù ${ev.description}</small>` : ''}
        `;
        cont.appendChild(d);
      });
    }

    async function loadPending() {
      const { data, error } = await supabaseClient
        .from('users')
        .select('id, full_name, username, email, created_at, points, telegram_id')
        .eq('membership_status', 'pending')
        .order('created_at', { ascending: true });

      const cont = document.getElementById('pending-list');
      
      if (error) {
        cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>';
        return;
      }
      
      if (!data?.length) {
        cont.innerHTML = '<p>–ó–∞—è–≤–æ–∫ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ –Ω–µ—Ç</p>';
        return;
      }

      cont.innerHTML = '';
      
      data.forEach(user => {
        const d = document.createElement('div');
        d.className = 'pending-item';
        d.innerHTML = `
          <div class="user-info">
            <div>
              <strong>üë§ ${user.full_name}</strong><br>
              <small>Telegram: @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small><br>
              <small>ID: ${user.id}</small>
            </div>
            <div>
              <small>üìß ${user.email || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small><br>
              <small>üìÖ ${new Date(user.created_at).toLocaleDateString('ru-RU')}</small><br>
              <small>‚≠ê –û—á–∫–æ–≤: ${user.points || 0}</small>
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn-approve" onclick="approveApplication('${user.id}')">
              ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å (+100 –æ—á–∫–æ–≤)
            </button>
            <button class="btn-reject" onclick="rejectApplication('${user.id}')">
              ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
            </button>
          </div>
        `;
        cont.appendChild(d);
      });
    }

    async function loadAllUsers() {
      const { data, error } = await supabaseClient
        .from('users')
        .select('id, full_name, username, email, points, membership_status, created_at')
        .order('created_at', { ascending: false });

      const cont = document.getElementById('all-users-list');
      
      if (error) {
        cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
        return;
      }
      
      if (!data?.length) {
        cont.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</p>';
        return;
      }

      window.allUsers = data;
      renderUsers(data);
    }

    function renderUsers(users) {
      const cont = document.getElementById('all-users-list');
      cont.innerHTML = '';
      
      users.forEach(user => {
        const statusColor = {
          'New': '#2196F3',
          'pending': '#FFC107',
          'approved': '#4CAF50',
          'rejected': '#F44336'
        }[user.membership_status] || '#9E9E9E';
        
        const d = document.createElement('div');
        d.className = 'event-item';
        d.style.borderLeftColor = statusColor;
        d.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <strong>${user.full_name}</strong><br>
              <small>@${user.username || '–Ω–µ—Ç'}</small><br>
              <small>${user.email || '–Ω–µ—Ç email'}</small>
            </div>
            <div style="text-align: right;">
              <span style="background: ${statusColor}; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                ${user.membership_status}
              </span><br>
              <strong>‚≠ê ${user.points || 0}</strong>
            </div>
          </div>
          <div style="margin-top: 10px; font-size: 0.8rem; color: #aaa;">
            ID: ${user.id} ‚Ä¢ –†–µ–≥: ${new Date(user.created_at).toLocaleDateString('ru-RU')}
          </div>
        `;
        cont.appendChild(d);
      });
    }

    function searchUsers() {
      const searchTerm = document.getElementById('search-user').value.toLowerCase();
      if (!window.allUsers) return;
      
      const filtered = window.allUsers.filter(user => 
        user.full_name?.toLowerCase().includes(searchTerm) ||
        user.username?.toLowerCase().includes(searchTerm) ||
        user.email?.toLowerCase().includes(searchTerm) ||
        user.id?.toLowerCase().includes(searchTerm)
      );
      
      renderUsers(filtered);
    }

    async function approveApplication(userId) {
      if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å 100 –±–æ–Ω—É—Å–Ω—ã—Ö –æ—á–∫–æ–≤?')) return;
      
      try {
        const { data: userData, error: fetchError } = await supabaseClient
          .from('users')
          .select('points')
          .eq('id', userId)
          .single();

        if (fetchError) throw fetchError;
        
        const currentPoints = userData.points || 0;
        const newPoints = currentPoints + 100;
        
        const { error: updateError } = await supabaseClient
          .from('users')
          .update({ 
            membership_status: 'approved',
            points: newPoints,
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (updateError) throw updateError;
        
        alert('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∞! +100 –æ—á–∫–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω—ã.');
        
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      }
    }

    async function rejectApplication(userId) {
      if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('users')
          .update({ 
            membership_status: 'rejected',
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (error) throw error;
        
        alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.');
        
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      }
    }

    async function updateUser() {
      const telegramIdInput = document.getElementById('user-id-input').value.trim();
      const addPoints = parseInt(document.getElementById('add-points').value) || 0;
      const removePoints = parseInt(document.getElementById('remove-points').value) || 0;
      const newStatus = document.getElementById('user-status-select').value;
      
      if (!telegramIdInput) {
        alert('–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      if (!addPoints && !removePoints && !newStatus) {
        alert('–£–∫–∞–∂–∏—Ç–µ —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å: –æ—á–∫–∏ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å');
        return;
      }
      
      try {
        const { data: userData, error: fetchError } = await supabaseClient
          .from('users')
          .select('id, points')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        if (fetchError) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + fetchError.message);
          return;
        }
        
        if (!userData) {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        const updates = {};
        const currentPoints = userData.points || 0;
        
        if (addPoints > 0 || removePoints > 0) {
          updates.points = currentPoints + addPoints - removePoints;
          if (updates.points < 0) updates.points = 0;
        }
        
        if (newStatus) {
          updates.membership_status = newStatus;
        }
        
        updates.updated_at = new Date().toISOString();
        
        const { error } = await supabaseClient
          .from('users')
          .update(updates)
          .eq('id', userData.id);
        
        if (error) throw error;
        
        alert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
        
        document.getElementById('user-id-input').value = '';
        document.getElementById('add-points').value = '';
        document.getElementById('remove-points').value = '';
        document.getElementById('user-status-select').value = '';
        
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
      }
    }

    // =============================================
    //   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–û–ë–´–¢–ò–ô –ù–ê –°–¢–†–ê–ù–ò–¶–ï
    // =============================================
    document.addEventListener('DOMContentLoaded', () => {
      // –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞
      document.getElementById('login-button')?.addEventListener('click', tryLogin);

      // –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∞–¥–º–∏–Ω–∫–∏
      document.getElementById('create-event-button')?.addEventListener('click', createEvent);
      document.getElementById('refresh-pending')?.addEventListener('click', loadPending);
      document.getElementById('refresh-events')?.addEventListener('click', loadEvents);
      document.getElementById('refresh-users')?.addEventListener('click', loadAllUsers);
      document.getElementById('refresh-registrations')?.addEventListener('click', loadRegistrations);
      document.getElementById('update-user-btn')?.addEventListener('click', updateUser);
      document.getElementById('logout-button')?.addEventListener('click', logout);
      
      // QR —Å–∫–∞–Ω–µ—Ä
      document.getElementById('start-scanner')?.addEventListener('click', startQRScanner);
      document.getElementById('stop-scanner')?.addEventListener('click', stopQRScanner);
      
      // –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∑–∞–ø–∏—Å–µ–π
      document.getElementById('search-registration')?.addEventListener('input', loadRegistrations);
      document.getElementById('filter-event')?.addEventListener('change', loadRegistrations);
      document.getElementById('filter-status')?.addEventListener('change', loadRegistrations);

      // –ê–≤—Ç–æ–≤—Ö–æ–¥ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–µ—Å—Å–∏–∏
      if (localStorage.getItem('adminLoggedIn') === 'true') {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        showMsg('status', '‚úÖ –ê–≤—Ç–æ–≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
        loadStats();
        loadEvents();
        loadPending();
        loadAllUsers();
        loadRegistrations();
        loadEventsForFilter();
      }
    });
  </script>
</body>
</html>
