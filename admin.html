<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel — Chelsea FC KZ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #001028;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    h1, h2 {
      font-family: 'Oswald', sans-serif;
      color: #D4A017;
      text-align: center;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .login-form, .admin-content { max-width: 500px; margin: 40px auto; }
    input, textarea, button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #444;
      background: #112;
      color: white;
      font-size: 1.1rem;
    }
    button {
      background: #D4A017;
      color: #001028;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #E8B923; }
    .section { margin: 40px 0; padding: 20px; background: rgba(3,70,148,0.15); border-radius: 12px; }
    .event-list { margin-top: 20px; }
    .event-item { background: #0a1a3a; padding: 12px; margin: 8px 0; border-radius: 8px; }
    .hidden { display: none !important; }
    #status, #login-status { text-align: center; margin: 20px 0; font-size: 1.1rem; }
    #login-status { color: #ff6666; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Admin Panel</h1>

    <div id="login-section" class="login-form">
      <h2>Вход для администратора</h2>
      <input type="text" id="admin-login" placeholder="Логин" value="Admin">
      <input type="password" id="admin-pass" placeholder="Пароль">
      <button id="login-button">Войти</button>
      <div id="login-status"></div>
    </div>

    <div id="admin-content" class="hidden">
      <div id="status">Загрузка данных...</div>

      <div class="section">
        <h2>Создать мероприятие</h2>
        <input type="text" id="match_name" placeholder="Название матча (Chelsea vs Arsenal)">
        <input type="datetime-local" id="match_date">
        <input type="text" id="bar_address" placeholder="Адрес бара">
        <textarea id="description" placeholder="Описание" rows="3"></textarea>
        <input type="number" id="max_participants" placeholder="Макс. участников (опционально)">
        <label style="display:block; margin:10px 0;">
          <input type="checkbox" id="is_open" checked> Открыта запись
        </label>
        <button id="create-event-button">Создать</button>
      </div>

      <div class="section">
        <h2>Заявки на Membership</h2>
        <div id="pending-list">Загрузка...</div>
        <button id="refresh-pending">Обновить список</button>
      </div>

      <div class="section">
        <h2>Календарь мероприятий</h2>
        <div id="events-list" class="event-list">Загрузка...</div>
        <button id="refresh-events">Обновить календарь</button>
      </div>

      <button id="logout-button" style="background:#c00; margin-top:40px; width:100%;">Выйти</button>
    </div>
  </div>

  <script>
    // =============================================
    //   ИНИЦИАЛИЗАЦИЯ SUPABASE (только один раз!)
    // =============================================
    const supabaseUrl  = 'https://zuapiixwzkleygaijulx.supabase.co';
    const supabaseKey  = 'sb_publishable_Jsth-2GViNz5Ev3UWtrWTg_fbg4GAKx';
      const supabaseClient = supabase.createClient(
    supabaseUrl,
    supabaseKey
  );

    const ADMIN_LOGIN = 'Admin';
    const ADMIN_PASS  = '44mnUr8Xz';

    // =============================================
    //   ПОМОГАЮЩИЕ ФУНКЦИИ
    // =============================================
    function showMsg(id, text, isError = false) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = text;
        el.style.color = isError ? '#ff6666' : '#88ff88';
      }
    }

    // =============================================
    //   АВТОРИЗАЦИЯ
    // =============================================
    function tryLogin() {
      const login = document.getElementById('admin-login')?.value?.trim();
      const pass  = document.getElementById('admin-pass')?.value?.trim();

      if (!login || !pass) {
        showMsg('login-status', 'Введите логин и пароль', true);
        return;
      }

      if (login === ADMIN_LOGIN && pass === ADMIN_PASS) {
        localStorage.setItem('adminLoggedIn', 'true');
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        showMsg('status', 'Добро пожаловать в админ-панель');
        loadEvents();
        loadPending();
      } else {
        showMsg('login-status', 'Неверный логин или пароль', true);
      }
    }

    function logout() {
      localStorage.removeItem('adminLoggedIn');
      location.reload();
    }

    // =============================================
    //   СОЗДАНИЕ МЕРОПРИЯТИЯ
    // =============================================
    async function createEvent() {
      const name   = document.getElementById('match_name')?.value?.trim();
      const date   = document.getElementById('match_date')?.value;
      const addr   = document.getElementById('bar_address')?.value?.trim();
      const desc   = document.getElementById('description')?.value?.trim() || null;
      const max    = parseInt(document.getElementById('max_participants')?.value) || null;
      const open   = document.getElementById('is_open')?.checked ?? true;

      if (!name || !date || !addr) {
        alert('Заполните обязательные поля');
        return;
      }

      const { error } = await supabaseClient.from('events').insert({
        match_name: name,
        match_date: new Date(date).toISOString(),
        bar_address: addr,
        description: desc,
        max_participants: max,
        is_open: open
      });

      if (error) {
        alert('Ошибка: ' + error.message);
      } else {
        alert('Создано');
        loadEvents();
      }
    }

    // =============================================
    //   ЗАГРУЗКА СОБЫТИЙ
    // =============================================
    async function loadEvents() {
      const { data, error } = await supabaseClient
        .from('events')
        .select('*')
        .order('match_date', { ascending: true });

      const cont = document.getElementById('events-list');
      cont.innerHTML = error ? '<p>Ошибка загрузки</p>' :
                       !data?.length ? '<p>Мероприятий нет</p>' : '';

      if (error || !data?.length) return;

      data.forEach(ev => {
        const d = document.createElement('div');
        d.className = 'event-item';
        d.innerHTML = `
          <strong>${ev.match_name}</strong><br>
          ${new Date(ev.match_date).toLocaleString('ru-RU')}<br>
          ${ev.bar_address} • ${ev.is_open ? 'Открыто' : 'Закрыто'}
        `;
        cont.appendChild(d);
      });
    }

    // =============================================
    //   ЗАЯВКИ НА ЧЛЕНСТВО
    // =============================================
    async function loadPending() {
      const { data, error } = await supabaseClient
        .from('users')
        .select('id, full_name, username')
        .eq('membership_status', 'pending');

      const cont = document.getElementById('pending-list');
      cont.innerHTML = error ? '<p>Ошибка</p>' :
                       !data?.length ? '<p>Заявок нет</p>' : '';

      if (error || !data?.length) return;

      data.forEach(u => {
        const d = document.createElement('div');
        d.className = 'event-item';
        d.innerHTML = `
          ${u.full_name} (@${u.username || 'нет'})<br>
          <button onclick="changeStatus('${u.id}', 'approved')">Одобрить</button>
          <button onclick="changeStatus('${u.id}', 'rejected')" style="background:#c00;">Отклонить</button>
        `;
        cont.appendChild(d);
      });
    }

    async function changeStatus(id, status) {
      if (!confirm(`Установить статус "${status}"?`)) return;
      const { error } = await supabaseClient
        .from('users')
        .update({ membership_status: status })
        .eq('id', id);

      if (error) alert('Ошибка: ' + error.message);
      else {
        alert('Обновлено');
        loadPending();
      }
    }

    // =============================================
    //   ИНИЦИАЛИЗАЦИЯ СОБЫТИЙ НА СТРАНИЦЕ
    // =============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Кнопка входа
      document.getElementById('login-button')?.addEventListener('click', tryLogin);

      // Кнопки внутри админки
      document.getElementById('create-event-button')?.addEventListener('click', createEvent);
      document.getElementById('refresh-pending')?.addEventListener('click', loadPending);
      document.getElementById('refresh-events')?.addEventListener('click', loadEvents);
      document.getElementById('logout-button')?.addEventListener('click', logout);

      // Автовход при наличии сессии
      if (localStorage.getItem('adminLoggedIn') === 'true') {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        showMsg('status', 'Автовход выполнен');
        loadEvents();
        loadPending();
      }
    });
  </script>
</body>
</html>
