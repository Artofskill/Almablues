<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel ‚Äî Almablues</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@master/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --text: #c9d1d9;
      --accent: #58a6ff;
      --accent2: #ffa657;
      --green: #56d364;
      --border: #30363d;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 15px;
      font-size: 16px;
      line-height: 1.5;
    }

    h1, h2 {
      font-family: 'Oswald', sans-serif;
      text-align: center;
      word-break: break-word;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      background: linear-gradient(90deg, #00f5ff, #ff00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      cursor: pointer;
      position: relative;
      padding-right: 30px;
      color: var(--text);
    }

    h2::after {
      content: '‚ñº';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      transition: transform 0.3s ease;
      color: var(--accent);
    }

    h2.collapsed::after {
      transform: translateY(-50%) rotate(-90deg);
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    .login-form, .admin-content {
      max-width: 100%;
      margin: 20px auto;
      padding: 0 10px;
    }

    input, textarea, select {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      border-radius: 8px;
      border: 2px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
      transition: all 0.3s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    button {
      width: 100%;
      padding: 16px;
      margin: 8px 0;
      border-radius: 50px;
      border: none;
      background: linear-gradient(90deg, var(--accent), #79c0ff);
      color: #000;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
    }

    button:active {
      transform: translateY(0);
    }

    .section {
      margin: 30px 0;
      padding: 20px;
      background: var(--card);
      border-radius: 24px;
      border: 2px solid var(--border);
      word-break: break-word;
      box-shadow: 0 10px 35px rgba(0,0,0,0.6);
      transition: all 0.3s ease;
    }

    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.7);
      border-color: var(--accent);
    }

    .section-content {
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      max-height: 5000px;
      opacity: 1;
    }

    .section-content.collapsed {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }

    .event-list, .pending-list, .registrations-list {
      margin-top: 15px;
    }

    .event-item, .pending-item, .registration-item {
      background: var(--card);
      padding: 15px;
      margin: 12px 0;
      border-radius: 16px;
      border: 2px solid var(--border);
      word-break: break-word;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    }

    .event-item:hover, .pending-item:hover, .registration-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
      border-color: var(--accent);
    }

    .pending-item {
      border-color: var(--accent2);
    }

    .approved-item {
      border-color: var(--green);
    }

    .event-item.past {
      border-color: #555;
      opacity: 0.8;
    }

    .event-item.current {
      border-color: var(--accent2);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { border-color: var(--accent2); }
      50% { border-color: var(--accent); }
      100% { border-color: var(--accent2); }
    }

    .hidden {
      display: none !important;
    }

    #status, #login-status {
      text-align: center;
      margin: 15px 0;
      font-size: 1rem;
      padding: 0 10px;
    }

    #login-status {
      color: #ff6666;
    }

    .user-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .user-info div {
      background: var(--card);
      padding: 10px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid var(--border);
    }

    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .action-buttons button {
      flex: 1;
      padding: 10px 12px;
      min-width: 120px;
      font-size: 0.9rem;
      margin: 0;
      border-radius: 50px;
      background: linear-gradient(90deg, var(--accent), #79c0ff);
      color: #000;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    }

    .action-buttons button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
    }

    .btn-approve {
      background: linear-gradient(90deg, var(--green), #3fb83f);
      color: #000;
    }

    .btn-reject {
      background: linear-gradient(90deg, #ff4444, #cc0000);
      color: #fff;
    }

    .btn-checkin {
      background: linear-gradient(90deg, var(--accent), #58a6ff);
      color: #000;
    }

    .btn-qr {
      background: linear-gradient(90deg, #a855f7, #7c3aed);
      color: #fff;
    }

    .btn-cancel {
      background: linear-gradient(90deg, var(--accent2), #ff8c00);
      color: #000;
    }

    .btn-delete {
      background: linear-gradient(90deg, #ff4444, #cc0000);
      color: #fff;
    }

    .btn-blacklist-add {
      background: linear-gradient(90deg, #ff4444, #cc0000);
      color: #fff;
    }

    .btn-blacklist-remove {
      background: linear-gradient(90deg, var(--green), #3fb83f);
      color: #000;
    }

    .btn-delete-event {
      background: linear-gradient(90deg, #ff4444, #cc0000);
      color: #fff;
      margin-top: 10px;
      padding: 10px;
      border-radius: 50px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: var(--card);
      padding: 20px 15px;
      border-radius: 24px;
      text-align: center;
      min-width: 0;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
      box-shadow: 0 10px 35px rgba(0,0,0,0.6);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.7);
      border-color: var(--accent);
    }

    .stat-number {
      font-size: 2.2rem;
      font-weight: bold;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 8px;
      font-family: 'Oswald', sans-serif;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text);
      opacity: 0.8;
      line-height: 1.3;
      font-weight: 500;
    }

    .stat-icon {
      font-size: 1.5rem;
      margin-bottom: 10px;
      opacity: 0.8;
    }

    .registration-details {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (min-width: 768px) {
      .registration-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 8px;
      white-space: nowrap;
      border: 1px solid var(--border);
    }

    .status-registered {
      background: rgba(88, 166, 255, 0.2);
      color: var(--accent);
      border-color: var(--accent);
    }

    .status-cancelled {
      background: rgba(255, 68, 68, 0.2);
      color: #ff4444;
      border-color: #ff4444;
    }

    .status-checked_in {
      background: rgba(86, 211, 100, 0.2);
      color: var(--green);
      border-color: var(--green);
    }

    .filters {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    @media (min-width: 640px) {
      .filters {
        flex-direction: row;
      }
      
      .filters input,
      .filters select {
        flex: 1;
        min-width: 0;
      }
    }

    .event-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .event-tab {
      padding: 12px 20px;
      white-space: nowrap;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      flex-shrink: 0;
      color: var(--text);
      transition: all 0.3s ease;
    }

    .event-tab:hover {
      color: var(--accent);
    }

    .event-tab.active {
      border-bottom-color: var(--accent);
      color: var(--accent);
    }

    .event-tab-content {
      display: none;
    }

    .event-tab-content.active {
      display: block;
    }

    .event-time-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      margin-left: 8px;
      vertical-align: middle;
      border: 1px solid var(--border);
    }

    .badge-future {
      background: rgba(86, 211, 100, 0.2);
      color: var(--green);
      border-color: var(--green);
    }

    .badge-current {
      background: rgba(255, 166, 87, 0.2);
      color: var(--accent2);
      border-color: var(--accent2);
    }

    .badge-past {
      background: rgba(100, 100, 100, 0.2);
      color: #888;
      border-color: #555;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text);
      opacity: 0.6;
      font-size: 1rem;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è QR */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--card);
      padding: 25px;
      border-radius: 24px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid var(--border);
      box-shadow: 0 10px 35px rgba(0,0,0,0.6);
    }

    .close-modal {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--accent);
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      width: auto;
    }

    /* QR –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    #qr-code-container {
      text-align: center;
      padding: 20px;
      background: white;
      border-radius: 8px;
      margin: 15px 0;
    }

    .qr-info {
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
    @media (max-width: 600px) {
      body {
        padding: 15px 10px;
      }
      
      h1 {
        font-size: 1.9rem;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      .section {
        padding: 15px;
        margin: 20px 0;
      }
      
      .stats {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .stat-card {
        padding: 15px 10px;
      }
      
      .stat-number {
        font-size: 1.8rem;
      }
      
      .stat-label {
        font-size: 0.85rem;
      }
      
      .action-buttons button {
        min-width: 100%;
        margin-bottom: 5px;
      }
      
      button {
        padding: 14px;
        font-size: 0.95rem;
      }
      
      input, textarea, select {
        padding: 12px;
        font-size: 16px;
      }
      
      .event-tab {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      
      .modal-content {
        padding: 15px;
      }
      
      .grid-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .grid-item {
        padding: 15px;
        min-height: 130px;
      }
      
      .grid-icon {
        font-size: 2rem;
      }
      
      .grid-title {
        font-size: 1rem;
      }
    }
    

    @media (max-width: 480px) {
      body {
        padding: 10px;
        font-size: 14px;
      }
      
      h1 {
        font-size: 1.6rem;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      .section {
        padding: 15px;
        margin: 20px 0;
      }
      
      .stats {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-number {
        font-size: 2rem;
      }
      
      .action-buttons button {
        min-width: 100%;
        margin-bottom: 5px;
      }
      
      button {
        padding: 14px;
        font-size: 0.95rem;
      }
      
      input, textarea, select {
        padding: 12px;
        font-size: 16px;
      }
      
      .event-tab {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      
      .modal-content {
        padding: 15px;
      }
      
      .grid-container {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .grid-item {
        aspect-ratio: auto;
        min-height: 100px;
        padding: 15px;
        flex-direction: row;
        justify-content: flex-start;
        text-align: left;
      }
      
      .grid-icon {
        margin-bottom: 0;
        margin-right: 15px;
        font-size: 1.8rem;
        min-width: 40px;
      }
      
      .grid-title {
        text-align: left;
      }
    }

    /* –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
    @media (min-width: 1200px) {
      .container {
        max-width: 1100px;
      }
      
      .admin-content {
        max-width: 1100px;
      }
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ—Ç–∫–∏ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ */
    .grid-section {
      margin: 30px 0;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .grid-item {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 24px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 150px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.6);
    }

    .grid-item:hover {
      background: var(--card);
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.7);
      border-color: var(--accent);
    }

    .grid-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: var(--accent);
    }

    .grid-title {
      font-family: 'Oswald', sans-serif;
      color: var(--text);
      font-size: 1.1rem;
      word-break: break-word;
      width: 100%;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Å–µ—Ç–∫–∏ */
    .grid-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
      padding: 20px;
    }

    .grid-modal-content {
      background: var(--card);
      padding: 25px;
      border-radius: 24px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      overflow-y: auto;
      border: 2px solid var(--border);
      margin-top: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.6);
    }

    .close-grid-modal {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--accent);
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      width: auto;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Å–µ—Ç–∫–∏ */
    /* –£–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π @media (max-width: 600px) –≤—ã—à–µ */
    
    /* –£–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π @media (max-width: 480px) –≤—ã—à–µ */
  </style>
</head>
<body>

  <div class="container">
    <h1>Admin Panel ‚Ä¢ Almablues</h1>

    <div id="login-section" class="login-form">
      <h2>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
      <input type="text" id="admin-login" placeholder="–õ–æ–≥–∏–Ω" value="Admin">
      <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å">
      <button onclick="tryLogin()" id="login-button">–í–æ–π—Ç–∏</button>
      <div id="login-status"></div>
    </div>

    <!-- –í–°–Ø –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ –¢–ï–ü–ï–†–¨ –°–ö–†–´–¢–ê –î–û –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
    <div id="admin-content" class="hidden">
      <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–µ–ø–µ—Ä—å —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è) -->
      <div class="section hidden">
        <h2 class="collapsible-section">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="section-content collapsed">
          <div class="stats" id="stats-section">
            <div class="stat-card">
              <div class="stat-icon">üìÖ</div>
              <div class="stat-number" id="past-events-count">0</div>
              <div class="stat-label">–ü—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üöÄ</div>
              <div class="stat-number" id="upcoming-events-count">0</div>
              <div class="stat-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üë•</div>
              <div class="stat-number" id="total-users">0</div>
              <div class="stat-label">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">‚≠ê</div>
              <div class="stat-number" id="approved-users">0</div>
              <div class="stat-label">Membership's (approved)</div>
            </div>
          </div>
        </div>
      </div>

      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
      <div class="section hidden">
        <h2 class="collapsible-section">‚ûï –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h2>
        <div class="section-content collapsed">
          <input type="text" id="match_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞ (Chelsea vs Arsenal)">
          <input type="datetime-local" id="match_date">
          <input type="text" id="bar_address" placeholder="–ê–¥—Ä–µ—Å –±–∞—Ä–∞">
          <textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" rows="3"></textarea>
          <input type="number" id="max_participants" placeholder="–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
          <input type="number" id="points_award" placeholder="–ë–∞–ª–ª—ã –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ" value="10" min="0">
            <div style="font-size: 0.85rem; color: #aaa; margin-top: 5px;">
              ‚ÑπÔ∏è <strong>–ó–∞–ø–∏—Å—å</strong> = –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ<br>
              ‚ÑπÔ∏è <strong>–ß–µ–∫–∏–Ω</strong> = –æ—Ç–º–µ—Ç–∫–∞ –æ –ø–æ—Å–µ—â–µ–Ω–∏–∏ (–Ω–µ –±–æ–ª–µ–µ 2—á –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
            </div>
          </label>
          <button onclick="createEvent()" id="create-event-button">–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
        </div>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
      <div class="section hidden">
        <h2 class="collapsible-section">üé´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
        <div class="section-content collapsed">
          <div class="filters">
            <input type="text" id="search-registration" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é" oninput="loadRegistrations()">
            <select id="filter-event" onchange="loadRegistrations()">
              <option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>
            </select>
            <select id="filter-status" onchange="loadRegistrations()">
              <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="participants">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (–∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ + –æ—Ç–º–µ—Ç–∏–≤—à–∏–µ—Å—è)</option>
              <option value="registered">–ó–∞–ø–∏—Å–∞–Ω</option>
              <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
              <option value="checked_in">–ü—Ä–æ—à–µ–ª —á–µ–∫–∏–Ω</option>
            </select>
          </div>
          
          <div id="registrations-list" class="registrations-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          <button onclick="loadRegistrations()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π</button>
        </div>
      </div>

      <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
      <div class="section hidden">
        <h2 class="collapsible-section">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h2>
        <div class="section-content collapsed">
          <!-- –¢–∞–±—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
          <div class="event-tabs">
            <div class="event-tab active" onclick="switchEventTab('upcoming')">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</div>
            <div class="event-tab" onclick="switchEventTab('current')">–¢–µ–∫—É—â–∏–µ</div>
            <div class="event-tab" onclick="switchEventTab('past')">–ü—Ä–æ—à–µ–¥—à–∏–µ</div>
            <div class="event-tab" onclick="switchEventTab('all')">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
          </div>
          
          <div id="upcoming-events" class="event-tab-content active">
            <div id="upcoming-events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
          </div>
          
          <div id="current-events" class="event-tab-content">
            <div id="current-events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
          </div>
          
          <div id="past-events" class="event-tab-content">
            <div id="past-events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
          </div>
          
          <div id="all-events" class="event-tab-content">
            <div id="all-events-list" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
          </div>
          
          <button onclick="loadAllEvents()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
        </div>
      </div>

      <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ Membership -->
      <div class="section hidden">
        <h2 class="collapsible-section">üìã –ó–∞—è–≤–∫–∏ –Ω–∞ Membership</h2>
        <div class="section-content collapsed">
          <div id="pending-list" class="pending-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          <button onclick="loadPending()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>
      </div>

      <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
      <div class="section hidden">
        <h2 class="collapsible-section">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <div class="section-content collapsed">
          <div style="margin-bottom: 15px;">
            <input type="text" id="search-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, username, Telegram ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É" onkeyup="searchUsers()">
          </div>
          <div id="all-users-list" class="pending-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          <button onclick="loadAllUsers()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
        </div>
      </div>

      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
      <div class="section hidden">
        <h2 class="collapsible-section">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h2>
        <div class="section-content collapsed">
          <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
          <div style="margin-bottom: 15px;">
            <input type="text" id="search-user-manage" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ username, Telegram ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É" onkeyup="searchUserForManage()">
            <div id="user-search-results" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #444; background: #112; border-radius: 8px; margin-top: 5px;"></div>
          </div>
          
          <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
          <input type="text" id="user-id-input" placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" readonly>
          <input type="text" id="user-name-display" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" readonly>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="number" id="add-points" placeholder="–î–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏">
            <input type="number" id="remove-points" placeholder="–£–±—Ä–∞—Ç—å –æ—á–∫–∏">
          </div>
          
          <select id="user-status-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
            <option value="New">New - –ù–æ–≤—ã–π</option>
            <option value="pending">pending - –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
            <option value="approved">approved - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
            <option value="rejected">rejected - –û—Ç–∫–ª–æ–Ω–µ–Ω</option>
          </select>
          
          <!-- –ö–Ω–æ–ø–∫–∏ BlackList -->
          <div class="action-buttons" id="blacklist-buttons" style="display: none;">
            <button id="add-to-blacklist" onclick="addToBlacklist()" class="btn-blacklist-add" style="width: 100%; margin-top: 10px;">
              üö´ –î–æ–±–∞–≤–∏—Ç—å –≤ BlackList
            </button>
            <button id="remove-from-blacklist" onclick="removeFromBlacklist()" class="btn-blacklist-remove" style="width: 100%; margin-top: 10px; display: none;">
              ‚úÖ –£–±—Ä–∞—Ç—å –∏–∑ BlackList
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
            <button onclick="updateUser()" class="btn">–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            <button onclick="refreshUserInfo()" class="btn" style="background: #17a2b8;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
          </div>
        </div>
      </div>

      <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram -->
      <div class="section hidden">
        <h2 class="collapsible-section">üì® –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram</h2>
        <div class="section-content collapsed">
          <div style="margin-bottom: 15px;">
            <input type="text" id="notification-search-user" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username –∏–ª–∏ ID" onkeyup="searchUserForNotification()">
            <div id="notification-search-results" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #444; background: #112; border-radius: 8px; margin-top: 5px;"></div>
          </div>
          
          <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
          <input type="text" id="notification-user-id" placeholder="Telegram ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è" readonly>
          <input type="text" id="notification-user-name" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è" readonly>
          
          <textarea id="notification-message" placeholder="–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" rows="4"></textarea>
          
          <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ -->
          <div style="margin: 10px 0; padding: 10px; background: rgba(212, 160, 23, 0.1); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
              <input type="checkbox" id="notification-send-to-all" onclick="toggleSendToAll()" style="width: auto;">
              <label for="notification-send-to-all" style="margin: 0;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å Telegram ID</label>
            </div>
            <small style="color: #aaa; display: block; margin-top: 5px;">
              ‚ö†Ô∏è –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤—Å–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å Telegram ID (–ª—é–±–æ–π —Å—Ç–∞—Ç—É—Å)
            </small>
          </div>
          
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button onclick="sendTestNotification()" class="btn" style="background: #17a2b8; flex: 1;">üìã –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
            <button onclick="sendNotification()" class="btn" style="background: #9C27B0; flex: 2;">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
          </div>
          
          <div id="notification-status" style="margin-top: 10px; text-align: center;"></div>
        </div>
      </div>

      <!-- –°–µ—Ç–∫–∞ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ -->
      <div class="grid-section hidden">
        <div class="grid-container">
          <div class="grid-item" onclick="openModal('modal-stats')">
            <div class="grid-icon">üìä</div>
            <div class="grid-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
          </div>
          <div class="grid-item" onclick="openModal('modal-create-event')">
            <div class="grid-icon">‚ûï</div>
            <div class="grid-title">–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
          </div>
          <div class="grid-item" onclick="openModal('modal-registrations')">
            <div class="grid-icon">üé´</div>
            <div class="grid-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏</div>
          </div>
          <div class="grid-item" onclick="openModal('modal-events')">
            <div class="grid-icon">üìÖ</div>
            <div class="grid-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
          </div>
          <div class="grid-item" onclick="openModal('modal-pending')">
            <div class="grid-icon">üìã</div>
            <div class="grid-title">–ó–∞—è–≤–∫–∏ –Ω–∞ Membership</div>
          </div>
          <div class="grid-item" onclick="openModal('modal-users')">
            <div class="grid-icon">üë•</div>
            <div class="grid-title">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
          </div>
          <div class="grid-item" onclick="openModal('modal-manage-user')">
            <div class="grid-icon">‚öôÔ∏è</div>
            <div class="grid-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</div>
          </div>
          <div class="grid-item" onclick="openModal('modal-notifications')">
            <div class="grid-icon">üì®</div>
            <div class="grid-title">–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
          </div>
        </div>
      </div>

      <button onclick="logout()" id="logout-button" style="background:#c00; margin-top:40px; width:100%;">–í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è QR –∫–æ–¥–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
  <div id="qr-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeQRModal()">&times;</span>
      <h3>üì± QR –∫–æ–¥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
      <div class="qr-info" id="qr-event-info">
        <h4>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</h4>
        <p id="qr-event-time"></p>
        <p id="qr-checkin-window"></p>
      </div>
      <div id="qr-code-container"></div>
      <div style="text-align: center; margin-top: 15px;">
        <p style="color: #aaa; font-size: 0.9rem;">
          ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —á–µ–∫–∏–Ω–∏—Ç—å—Å—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –¥–æ –∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        </p>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Å–µ—Ç–∫–∏ -->
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div id="modal-stats" class="grid-modal">
    <div class="grid-modal-content">
      <button class="close-grid-modal" onclick="closeModal('modal-stats')">&times;</button>
      <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <div class="stats" id="stats-section">
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-number" id="past-events-count">0</div>
          <div class="stat-label">–ü—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üöÄ</div>
          <div class="stat-number" id="upcoming-events-count">0</div>
          <div class="stat-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-number" id="total-users">0</div>
          <div class="stat-label">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚≠ê</div>
          <div class="stat-number" id="approved-users">0</div>
          <div class="stat-label">Membership's (approved)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ -->
  <div id="modal-create-event" class="grid-modal">
    <div class="grid-modal-content">
      <button class="close-grid-modal" onclick="closeModal('modal-create-event')">&times;</button>
      <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h2>
      <input type="text" id="match_name-modal" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞ (Chelsea vs Arsenal)">
      <input type="datetime-local" id="match_date-modal">
      <input type="text" id="bar_address-modal" placeholder="–ê–¥—Ä–µ—Å –±–∞—Ä–∞">
      <textarea id="description-modal" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" rows="3"></textarea>
      <input type="number" id="max_participants-modal" placeholder="–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
      <input type="number" id="points_award-modal" placeholder="–ë–∞–ª–ª—ã –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ" value="10" min="0">
      <div style="font-size: 0.85rem; color: #aaa; margin-top: 5px;">
        ‚ÑπÔ∏è <strong>–ó–∞–ø–∏—Å—å</strong> = –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ<br>
        ‚ÑπÔ∏è <strong>–ß–µ–∫–∏–Ω</strong> = –æ—Ç–º–µ—Ç–∫–∞ –æ –ø–æ—Å–µ—â–µ–Ω–∏–∏ (–Ω–µ –±–æ–ª–µ–µ 2—á –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
      </div>
      <button onclick="createEventModal()" id="create-event-button-modal">–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
    </div>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ -->
  <div id="modal-registrations" class="grid-modal">
    <div class="grid-modal-content">
      <button class="close-grid-modal" onclick="closeModal('modal-registrations')">&times;</button>
      <h2>üé´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
      <div class="filters">
        <input type="text" id="search-registration-modal" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é" oninput="loadRegistrationsModal()">
        <select id="filter-event-modal" onchange="loadRegistrationsModal()">
          <option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>
        </select>
        <select id="filter-status-modal" onchange="loadRegistrationsModal()">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="participants">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (–∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ + –æ—Ç–º–µ—Ç–∏–≤—à–∏–µ—Å—è)</option>
          <option value="registered">–ó–∞–ø–∏—Å–∞–Ω</option>
          <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
          <option value="checked_in">–ü—Ä–æ—à–µ–ª —á–µ–∫–∏–Ω</option>
        </select>
      </div>
      <div id="registrations-list-modal" class="registrations-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <button onclick="loadRegistrationsModal()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π</button>
    </div>
  </div>

  <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
  <div id="modal-events" class="grid-modal">
    <div class="grid-modal-content">
      <button class="close-grid-modal" onclick="closeModal('modal-events')">&times;</button>
      <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h2>
      <div class="event-tabs">
        <div class="event-tab active" onclick="switchEventTabModal('upcoming')">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</div>
        <div class="event-tab" onclick="switchEventTabModal('current')">–¢–µ–∫—É—â–∏–µ</div>
        <div class="event-tab" onclick="switchEventTabModal('past')">–ü—Ä–æ—à–µ–¥—à–∏–µ</div>
        <div class="event-tab" onclick="switchEventTabModal('all')">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
      </div>
      <div id="upcoming-events-modal" class="event-tab-content active">
        <div id="upcoming-events-list-modal" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
      </div>
      <div id="current-events-modal" class="event-tab-content">
        <div id="current-events-list-modal" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
      </div>
      <div id="past-events-modal" class="event-tab-content">
        <div id="past-events-list-modal" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
      </div>
      <div id="all-events-modal" class="event-tab-content">
        <div id="all-events-list-modal" class="event-list">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</div>
      </div>
      <button onclick="loadAllEventsModal()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    </div>
  </div>

  <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ Membership -->
  <div id="modal-pending" class="grid-modal">
    <div class="grid-modal-content">
      <button class="close-grid-modal" onclick="closeModal('modal-pending')">&times;</button>
      <h2>üìã –ó–∞—è–≤–∫–∏ –Ω–∞ Membership</h2>
      <div id="pending-list-modal" class="pending-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <button onclick="loadPendingModal()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>
  </div>

  <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
  <div id="modal-users" class="grid-modal">
    <div class="grid-modal-content">
      <button class="close-grid-modal" onclick="closeModal('modal-users')">&times;</button>
      <h2>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
      <div style="margin-bottom: 15px;">
        <input type="text" id="search-user-modal" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, username, Telegram ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É" onkeyup="searchUsersModal()">
      </div>
      <div id="all-users-list-modal" class="pending-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <button onclick="loadAllUsersModal()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
    </div>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
  <div id="modal-manage-user" class="grid-modal">
    <div class="grid-modal-content">
      <button class="close-grid-modal" onclick="closeModal('modal-manage-user')">&times;</button>
      <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h2>
      <div style="margin-bottom: 15px;">
        <input type="text" id="search-user-manage-modal" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ username, Telegram ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É" onkeyup="searchUserForManageModal()">
        <div id="user-search-results-modal" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #444; background: #112; border-radius: 8px; margin-top: 5px;"></div>
      </div>
      <input type="text" id="user-id-input-modal" placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" readonly>
      <input type="text" id="user-name-display-modal" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" readonly>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="number" id="add-points-modal" placeholder="–î–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏">
        <input type="number" id="remove-points-modal" placeholder="–£–±—Ä–∞—Ç—å –æ—á–∫–∏">
      </div>
      <select id="user-status-select-modal">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
        <option value="New">New - –ù–æ–≤—ã–π</option>
        <option value="pending">pending - –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
        <option value="approved">approved - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
        <option value="rejected">rejected - –û—Ç–∫–ª–æ–Ω–µ–Ω</option>
      </select>
      <div class="action-buttons" id="blacklist-buttons-modal" style="display: none;">
        <button id="add-to-blacklist-modal" onclick="addToBlacklistModal()" class="btn-blacklist-add" style="width: 100%; margin-top: 10px;">
          üö´ –î–æ–±–∞–≤–∏—Ç—å –≤ BlackList
        </button>
        <button id="remove-from-blacklist-modal" onclick="removeFromBlacklistModal()" class="btn-blacklist-remove" style="width: 100%; margin-top: 10px; display: none;">
          ‚úÖ –£–±—Ä–∞—Ç—å –∏–∑ BlackList
        </button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
        <button onclick="updateUserModal()" class="btn">–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <button onclick="refreshUserInfoModal()" class="btn" style="background: #17a2b8;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
      </div>
    </div>
  </div>

  <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
  <div id="modal-notifications" class="grid-modal">
    <div class="grid-modal-content">
      <button class="close-grid-modal" onclick="closeModal('modal-notifications')">&times;</button>
      <h2>üì® –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram</h2>
      <div style="margin-bottom: 15px;">
        <input type="text" id="notification-search-user-modal" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username –∏–ª–∏ ID" onkeyup="searchUserForNotificationModal()">
        <div id="notification-search-results-modal" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #444; background: #112; border-radius: 8px; margin-top: 5px;"></div>
      </div>
      <input type="text" id="notification-user-id-modal" placeholder="Telegram ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è" readonly>
      <input type="text" id="notification-user-name-modal" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è" readonly>
      <textarea id="notification-message-modal" placeholder="–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" rows="4"></textarea>
      <div style="margin: 10px 0; padding: 10px; background: rgba(212, 160, 23, 0.1); border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
          <input type="checkbox" id="notification-send-to-all-modal" onclick="toggleSendToAllModal()" style="width: auto;">
          <label for="notification-send-to-all-modal" style="margin: 0;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å Telegram ID</label>
        </div>
        <small style="color: #aaa; display: block; margin-top: 5px;">
          ‚ö†Ô∏è –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤—Å–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å Telegram ID (–ª—é–±–æ–π —Å—Ç–∞—Ç—É—Å)
        </small>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="sendTestNotificationModal()" class="btn" style="background: #17a2b8; flex: 1;">üìã –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
        <button onclick="sendNotificationModal()" class="btn" style="background: #9C27B0; flex: 2;">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
      </div>
      <div id="notification-status-modal" style="margin-top: 10px; text-align: center;"></div>
    </div>
  </div>

  <script>
    // === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
    const supabaseUrl = 'https://zuapiixwzkleygaijulx.supabase.co';
    const supabaseKey = 'sb_publishable_Jsth-2GViNz5Ev3UWtrWTg_fbg4GAKx';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const ADMIN_LOGIN = 'Admin';
    const ADMIN_PASS = '44mnUr8Xz';
    const TELEGRAM_BOT_TOKEN = '8533861323:AAGRcQP0OU2rdDr1KJX3MWTp97ecROWcEnw';

    function formatDateTimeInAlmaty(dateString) {
      const date = new Date(dateString);
      
      return new Intl.DateTimeFormat('ru-RU', {
        timeZone: 'Asia/Almaty',
        weekday: 'short',
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      }).format(date);
    }
    
    function isCheckinAvailable(eventTime) {
      const now = new Date();
      const eventTimeUTC = new Date(eventTime);
      const twoHoursAfter = new Date(eventTimeUTC.getTime() + (2 * 60 * 60 * 1000));
      
      return now <= twoHoursAfter;
    }
    
    function getCheckinWindowText(eventTime) {
      const now = new Date();
      const eventTimeUTC = new Date(eventTime);
      const twoHoursAfter = new Date(eventTimeUTC.getTime() + (2 * 60 * 60 * 1000));
      
      if (now > twoHoursAfter) {
        return '–ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç';
      } else {
        return '–ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω';
      }
    }
    
    function getEventStatus(eventTime) {
      const now = new Date();
      const eventTimeUTC = new Date(eventTime);
      const diff = eventTimeUTC - now;
      const twoHours = 2 * 60 * 60 * 1000;
      const threeHours = 3 * 60 * 60 * 1000;
      
      if (diff > twoHours) {
        return 'future';
      } else if (diff > 0) {
        return 'current';
      } else if (diff > -threeHours) {
        return 'current';
      } else {
        return 'past';
      }
    }
    
    function getEventStatusBadge(eventTime) {
      const status = getEventStatus(eventTime);
      const badges = {
        'future': { class: 'badge-future', text: '–ü—Ä–µ–¥—Å—Ç–æ—è—â–µ–µ' },
        'current': { class: 'badge-current', text: '–°–µ–π—á–∞—Å' },
        'past': { class: 'badge-past', text: '–ü—Ä–æ—à–µ–¥—à–µ–µ' }
      };
      return badges[status] || { class: '', text: '' };
    }

    // === –ü–æ–º–æ–≥–∞—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
    function showMsg(id, text, isError = false) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = text;
        el.style.color = isError ? '#ff6666' : '#88ff88';
      }
    }

    // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã—Ö —Å–µ–∫—Ü–∏–π ===
    function toggleSection(sectionHeader) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const sectionContent = sectionHeader.nextElementSibling;
      sectionContent.classList.toggle('collapsed');
      sectionHeader.classList.toggle('collapsed');
    }

    // === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ===
    function tryLogin() {
      const login = document.getElementById('admin-login')?.value?.trim();
      const pass = document.getElementById('admin-pass')?.value?.trim();

      if (!login || !pass) {
        showMsg('login-status', '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', true);
        return;
      }

      if (login === ADMIN_LOGIN && pass === ADMIN_PASS) {
        localStorage.setItem('adminLoggedIn', 'true');
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        showMsg('status', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å');
        
        // –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–µ–∫—Ü–∏–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ç–∫—É
        document.querySelectorAll('.section').forEach(section => {
          section.classList.add('hidden');
        });
        document.querySelector('.grid-section').classList.remove('hidden');
        
        loadStats();
        loadAllEvents();
        loadPending();
        loadAllUsers();
        loadRegistrations();
        loadEventsForFilter();
      } else {
        showMsg('login-status', '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', true);
      }
    }

    function logout() {
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
      document.querySelectorAll('.grid-modal').forEach(modal => {
        modal.style.display = 'none';
      });
      document.body.style.overflow = 'auto';
      
      localStorage.removeItem('adminLoggedIn');
      location.reload();
    }

    // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π ===
    function switchEventTab(tabName) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      document.querySelectorAll('.event-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.event-tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[onclick="switchEventTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-events`).classList.add('active');
    }

    // === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===
    async function loadStats() {
      try {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ UTC
        const nowUTC = new Date().toISOString();
        
        // 1. –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const { count: totalUsers } = await supabaseClient
          .from('users')
          .select('*', { count: 'exact', head: true });
        
        // 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º approved
        const { count: approvedUsers } = await supabaseClient
          .from('users')
          .select('*', { count: 'exact', head: true })
          .eq('membership_status', 'approved');
        
        // 3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π (–¥–∞—Ç–∞ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–π)
        const { count: pastEvents } = await supabaseClient
          .from('events')
          .select('*', { count: 'exact', head: true })
          .lt('match_date', nowUTC);
        
        // 4. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π (–¥–∞—Ç–∞ –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ —Ç–µ–∫—É—â–µ–π)
        const { count: upcomingEvents } = await supabaseClient
          .from('events')
          .select('*', { count: 'exact', head: true })
          .gte('match_date', nowUTC);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º DOM
        document.getElementById('total-users').textContent = totalUsers || 0;
        document.getElementById('approved-users').textContent = approvedUsers || 0;
        document.getElementById('past-events-count').textContent = pastEvents || 0;
        document.getElementById('upcoming-events-count').textContent = upcomingEvents || 0;
        
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // === –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ===
    async function searchUserForManage() {
      const searchTerm = document.getElementById('search-user-manage').value.trim();
      const resultsContainer = document.getElementById('user-search-results');
      
      if (searchTerm.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }
      
      try {
        // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —á–∏—Å–ª–æ–º (–¥–ª—è Telegram ID)
        const isNumericSearch = !isNaN(searchTerm) && searchTerm.trim() !== '';
        
        let query = supabaseClient
          .from('users')
          .select('id, full_name, username, telegram_id, phone, points, membership_status')
          .limit(10);
        
        if (isNumericSearch) {
          // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ, –∏—â–µ–º –ø–æ username, phone –∏ telegram_id
          query = query.or(`username.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,telegram_id.eq.${parseInt(searchTerm)}`);
        } else {
          // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—Å—Ç, –∏—â–µ–º —Ç–æ–ª—å–∫–æ –ø–æ username –∏ phone
          query = query.or(`username.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);
        }
        
        const { data, error } = await query;
        
        if (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
          resultsContainer.innerHTML = '<div style="padding: 10px; color: #ff6666; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
          resultsContainer.style.display = 'block';
          return;
        }
        
        if (!data || data.length === 0) {
          resultsContainer.innerHTML = '<div style="padding: 10px; color: #aaa; text-align: center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
          resultsContainer.style.display = 'block';
          return;
        }
        
        let html = '';
        data.forEach(user => {
          html += `
            <div class="search-result-item" 
                 onclick="selectUserForManage(${user.telegram_id}, '${user.username || '–ù–µ—Ç username'}', '${(user.full_name || '').replace(/'/g, "\\'")}')"
                 style="padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='rgba(3,70,148,0.3)'"
                 onmouseout="this.style.background='transparent'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong><br>
                  <small style="color: #aaa;">
                    @${user.username || '–Ω–µ—Ç username'} ‚Ä¢ ID: ${user.telegram_id} ‚Ä¢ ${user.phone || '–Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞'}
                  </small>
                </div>
                <div style="text-align: right;">
                  <span style="background: ${getStatusColor(user.membership_status)}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
                    ${user.membership_status}
                  </span><br>
                  <small style="color: #D4A017;">‚≠ê ${user.points || 0}</small>
                </div>
              </div>
            </div>
          `;
        });
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        resultsContainer.innerHTML = '<div style="padding: 10px; color: #ff6666; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
        resultsContainer.style.display = 'block';
      }
    }

    // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ ===
    function getStatusColor(status) {
      const colors = {
        'New': '#2196F3',
        'pending': '#FFC107',
        'approved': '#4CAF50',
        'rejected': '#F44336'
      };
      return colors[status] || '#9E9E9E';
    }

    // === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ BlackList –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    async function checkBlacklistStatus(telegramId) {
      try {
        const { data, error } = await supabaseClient
          .from('blacklisted_users')
          .select('*')
          .eq('telegram_id', telegramId)
          .maybeSingle();

        if (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ BlackList:', error);
          return null;
        }

        return data; // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ blacklisted_users –∏–ª–∏ null
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ BlackList:', error);
        return null;
      }
    }

    // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ BlackList ===
    async function updateBlacklistButtons(telegramId) {
      const blacklistButtons = document.getElementById('blacklist-buttons');
      const addToBlacklistBtn = document.getElementById('add-to-blacklist');
      const removeFromBlacklistBtn = document.getElementById('remove-from-blacklist');
      
      if (!telegramId) {
        blacklistButtons.style.display = 'none';
        return;
      }
      
      const blacklistData = await checkBlacklistStatus(telegramId);
      
      if (blacklistData) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ BlackList
        addToBlacklistBtn.style.display = 'none';
        removeFromBlacklistBtn.style.display = 'block';
        removeFromBlacklistBtn.innerHTML = `‚úÖ –£–±—Ä–∞—Ç—å –∏–∑ BlackList (–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${new Date(blacklistData.created_at).toLocaleDateString('ru-RU')}${blacklistData.reason ? ` - ${blacklistData.reason}` : ''})`;
      } else {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ BlackList
        addToBlacklistBtn.style.display = 'block';
        removeFromBlacklistBtn.style.display = 'none';
      }
      
      blacklistButtons.style.display = 'block';
    }

    // === –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ BlackList ===
    async function addToBlacklist() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const telegramIdInput = document.getElementById('user-id-input').value.trim();
      
      if (!telegramIdInput) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É
      const reason = prompt('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ BlackList (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º):');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ BlackList
      const existing = await checkBlacklistStatus(telegramId);
      if (existing) {
        alert('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ BlackList');
        return;
      }
      
      try {
        // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const { data: userData } = await supabaseClient
          .from('users')
          .select('username, full_name')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ BlackList
        const { error } = await supabaseClient
          .from('blacklisted_users')
          .insert({
            telegram_id: telegramId,
            reason: reason || null,
            banned_by: 'admin',
            created_at: new Date().toISOString()
          });
        
        if (error) throw error;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #dc3545;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-size: 0.9rem;
          border: 1px solid #ff4444;
        `;
        notification.innerHTML = `
          üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ BlackList<br>
          <small>${userData?.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: ${telegramId})</small><br>
          <small>${reason ? `–ü—Ä–∏—á–∏–Ω–∞: ${reason}` : '–ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã'}</small>
        `;
        document.body.appendChild(notification);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        updateBlacklistButtons(telegramId);
        
        // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 500);
        }, 4000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ BlackList:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ BlackList: ' + error.message);
      }
    }

    // === –£–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ BlackList ===
    async function removeFromBlacklist() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const telegramIdInput = document.getElementById('user-id-input').value.trim();
      
      if (!telegramIdInput) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–±—Ä–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ BlackList?')) {
        return;
      }
      
      try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const { data: userData } = await supabaseClient
          .from('users')
          .select('username, full_name')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ BlackList
        const { error } = await supabaseClient
          .from('blacklisted_users')
          .delete()
          .eq('telegram_id', telegramId);
        
        if (error) throw error;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #28a745;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-size: 0.9rem;
        `;
        notification.innerHTML = `
          ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–±—Ä–∞–Ω –∏–∑ BlackList<br>
          <small>${userData?.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: ${telegramId})</small>
        `;
        document.body.appendChild(notification);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        updateBlacklistButtons(telegramId);
        
        // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 500);
        }, 4000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ BlackList:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ BlackList: ' + error.message);
      }
    }

    // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ===
    async function refreshUserInfo() {
      const telegramIdInput = document.getElementById('user-id-input').value.trim();
      
      if (!telegramIdInput) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      try {
        // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const { data: userData, error } = await supabaseClient
          .from('users')
          .select('username, full_name, membership_status, points')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        if (error) {
          alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
          return;
        }
        
        if (!userData) {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('user-name-display').value = userData.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Å–µ–ª–µ–∫—Ç–µ
        document.getElementById('user-status-select').value = userData.membership_status || '';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ BlackList
        await updateBlacklistButtons(telegramId);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #17a2b8;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-size: 0.9rem;
        `;
        notification.innerHTML = `
          üîÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞<br>
          <small>${userData.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</small><br>
          <small>–°—Ç–∞—Ç—É—Å: ${userData.membership_status} | –û—á–∫–∏: ${userData.points || 0}</small>
        `;
        document.body.appendChild(notification);
        
        // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 500);
        }, 3000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: ' + error.message);
      }
    }

    // === –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ===
    function selectUserForManage(telegramId, username, fullName) {
      // –í—Å—Ç–∞–≤–ª—è–µ–º Telegram ID –≤ –ø–æ–ª–µ
      document.getElementById('user-id-input').value = telegramId;
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      document.getElementById('user-name-display').value = fullName || username || '';
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –∏ —Å–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      document.getElementById('search-user-manage').value = '';
      document.getElementById('user-search-results').style.display = 'none';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ BlackList
      updateBlacklistButtons(telegramId);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      showSelectionNotification(telegramId, username || fullName);
    }

    // === –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–±–æ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    function showSelectionNotification(telegramId, username) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--chelsea-blue);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 0.9rem;
        border: 1px solid var(--gold);
      `;
      notification.innerHTML = `
        ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω<br>
        <small>${username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: ${telegramId})</small>
      `;
      document.body.appendChild(notification);
      
      // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 500);
      }, 3000);
    }

    // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    async function updateUser() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const telegramIdInput = document.getElementById('user-id-input').value.trim();
      const addPoints = parseInt(document.getElementById('add-points').value) || 0;
      const removePoints = parseInt(document.getElementById('remove-points').value) || 0;
      const newStatus = document.getElementById('user-status-select').value;
      
      if (!telegramIdInput) {
        alert('–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      if (!addPoints && !removePoints && !newStatus) {
        alert('–£–∫–∞–∂–∏—Ç–µ —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å: –æ—á–∫–∏ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å');
        return;
      }
      
      try {
        const { data: userData, error: fetchError } = await supabaseClient
          .from('users')
          .select('id, points, username, full_name')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        if (fetchError) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + fetchError.message);
          return;
        }
        
        if (!userData) {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        const updates = {};
        const currentPoints = userData.points || 0;
        
        if (addPoints > 0 || removePoints > 0) {
          updates.points = currentPoints + addPoints - removePoints;
          if (updates.points < 0) updates.points = 0;
        }
        
        if (newStatus) {
          updates.membership_status = newStatus;
        }
        
        updates.updated_at = new Date().toISOString();
        
        const { error } = await supabaseClient
          .from('users')
          .update(updates)
          .eq('id', userData.id);
        
        if (error) throw error;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        showUpdateNotification(userData.username || userData.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', updates);
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        document.getElementById('user-id-input').value = '';
        document.getElementById('add-points').value = '';
        document.getElementById('remove-points').value = '';
        document.getElementById('user-status-select').value = '';
        document.getElementById('search-user-manage').value = '';
        document.getElementById('user-name-display').value = '';
        document.getElementById('blacklist-buttons').style.display = 'none';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
      }
    }

    // === –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ ===
    function showUpdateNotification(username, updates) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 0.9rem;
      `;
      
      let updateDetails = [];
      if (updates.points !== undefined) {
        updateDetails.push(`–æ—á–∫–∏: ${updates.points}`);
      }
      if (updates.membership_status) {
        const statusText = {
          'New': '–ù–æ–≤—ã–π',
          'pending': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
          'approved': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
          'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω'
        }[updates.membership_status] || updates.membership_status;
        updateDetails.push(`—Å—Ç–∞—Ç—É—Å: ${statusText}`);
      }
      
      notification.innerHTML = `
        ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!<br>
        <small>${username}</small><br>
        <small>${updateDetails.join(', ')}</small>
      `;
      document.body.appendChild(notification);
      
      // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 500);
      }, 4000);
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ ===
    async function loadEventsForFilter() {
      try {
        const { data, error } = await supabaseClient
          .from('events')
          .select('id, match_name, match_date')
          .order('match_date', { ascending: false });

        if (error) return;

        const filterSelect = document.getElementById('filter-event');
        filterSelect.innerHTML = '<option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>';
        
        data.forEach(event => {
          const formattedDate = formatDateTimeInAlmaty(event.match_date);
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = `${event.match_name} (${formattedDate})`;
          filterSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading events for filter:', error);
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–µ–π ===
    async function loadAllEvents() {
      try {
        const { data: events, error } = await supabaseClient
          .from('events')
          .select('*')
          .order('match_date', { ascending: false });

        if (error) {
          console.error('Error loading events:', error);
          showEmptyState('upcoming-events-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyState('current-events-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyState('past-events-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyState('all-events-list', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          return;
        }
        
        if (!events || events.length === 0) {
          showEmptyState('upcoming-events-list', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyState('current-events-list', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyState('past-events-list', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyState('all-events-list', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          return;
        }

        const now = new Date();
        const upcoming = [];
        const current = [];
        const past = [];
        
        for (const event of events) {
          const status = getEventStatus(event.match_date);
          
          // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ (registered + checked_in)
          const { data: registrationsData, error: regError } = await supabaseClient
            .from('registrations')
            .select('status')
            .eq('event_id', event.id);
          
          if (!regError && registrationsData) {
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (registered + checked_in)
            event.totalRegistrations = registrationsData.length;
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ checked_in
            event.checkedInCount = registrationsData.filter(reg => reg.status === 'checked_in').length;
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ registered (–±–µ–∑ checked_in)
            event.registeredCount = registrationsData.filter(reg => reg.status === 'registered').length;
          } else {
            event.totalRegistrations = 0;
            event.checkedInCount = 0;
            event.registeredCount = 0;
          }
          
          if (status === 'future') {
            upcoming.push(event);
          } else if (status === 'current') {
            current.push(event);
          } else {
            past.push(event);
          }
        }
        
        renderEvents('upcoming-events-list', upcoming, 'future');
        renderEvents('current-events-list', current, 'current');
        renderEvents('past-events-list', past, 'past');
        renderEvents('all-events-list', events, 'all');
        
      } catch (error) {
        console.error('Unexpected error loading events:', error);
      }
    }
    
    function showEmptyState(containerId, message) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <p>${message}</p>
        </div>
      `;
    }
    
    function renderEvents(containerId, events, category) {
      const container = document.getElementById(containerId);
      
      if (!events || events.length === 0) {
        const messages = {
          'future': '–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'current': '–ù–µ—Ç —Ç–µ–∫—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'past': '–ù–µ—Ç –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'all': '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç'
        };
        showEmptyState(containerId, messages[category] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
        return;
      }
      
      let html = '';
      
      events.forEach(event => {
        const formattedDate = formatDateTimeInAlmaty(event.match_date);
        const statusBadge = getEventStatusBadge(event.match_date);
        const isFull = event.max_participants && event.totalRegistrations >= event.max_participants;
        
        const itemClass = category === 'past' ? 'event-item past' : 
                         category === 'current' ? 'event-item current' : 'event-item';
        
        const checkinAvailable = isCheckinAvailable(event.match_date);
        
        html += `
          <div class="${itemClass}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 0;">
                <strong style="font-size: 1.1rem; display: block; margin-bottom: 5px;">${event.match_name}</strong>
                <div style="color: #aaa; font-size: 0.9rem;">
                  üìÖ ${formattedDate} (UTC+5, –ê–ª–º–∞—Ç—ã)<br>
                  üìç ${event.bar_address}
                </div>
              </div>
              <div style="text-align: right;">
                <span class="event-time-badge ${statusBadge.class}">${statusBadge.text}</span>
              </div>
            </div>
            
            <div style="margin-bottom: 10px; font-size: 0.9rem;">
              <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div>
                  <span style="color: #FFC107;">üë• ${event.totalRegistrations || 0} –∑–∞–ø–∏—Å–µ–π, ${event.checkedInCount || 0} Checked_in${event.max_participants ? ` (–º–∞–∫—Å: ${event.max_participants})` : ''}</span>
                  ${isFull ? '<span style="color: #f44336; margin-left: 10px;">(–ú–µ—Å—Ç –Ω–µ—Ç)</span>' : ''}
                </div>
                <div>
                  <span style="color: ${event.is_open ? '#4CAF50' : '#f44336'}">
                    ${event.is_open ? '‚úÖ –û—Ç–∫—Ä—ã—Ç–∞ –∑–∞–ø–∏—Å—å' : '‚ùå –ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞'}
                  </span>
                </div>
              </div>
              ${event.description ? `<div style="margin-top: 8px; color: #aaa; font-size: 0.85rem;">üìù ${event.description}</div>` : ''}
              <div style="margin-top: 8px; color: #D4A017; font-size: 0.85rem;">
                üèÜ –ë–∞–ª–ª–æ–≤ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ: ${event.points_award || 10}
              </div>
              <div style="margin-top: 8px; color: ${checkinAvailable ? '#4CAF50' : '#f44336'}; font-size: 0.85rem;">
                ${checkinAvailable ? '‚úÖ –ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç'}
              </div>
            </div>
            
            <div class="action-buttons">
              <button class="btn-qr" onclick="showEventQR('${event.id}', '${event.match_name.replace(/'/g, "\\'")}', '${event.match_date}')">
                üì± –ü–æ–∫–∞–∑–∞—Ç—å QR –¥–ª—è —á–µ–∫–∏–Ω–∞
              </button>
              <button class="btn-delete-event" onclick="deleteEvent('${event.id}', '${event.match_name.replace(/'/g, "\\'")}')">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // === –ü–æ–∫–∞–∑–∞—Ç—å QR –∫–æ–¥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ===
    function showEventQR(eventId, eventName, eventDate) {
      
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const modal = document.getElementById('qr-modal');
      const qrContainer = document.getElementById('qr-code-container');
      const eventInfo = document.getElementById('qr-event-info');
      
      qrContainer.innerHTML = '';
      eventInfo.innerHTML = '';
      
      const qrData = {
        e: eventId,
        t: Math.floor(Date.now() / 1000)
      };
      
      const formattedDate = formatDateTimeInAlmaty(eventDate);
      const checkinAvailable = isCheckinAvailable(eventDate);
      
      eventInfo.innerHTML = `
        <h4>${eventName}</h4>
        <p>üìÖ ${formattedDate} (UTC+5, –ê–ª–º–∞—Ç—ã)</p>
        <p>${checkinAvailable ? '‚úÖ –ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç'}</p>
      `;
      
      try {
        new QRCode(qrContainer, {
          text: JSON.stringify(qrData),
          width: 256,
          height: 256,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
        
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Error generating QR code:', error);
        qrContainer.innerHTML = `
          <div style="color: red; padding: 20px;">
            <p>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞:</p>
            <p>${error.message}</p>
          </div>
        `;
      }
    }
    
    function closeQRModal() {
      document.getElementById('qr-modal').style.display = 'none';
      document.getElementById('qr-code-container').innerHTML = '';
    }
    
    // === –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ===
    async function deleteEvent(eventId, eventName) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏!`)) {
        return;
      }
      
      try {
        const { error: registrationsError } = await supabaseClient
          .from('registrations')
          .delete()
          .eq('event_id', eventId);
        
        if (registrationsError) {
          console.error('Error deleting registrations:', registrationsError);
        }
        
        const { error } = await supabaseClient
          .from('events')
          .delete()
          .eq('id', eventId);
        
        if (error) throw error;
        
        alert(`‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!`);
        
        loadStats();
        loadAllEvents();
        loadRegistrations();
        loadEventsForFilter();
        
      } catch (error) {
        console.error('Error deleting event:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ' + error.message);
      }
    }

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ===
    async function loadRegistrations() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      try {
        let query = supabaseClient
          .from('registrations')
          .select(`
            id,
            status,
            checkin_time,
            created_at,
            users (
              id,
              full_name,
              username,
              telegram_id
            ),
            events (
              id,
              match_name,
              match_date,
              bar_address,
              points_award
            )
          `)
          .order('created_at', { ascending: false });

        const searchTerm = document.getElementById('search-registration').value.toLowerCase();
        const eventFilter = document.getElementById('filter-event').value;
        const statusFilter = document.getElementById('filter-status').value;

        if (eventFilter) {
          query = query.eq('event_id', eventFilter);
        }

        if (statusFilter) {
          // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä "participants" (—É—á–∞—Å—Ç–Ω–∏–∫–∏), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ registered –∏ checked_in
          if (statusFilter === 'participants') {
            query = query.in('status', ['registered', 'checked_in']);
          } else {
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–±—ã—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
            query = query.eq('status', statusFilter);
          }
        }

        const { data, error } = await query;

        const container = document.getElementById('registrations-list');
        
        if (error) {
          container.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
          return;
        }
        
        if (!data?.length) {
          container.innerHTML = '<p>–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
          return;
        }

        let filteredData = data;
        if (searchTerm) {
          filteredData = data.filter(reg => 
            reg.users?.full_name?.toLowerCase().includes(searchTerm) ||
            reg.users?.username?.toLowerCase().includes(searchTerm) ||
            reg.events?.match_name?.toLowerCase().includes(searchTerm)
          );
        }

        if (!filteredData.length) {
          container.innerHTML = '<p>–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –∑–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
          return;
        }

        renderRegistrations(filteredData);
        
      } catch (error) {
        console.error('Error loading registrations:', error);
        document.getElementById('registrations-list').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
      }
    }

    function renderRegistrations(registrations) {
      const container = document.getElementById('registrations-list');
      container.innerHTML = '';
      
      registrations.forEach(reg => {
        const user = reg.users;
        const event = reg.events;
        
        if (!user || !event) return;
        
        const formattedDate = formatDateTimeInAlmaty(event.match_date);
        
        const statusText = reg.status === 'registered' ? '–ó–∞–ø–∏—Å–∞–Ω' : 
                          reg.status === 'cancelled' ? '–û—Ç–º–µ–Ω–µ–Ω' : 
                          reg.status === 'checked_in' ? '–ü—Ä–æ—à–µ–ª —á–µ–∫–∏–Ω' : reg.status;
        
        const statusClass = reg.status === 'registered' ? 'status-registered' :
                           reg.status === 'cancelled' ? 'status-cancelled' :
                           'status-checked_in';
        
        const checkinAvailable = isCheckinAvailable(event.match_date);
        
        const registrationItem = document.createElement('div');
        registrationItem.className = 'registration-item';
        
        registrationItem.innerHTML = `
          <div class="registration-details">
            <div>
              <strong>üë§ ${user.full_name || '–ê–Ω–æ–Ω–∏–º'}</strong><br>
              <small>Telegram: @${user.username || '–Ω–µ—Ç'} (ID: ${user.telegram_id})</small><br>
              <small>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${user.id.substring(0, 8)}...</small>
            </div>
            <div>
              <strong>üé´ ${event.match_name}</strong><br>
              <small>üìÖ ${formattedDate} (UTC+5, –ê–ª–º–∞—Ç—ã)</small><br>
              <small>üìç ${event.bar_address}</small><br>
              <small>üèÜ –ë–∞–ª–ª–æ–≤ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ: ${event.points_award || 10}</small>
            </div>
          </div>
          
          <div style="margin-bottom: 10px;">
            <span class="status-badge ${statusClass}">${statusText}</span>
            <small style="color: #aaa; display: block; margin-top: 5px;">
              –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞: ${new Date(reg.created_at).toLocaleDateString('ru-RU')}
              ${reg.checkin_time ? `‚Ä¢ –û—Ç–º–µ—Ç–∫–∞: ${new Date(reg.checkin_time).toLocaleString('ru-RU')}` : ''}
            </small>
            <small style="color: ${checkinAvailable ? '#4CAF50' : '#f44336'}; display: block; margin-top: 5px;">
              ${checkinAvailable ? '‚úÖ –ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç'}
            </small>
          </div>
          
          <div class="action-buttons">
            ${reg.status === 'cancelled' ? `
              <button class="btn-approve" onclick="reRegisterUser('${reg.id}', '${user.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}', '${event.match_name}')">
                ‚Üª –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
              </button>
            ` : ''}
            
            <button class="btn-delete" onclick="deleteRegistration('${reg.id}', '${user.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}', '${event.match_name}')">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
            </button>
          </div>
        `;
        
        container.appendChild(registrationItem);
      });
    }

    // === –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ===
    async function createEvent() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const name = document.getElementById('match_name')?.value?.trim();
      const date = document.getElementById('match_date')?.value;
      const addr = document.getElementById('bar_address')?.value?.trim();
      const desc = document.getElementById('description')?.value?.trim() || null;
      const max = parseInt(document.getElementById('max_participants')?.value) || null;
      const pointsAward = parseInt(document.getElementById('points_award')?.value) || 10;
      const open = document.getElementById('is_open')?.checked ?? true;

      if (!name || !date || !addr) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç–∞ –∏ –∞–¥—Ä–µ—Å');
        return;
      }

      if (pointsAward < 0) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
        return;
      }

      const localDate = new Date(date);
      
      if (isNaN(localDate.getTime())) {
        alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞');
        return;
      }
      
      const { error } = await supabaseClient.from('events').insert({
        match_name: name,
        match_date: localDate.toISOString(),
        bar_address: addr,
        description: desc,
        max_participants: max,
        points_award: pointsAward,
        is_open: open
      });

      if (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      } else {
        alert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!');
        document.getElementById('match_name').value = '';
        document.getElementById('match_date').value = '';
        document.getElementById('bar_address').value = '';
        document.getElementById('description').value = '';
        document.getElementById('max_participants').value = '';
        document.getElementById('points_award').value = '10';
        document.getElementById('is_open').checked = true;
        
        loadAllEvents();
        loadStats();
        loadEventsForFilter();
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ Membership ===
    async function loadPending() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      try {
        const { data, error } = await supabaseClient
          .from('users')
          .select('id, full_name, username, email, created_at, points, telegram_id')
          .eq('membership_status', 'pending')
          .order('created_at', { ascending: true });

        const cont = document.getElementById('pending-list');
        
        if (error) {
          cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>';
          return;
        }
        
        if (!data?.length) {
          cont.innerHTML = '<p>–ó–∞—è–≤–æ–∫ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ –Ω–µ—Ç</p>';
          return;
        }

        cont.innerHTML = '';
        
        data.forEach(user => {
          const d = document.createElement('div');
          d.className = 'pending-item';
          d.innerHTML = `
            <div class="user-info">
              <div>
                <strong>üë§ ${user.full_name}</strong><br>
                <small>Telegram: @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small><br>
                <small>ID: ${user.id.substring(0, 8)}...</small>
              </div>
              <div>
                <small>üìß ${user.email || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small><br>
                <small>üìÖ ${new Date(user.created_at).toLocaleDateString('ru-RU')}</small><br>
                <small>‚≠ê –û—á–∫–æ–≤: ${user.points || 0}</small>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn-approve" onclick="approveApplication('${user.id}')">
                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å (+100 –æ—á–∫–æ–≤)
              </button>
              <button class="btn-reject" onclick="rejectApplication('${user.id}')">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
              </button>
            </div>
          `;
          cont.appendChild(d);
        });
      } catch (error) {
        console.error('Error loading pending applications:', error);
        document.getElementById('pending-list').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>';
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===
    async function loadAllUsers() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      try {
        const { data, error } = await supabaseClient
          .from('users')
          .select('id, full_name, username, telegram_id, phone, points, membership_status, created_at')
          .order('created_at', { ascending: false });

        const cont = document.getElementById('all-users-list');
        
        if (error) {
          cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
          return;
        }
        
        if (!data?.length) {
          cont.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</p>';
          return;
        }

        window.allUsers = data;
        renderUsers(data);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('all-users-list').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
      }
    }

    // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===
    function renderUsers(users) {
      const cont = document.getElementById('all-users-list');
      cont.innerHTML = '';
      
      users.forEach(user => {
        const statusColor = {
          'New': '#2196F3',
          'pending': '#FFC107',
          'approved': '#4CAF50',
          'rejected': '#F44336'
        }[user.membership_status] || '#9E9E9E';
        
        const statusText = {
          'New': '–ù–æ–≤—ã–π',
          'pending': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
          'approved': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
          'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω'
        }[user.membership_status] || user.membership_status;
        
        const d = document.createElement('div');
        d.className = 'event-item';
        d.style.borderLeftColor = statusColor;
        d.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="flex: 1;">
              <!-- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
              <div style="margin-bottom: 8px;">
                <strong style="font-size: 1.1rem;">üë§ ${user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong>
              </div>
              
              <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                <!-- Username -->
                <div>
                  <div style="color: #aaa; font-size: 0.8rem;">Username:</div>
                  <div style="font-weight: 500; word-break: break-all;">
                    @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
                  </div>
                </div>
                
                <!-- Telegram ID -->
                <div>
                  <div style="color: #aaa; font-size: 0.8rem;">Telegram ID:</div>
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-weight: 500;">${user.telegram_id || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                    ${user.telegram_id ? `<button onclick="copyTelegramId('${user.telegram_id}', '${user.full_name || user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}')" style="background: #2196F3; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 0.7rem; cursor: pointer; white-space: nowrap;">üìã</button>` : ''}
                  </div>
                </div>
                
                <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
                <div>
                  <div style="color: #aaa; font-size: 0.8rem;">–¢–µ–ª–µ—Ñ–æ–Ω:</div>
                  <div style="font-weight: 500;">${user.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                </div>
                
                <!-- –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                <div>
                  <div style="color: #aaa; font-size: 0.8rem;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</div>
                  <div style="font-weight: 500;">${new Date(user.created_at).toLocaleDateString('ru-RU')}</div>
                </div>
              </div>
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å –∏ –ø–æ–∏–Ω—Ç—ã -->
            <div style="text-align: right; min-width: 120px; margin-left: 15px;">
              <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; display: inline-block; margin-bottom: 10px;">
                ${statusText}
              </span>
              <br>
              <div style="font-size: 0.9rem; color: #aaa;">–û—á–∫–∏:</div>
              <strong style="font-size: 1.3rem; color: #D4A017;">‚≠ê ${user.points || 0}</strong>
            </div>
          </div>
        `;
        cont.appendChild(d);
      });
    }

    // === –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è Telegram ID ===
    function copyTelegramId(telegramId, userName) {
      navigator.clipboard.writeText(telegramId).then(() => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #4CAF50;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-size: 0.9rem;
        `;
        notification.innerHTML = `
          ‚úÖ Telegram ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!<br>
          <small>${userName}: ${telegramId}</small>
        `;
        document.body.appendChild(notification);
        
        // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 500);
        }, 3000);
      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Telegram ID. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + telegramId);
      });
    }

    // === –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ===
    function searchUsers() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const searchTerm = document.getElementById('search-user').value.toLowerCase();
      if (!window.allUsers) return;
      
      const filtered = window.allUsers.filter(user => 
        (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
        (user.username && user.username.toLowerCase().includes(searchTerm)) ||
        (user.telegram_id && user.telegram_id.toString().includes(searchTerm)) ||
        (user.phone && user.phone.toLowerCase().includes(searchTerm))
      );
      
      renderUsers(filtered);
    }
    
    // === –û–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ ===
    async function approveApplication(userId) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å 100 –±–æ–Ω—É—Å–Ω—ã—Ö –æ—á–∫–æ–≤?')) return;
      
      try {
        const { data: userData, error: fetchError } = await supabaseClient
          .from('users')
          .select('points')
          .eq('id', userId)
          .single();

        if (fetchError) throw fetchError;
        
        const currentPoints = userData.points || 0;
        const newPoints = currentPoints + 100;
        
        const { error: updateError } = await supabaseClient
          .from('users')
          .update({ 
            membership_status: 'approved',
            points: newPoints,
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (updateError) throw updateError;
        
        alert('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∞! +100 –æ—á–∫–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω—ã.');
        
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      }
    }

    // === –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ ===
    async function rejectApplication(userId) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('users')
          .update({ 
            membership_status: 'rejected',
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (error) throw error;
        
        alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.');
        
        loadPending();
        loadAllUsers();
        loadStats();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      }
    }

    // === –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    async function reRegisterUser(registrationId, userName, eventName) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"?`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'registered',
            checkin_time: null,
            updated_at: new Date().toISOString()
          })
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error re-registering user:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    // === –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ===
    async function deleteRegistration(registrationId, userName, eventName) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .delete()
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" —É–¥–∞–ª–µ–Ω–∞`);
        loadRegistrations();
        loadStats();
        
      } catch (error) {
        console.error('Error deleting registration:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –í TELEGRAM ===
    
    // === –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===
    async function searchUserForNotification() {
      const searchTerm = document.getElementById('notification-search-user').value.trim();
      const resultsContainer = document.getElementById('notification-search-results');
      
      if (searchTerm.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }
      
      try {
        const isNumericSearch = !isNaN(searchTerm) && searchTerm.trim() !== '';
        
        let query = supabaseClient
          .from('users')
          .select('id, full_name, username, telegram_id, phone, points, membership_status')
          .limit(10);
        
        if (isNumericSearch) {
          query = query.or(`username.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,telegram_id.eq.${parseInt(searchTerm)}`);
        } else {
          query = query.or(`username.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);
        }
        
        const { data, error } = await query;
        
        if (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
          resultsContainer.innerHTML = '<div style="padding: 10px; color: #ff6666; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
          resultsContainer.style.display = 'block';
          return;
        }
        
        if (!data || data.length === 0) {
          resultsContainer.innerHTML = '<div style="padding: 10px; color: #aaa; text-align: center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
          resultsContainer.style.display = 'block';
          return;
        }
        
        let html = '';
        data.forEach(user => {
          if (!user.telegram_id) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ Telegram ID
          
          html += `
            <div class="search-result-item" 
                 onclick="selectUserForNotification(${user.telegram_id}, '${user.username || '–ù–µ—Ç username'}', '${(user.full_name || '').replace(/'/g, "\\'")}')"
                 style="padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='rgba(156, 39, 176, 0.3)'"
                 onmouseout="this.style.background='transparent'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong><br>
                  <small style="color: #aaa;">
                    @${user.username || '–Ω–µ—Ç username'} ‚Ä¢ ID: ${user.telegram_id}
                  </small>
                </div>
                <div style="text-align: right;">
                  <span style="background: ${getStatusColor(user.membership_status)}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
                    ${user.membership_status}
                  </span><br>
                  <small style="color: #D4A017;">‚≠ê ${user.points || 0}</small>
                </div>
              </div>
            </div>
          `;
        });
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        resultsContainer.innerHTML = '<div style="padding: 10px; color: #ff6666; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
        resultsContainer.style.display = 'block';
      }
    }

    // === –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===
    function selectUserForNotification(telegramId, username, fullName) {
      document.getElementById('notification-user-id').value = telegramId;
      document.getElementById('notification-user-name').value = fullName || username || '';
      document.getElementById('notification-search-user').value = '';
      document.getElementById('notification-search-results').style.display = 'none';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–±–æ—Ä–µ
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #9C27B0;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 0.9rem;
      `;
      notification.innerHTML = `
        ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è<br>
        <small>${fullName || username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: ${telegramId})</small>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 500);
      }, 3000);
    }

    // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º" ===
    function toggleSendToAll() {
      const sendToAllCheckbox = document.getElementById('notification-send-to-all');
      const telegramIdInput = document.getElementById('notification-user-id');
      const userNameInput = document.getElementById('notification-user-name');
      const searchInput = document.getElementById('notification-search-user');
      
      if (sendToAllCheckbox.checked) {
        telegramIdInput.value = '–í–°–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú';
        telegramIdInput.style.background = '#9C27B0';
        telegramIdInput.style.color = 'white';
        userNameInput.value = '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å Telegram ID';
        userNameInput.style.background = '#9C27B0';
        userNameInput.style.color = 'white';
        searchInput.disabled = true;
        searchInput.placeholder = '–ü–æ–∏—Å–∫ –æ—Ç–∫–ª—é—á–µ–Ω (–æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º)';
        searchInput.style.background = '#555';
      } else {
        telegramIdInput.value = '';
        telegramIdInput.style.background = '';
        telegramIdInput.style.color = '';
        userNameInput.value = '';
        userNameInput.style.background = '';
        userNameInput.style.color = '';
        searchInput.disabled = false;
        searchInput.placeholder = 'üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username –∏–ª–∏ ID';
        searchInput.style.background = '';
      }
    }

    // === –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ===
    async function sendTestNotification() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const message = document.getElementById('notification-message').value.trim();
      const sendToAllCheckbox = document.getElementById('notification-send-to-all');
      const sendToAll = sendToAllCheckbox.checked;
      const telegramId = document.getElementById('notification-user-id').value;
      
      if (!sendToAll && (!telegramId || telegramId === '–í–°–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú')) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º"');
        return;
      }
      
      if (!message) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        return;
      }
      
      const testText = "üîî *–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞*\n\n" + message + "\n\n_–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ_";
      
      if (sendToAll) {
        // –î–ª—è —Ç–µ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–µ–±–µ
        const myTelegramId = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID –¥–ª—è —Ç–µ—Å—Ç–∞:");
        if (!myTelegramId) return;
        
        showNotificationStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
        
        try {
          const result = await sendTelegramMessage(myTelegramId, testText);
          
          if (result.success) {
            showNotificationStatus('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–∞–º! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.', 'success');
          } else {
            showNotificationStatus(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
          }
        } catch (error) {
          showNotificationStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
      } else {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        showNotificationStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
        
        try {
          const result = await sendTelegramMessage(telegramId, testText);
          
          if (result.success) {
            showNotificationStatus(`‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!`, 'success');
          } else {
            showNotificationStatus(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
          }
        } catch (error) {
          showNotificationStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
      }
    }

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===
    async function sendNotification() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const message = document.getElementById('notification-message').value.trim();
      const sendToAllCheckbox = document.getElementById('notification-send-to-all');
      const sendToAll = sendToAllCheckbox.checked;
      const telegramId = document.getElementById('notification-user-id').value;
      
      if (!sendToAll && (!telegramId || telegramId === '–í–°–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú')) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º"');
        return;
      }
      
      if (!message) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        return;
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
      const formattedMessage = "üîî *–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ Almablues*\n\n" + message + "";
      
      if (sendToAll) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å Telegram ID? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.`)) {
          return;
        }
        
        showNotificationStatus('üì§ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...', 'info');
        
        try {
          // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å telegram_id (–ª—é–±–æ–π —Å—Ç–∞—Ç—É—Å)
          const { data: users, error } = await supabaseClient
            .from('users')
            .select('telegram_id, full_name, username, membership_status')
            .not('telegram_id', 'is', null);
          
          if (error) throw error;
          
          if (!users || users.length === 0) {
            showNotificationStatus('‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å Telegram ID –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
            return;
          }
          
          showNotificationStatus(`üì§ –ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º...`, 'info');
          
          let successCount = 0;
          let errorCount = 0;
          let currentIndex = 0;
          const errors = [];
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
          for (const user of users) {
            currentIndex++;
            const progress = Math.round((currentIndex / users.length) * 100);
            showNotificationStatus(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${currentIndex}/${users.length} (${progress}%) - ${user.username || user.full_name}...`, 'info');
            
            try {
              const result = await sendTelegramMessage(user.telegram_id, formattedMessage);
              
              if (result.success) {
                successCount++;
                console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${user.username || user.full_name} (${user.telegram_id})`);
              } else {
                errorCount++;
                errors.push(`${user.username || user.full_name}: ${result.error}`);
                console.log(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${user.username || user.full_name}: ${result.error}`);
              }
            } catch (error) {
              errorCount++;
              errors.push(`${user.username || user.full_name}: ${error.message}`);
              console.log(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${user.username || user.full_name}: ${error.message}`);
            }
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã Telegram API (30 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É)
            await new Promise(resolve => setTimeout(resolve, 50));
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          let resultMessage = `‚úÖ –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!<br>`;
          resultMessage += `–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${successCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>`;
          resultMessage += `–° –æ—à–∏–±–∫–∞–º–∏: ${errorCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>`;
          
          if (errors.length > 0) {
            resultMessage += `<br><small>–û—Å–Ω–æ–≤–Ω—ã–µ –æ—à–∏–±–∫–∏:<br>`;
            errors.slice(0, 5).forEach(err => {
              resultMessage += `‚Ä¢ ${err}<br>`;
            });
            if (errors.length > 5) {
              resultMessage += `... –∏ –µ—â–µ ${errors.length - 5} –æ—à–∏–±–æ–∫`;
            }
            resultMessage += `</small>`;
          }
          
          showNotificationStatus(resultMessage, successCount > 0 ? 'success' : 'error');
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏
          await saveNotificationLog({
            type: 'mass',
            message: message,
            sent_count: successCount,
            failed_count: errorCount,
            total_users: users.length
          });
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
          showNotificationStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
      } else {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        showNotificationStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
        
        try {
          const result = await sendTelegramMessage(telegramId, formattedMessage);
          
          if (result.success) {
            showNotificationStatus(`‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!`, 'success');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏
            await saveNotificationLog({
              type: 'single',
              message: message,
              telegram_id: telegramId,
              user_name: document.getElementById('notification-user-name').value
            });
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('notification-message').value = '';
          } else {
            showNotificationStatus(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
          }
        } catch (error) {
          showNotificationStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
      }
    }

    // === –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram API ===
    async function sendTelegramMessage(chatId, text) {
      try {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chat_id: chatId,
            text: text,
            parse_mode: 'Markdown'
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          return { success: true, data: data };
        } else {
          return { 
            success: false, 
            error: data.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ Telegram API'
          };
        }
      } catch (error) {
        return { 
          success: false, 
          error: error.message || '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'
        };
      }
    }

    // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ===
    async function saveNotificationLog(logData) {
      try {
        const { error } = await supabaseClient
          .from('notification_logs')
          .insert({
            ...logData,
            sent_by: 'admin',
            sent_at: new Date().toISOString()
          });
        
        if (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–∞:', error);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ª–æ–≥–∞:', error);
      }
    }

    // === –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===
    function showNotificationStatus(message, type = 'info') {
      const statusEl = document.getElementById('notification-status');
      const colors = {
        'info': '#2196F3',
        'success': '#4CAF50',
        'error': '#f44336',
        'warning': '#FF9800'
      };
      
      statusEl.innerHTML = message;
      statusEl.style.color = colors[type] || colors.info;
      statusEl.style.fontWeight = '500';
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ (–∫—Ä–æ–º–µ info)
      if (type !== 'info') {
        setTimeout(() => {
          statusEl.innerHTML = '';
        }, 10000);
      }
    }

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    document.addEventListener('DOMContentLoaded', () => {
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã—Ö —Å–µ–∫—Ü–∏–π
      document.querySelectorAll('.collapsible-section').forEach(header => {
        header.addEventListener('click', function() {
          toggleSection(this);
        });
      });

      // –ê–≤—Ç–æ–≤—Ö–æ–¥ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–µ—Å—Å–∏–∏
      if (localStorage.getItem('adminLoggedIn') === 'true') {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('hidden');
        showMsg('status', '‚úÖ –ê–≤—Ç–æ–≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ç–∫—É –∫–≤–∞–¥—Ä–∞—Ç–æ–≤
        document.querySelector('.grid-section').classList.remove('hidden');
        
        loadStats();
        loadAllEvents();
        loadPending();
        loadAllUsers();
        loadRegistrations();
        loadEventsForFilter();
      } else {
        document.getElementById('admin-content').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
      }
    });

    // –°–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', function(event) {
      const searchResults = document.getElementById('user-search-results');
      const searchInput = document.getElementById('search-user-manage');
      const notificationResults = document.getElementById('notification-search-results');
      const notificationInput = document.getElementById('notification-search-user');
      
      if (searchResults && searchResults.style.display === 'block' &&
          !searchResults.contains(event.target) &&
          !searchInput.contains(event.target)) {
        searchResults.style.display = 'none';
      }
      
      if (notificationResults && notificationResults.style.display === 'block' &&
          !notificationResults.contains(event.target) &&
          !notificationInput.contains(event.target)) {
        notificationResults.style.display = 'none';
      }
    });

    // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ —Å–µ—Ç–∫–∏ ===
    function openModal(modalId) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        
        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        switch(modalId) {
          case 'modal-stats':
            loadStats();
            break;
          case 'modal-registrations':
            loadRegistrations();
            loadEventsForFilter();
            break;
          case 'modal-events':
            loadAllEvents();
            break;
          case 'modal-pending':
            loadPending();
            break;
          case 'modal-users':
            loadAllUsers();
            break;
        }
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
        document.body.style.overflow = 'auto';
      }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('grid-modal')) {
        event.target.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∞–≤–∏—à–µ Escape
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        document.querySelectorAll('.grid-modal').forEach(modal => {
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
        });
      }
    });

    // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ (–º–æ–¥–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏) ===
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
// === –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ===
async function loadStatsModal() {
    try {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ UTC
        const nowUTC = new Date().toISOString();
        
        // 1. –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const { count: totalUsers } = await supabaseClient
            .from('users')
            .select('*', { count: 'exact', head: true });
        
        // 2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º approved
        const { count: approvedUsers } = await supabaseClient
            .from('users')
            .select('*', { count: 'exact', head: true })
            .eq('membership_status', 'approved');
        
        // 3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π (–¥–∞—Ç–∞ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–π)
        const { count: pastEvents } = await supabaseClient
            .from('events')
            .select('*', { count: 'exact', head: true })
            .lt('match_date', nowUTC);
        
        // 4. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π (–¥–∞—Ç–∞ –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ —Ç–µ–∫—É—â–µ–π)
        const { count: upcomingEvents } = await supabaseClient
            .from('events')
            .select('*', { count: 'exact', head: true })
            .gte('match_date', nowUTC);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º DOM –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        const container = document.getElementById('stats-section');
        if (container) {
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-number">${pastEvents || 0}</div>
                    <div class="stat-label">–ü—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üöÄ</div>
                    <div class="stat-number">${upcomingEvents || 0}</div>
                    <div class="stat-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-number">${totalUsers || 0}</div>
                    <div class="stat-label">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-number">${approvedUsers || 0}</div>
                    <div class="stat-label">Membership's (approved)</div>
                </div>
            `;
        }
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–µ—Å–ª–∏ –æ–Ω–∞ –≤–∏–¥–Ω–∞)
        document.getElementById('total-users').textContent = totalUsers || 0;
        document.getElementById('approved-users').textContent = approvedUsers || 0;
        document.getElementById('past-events-count').textContent = pastEvents || 0;
        document.getElementById('upcoming-events-count').textContent = upcomingEvents || 0;
        
    } catch (error) {
        console.error('Error loading stats for modal:', error);
        const container = document.getElementById('stats-section');
        if (container) {
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                </div>
            `;
        }
    }
}
    // –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    async function createEventModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const name = document.getElementById('match_name-modal')?.value?.trim();
      const date = document.getElementById('match_date-modal')?.value;
      const addr = document.getElementById('bar_address-modal')?.value?.trim();
      const desc = document.getElementById('description-modal')?.value?.trim() || null;
      const max = parseInt(document.getElementById('max_participants-modal')?.value) || null;
      const pointsAward = parseInt(document.getElementById('points_award-modal')?.value) || 10;
      const open = true;

      if (!name || !date || !addr) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç–∞ –∏ –∞–¥—Ä–µ—Å');
        return;
      }

      if (pointsAward < 0) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
        return;
      }

      const localDate = new Date(date);
      
      if (isNaN(localDate.getTime())) {
        alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞');
        return;
      }
      
      const { error } = await supabaseClient.from('events').insert({
        match_name: name,
        match_date: localDate.toISOString(),
        bar_address: addr,
        description: desc,
        max_participants: max,
        points_award: pointsAward,
        is_open: open
      });

      if (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      } else {
        alert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!');
        document.getElementById('match_name-modal').value = '';
        document.getElementById('match_date-modal').value = '';
        document.getElementById('bar_address-modal').value = '';
        document.getElementById('description-modal').value = '';
        document.getElementById('max_participants-modal').value = '';
        document.getElementById('points_award-modal').value = '10';
        
        loadAllEventsModal();
        loadStatsModal();
      }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏
    async function loadRegistrationsModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      try {
        let query = supabaseClient
          .from('registrations')
          .select(`
            id,
            status,
            checkin_time,
            created_at,
            users (
              id,
              full_name,
              username,
              telegram_id
            ),
            events (
              id,
              match_name,
              match_date,
              bar_address,
              points_award
            )
          `)
          .order('created_at', { ascending: false });

        const searchTerm = document.getElementById('search-registration-modal').value.toLowerCase();
        const eventFilter = document.getElementById('filter-event-modal').value;
        const statusFilter = document.getElementById('filter-status-modal').value;

        if (eventFilter) {
          query = query.eq('event_id', eventFilter);
        }

        if (statusFilter) {
          if (statusFilter === 'participants') {
            query = query.in('status', ['registered', 'checked_in']);
          } else {
            query = query.eq('status', statusFilter);
          }
        }

        const { data, error } = await query;

        const container = document.getElementById('registrations-list-modal');
        
        if (error) {
          container.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
          return;
        }
        
        if (!data?.length) {
          container.innerHTML = '<p>–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
          return;
        }

        let filteredData = data;
        if (searchTerm) {
          filteredData = data.filter(reg =>
            reg.users?.full_name?.toLowerCase().includes(searchTerm) ||
            reg.users?.username?.toLowerCase().includes(searchTerm) ||
            reg.events?.match_name?.toLowerCase().includes(searchTerm)
          );
        }

        if (!filteredData.length) {
          container.innerHTML = '<p>–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –∑–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
          return;
        }

        renderRegistrationsModal(filteredData);
        
      } catch (error) {
        console.error('Error loading registrations:', error);
        document.getElementById('registrations-list-modal').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
      }
    }

    function renderRegistrationsModal(registrations) {
      const container = document.getElementById('registrations-list-modal');
      container.innerHTML = '';
      
      registrations.forEach(reg => {
        const user = reg.users;
        const event = reg.events;
        
        if (!user || !event) return;
        
        const formattedDate = formatDateTimeInAlmaty(event.match_date);
        
        const statusText = reg.status === 'registered' ? '–ó–∞–ø–∏—Å–∞–Ω' :
                          reg.status === 'cancelled' ? '–û—Ç–º–µ–Ω–µ–Ω' :
                          reg.status === 'checked_in' ? '–ü—Ä–æ—à–µ–ª —á–µ–∫–∏–Ω' : reg.status;
        
        const statusClass = reg.status === 'registered' ? 'status-registered' :
                           reg.status === 'cancelled' ? 'status-cancelled' :
                           'status-checked_in';
        
        const checkinAvailable = isCheckinAvailable(event.match_date);
        
        const registrationItem = document.createElement('div');
        registrationItem.className = 'registration-item';
        
        registrationItem.innerHTML = `
          <div class="registration-details">
            <div>
              <strong>üë§ ${user.full_name || '–ê–Ω–æ–Ω–∏–º'}</strong><br>
              <small>Telegram: @${user.username || '–Ω–µ—Ç'} (ID: ${user.telegram_id})</small><br>
              <small>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${user.id.substring(0, 8)}...</small>
            </div>
            <div>
              <strong>üé´ ${event.match_name}</strong><br>
              <small>üìÖ ${formattedDate} (UTC+5, –ê–ª–º–∞—Ç—ã)</small><br>
              <small>üìç ${event.bar_address}</small><br>
              <small>üèÜ –ë–∞–ª–ª–æ–≤ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ: ${event.points_award || 10}</small>
            </div>
          </div>
          <div style="margin-bottom: 10px;">
            <span class="status-badge ${statusClass}">${statusText}</span>
            <small style="color: #aaa; display: block; margin-top: 5px;">
              –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞: ${new Date(reg.created_at).toLocaleDateString('ru-RU')}
              ${reg.checkin_time ? `‚Ä¢ –û—Ç–º–µ—Ç–∫–∞: ${new Date(reg.checkin_time).toLocaleString('ru-RU')}` : ''}
            </small>
            <small style="color: ${checkinAvailable ? '#4CAF50' : '#f44336'}; display: block; margin-top: 5px;">
              ${checkinAvailable ? '‚úÖ –ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç'}
            </small>
          </div>
          <div class="action-buttons">
            ${reg.status === 'cancelled' ? `
              <button class="btn-approve" onclick="reRegisterUserModal('${reg.id}', '${user.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}', '${event.match_name}')">
                ‚Üª –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
              </button>
            ` : ''}
            <button class="btn-delete" onclick="deleteRegistrationModal('${reg.id}', '${user.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}', '${event.match_name}')">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
            </button>
          </div>
        `;
        
        container.appendChild(registrationItem);
      });
    }

    // –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
    async function loadAllEventsModal() {
      try {
        const { data: events, error } = await supabaseClient
          .from('events')
          .select('*')
          .order('match_date', { ascending: false });

        if (error) {
          console.error('Error loading events:', error);
          showEmptyStateModal('upcoming-events-list-modal', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyStateModal('current-events-list-modal', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyStateModal('past-events-list-modal', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          showEmptyStateModal('all-events-list-modal', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
          return;
        }
        
        if (!events || events.length === 0) {
          showEmptyStateModal('upcoming-events-list-modal', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyStateModal('current-events-list-modal', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyStateModal('past-events-list-modal', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          showEmptyStateModal('all-events-list-modal', '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç');
          return;
        }

        const now = new Date();
        const upcoming = [];
        const current = [];
        const past = [];
        
        for (const event of events) {
          const status = getEventStatus(event.match_date);
          
          const { data: registrationsData, error: regError } = await supabaseClient
            .from('registrations')
            .select('status')
            .eq('event_id', event.id);
          
          if (!regError && registrationsData) {
            event.totalRegistrations = registrationsData.length;
            event.checkedInCount = registrationsData.filter(reg => reg.status === 'checked_in').length;
            event.registeredCount = registrationsData.filter(reg => reg.status === 'registered').length;
          } else {
            event.totalRegistrations = 0;
            event.checkedInCount = 0;
            event.registeredCount = 0;
          }
          
          if (status === 'future') {
            upcoming.push(event);
          } else if (status === 'current') {
            current.push(event);
          } else {
            past.push(event);
          }
        }
        
        renderEventsModal('upcoming-events-list-modal', upcoming, 'future');
        renderEventsModal('current-events-list-modal', current, 'current');
        renderEventsModal('past-events-list-modal', past, 'past');
        renderEventsModal('all-events-list-modal', events, 'all');
        
      } catch (error) {
        console.error('Unexpected error loading events:', error);
      }
    }
    
    function showEmptyStateModal(containerId, message) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <p>${message}</p>
        </div>
      `;
    }
    
    function renderEventsModal(containerId, events, category) {
      const container = document.getElementById(containerId);
      
      if (!events || events.length === 0) {
        const messages = {
          'future': '–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'current': '–ù–µ—Ç —Ç–µ–∫—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'past': '–ù–µ—Ç –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π',
          'all': '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ—Ç'
        };
        showEmptyStateModal(containerId, messages[category] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
        return;
      }
      
      let html = '';
      
      events.forEach(event => {
        const formattedDate = formatDateTimeInAlmaty(event.match_date);
        const statusBadge = getEventStatusBadge(event.match_date);
        const isFull = event.max_participants && event.totalRegistrations >= event.max_participants;
        
        const itemClass = category === 'past' ? 'event-item past' :
                         category === 'current' ? 'event-item current' : 'event-item';
        
        const checkinAvailable = isCheckinAvailable(event.match_date);
        
        html += `
          <div class="${itemClass}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 0;">
                <strong style="font-size: 1.1rem; display: block; margin-bottom: 5px;">${event.match_name}</strong>
                <div style="color: #aaa; font-size: 0.9rem;">
                  üìÖ ${formattedDate} (UTC+5, –ê–ª–º–∞—Ç—ã)<br>
                  üìç ${event.bar_address}
                </div>
              </div>
              <div style="text-align: right;">
                <span class="event-time-badge ${statusBadge.class}">${statusBadge.text}</span>
              </div>
            </div>
            
            <div style="margin-bottom: 10px; font-size: 0.9rem;">
              <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div>
                  <span style="color: #FFC107;">üë• ${event.totalRegistrations || 0} –∑–∞–ø–∏—Å–µ–π, ${event.checkedInCount || 0} Checked_in${event.max_participants ? ` (–º–∞–∫—Å: ${event.max_participants})` : ''}</span>
                  ${isFull ? '<span style="color: #f44336; margin-left: 10px;">(–ú–µ—Å—Ç –Ω–µ—Ç)</span>' : ''}
                </div>
                <div>
                  <span style="color: ${event.is_open ? '#4CAF50' : '#f44336'}">
                    ${event.is_open ? '‚úÖ –û—Ç–∫—Ä—ã—Ç–∞ –∑–∞–ø–∏—Å—å' : '‚ùå –ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞'}
                  </span>
                </div>
              </div>
              ${event.description ? `<div style="margin-top: 8px; color: #aaa; font-size: 0.85rem;">üìù ${event.description}</div>` : ''}
              <div style="margin-top: 8px; color: #D4A017; font-size: 0.85rem;">
                üèÜ –ë–∞–ª–ª–æ–≤ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ: ${event.points_award || 10}
              </div>
              <div style="margin-top: 8px; color: ${checkinAvailable ? '#4CAF50' : '#f44336'}; font-size: 0.85rem;">
                ${checkinAvailable ? '‚úÖ –ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç'}
              </div>
            </div>
            
            <div class="action-buttons">
              <button class="btn-qr" onclick="showEventQR('${event.id}', '${event.match_name.replace(/'/g, "\\'")}', '${event.match_date}')">
                üì± –ü–æ–∫–∞–∑–∞—Ç—å QR –¥–ª—è —á–µ–∫–∏–Ω–∞
              </button>
              <button class="btn-delete-event" onclick="deleteEventModal('${event.id}', '${event.match_name.replace(/'/g, "\\'")}')">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // –ó–∞—è–≤–∫–∏ –Ω–∞ Membership
    async function loadPendingModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      try {
        const { data, error } = await supabaseClient
          .from('users')
          .select('id, full_name, username, email, created_at, points, telegram_id')
          .eq('membership_status', 'pending')
          .order('created_at', { ascending: true });

        const cont = document.getElementById('pending-list-modal');
        
        if (error) {
          cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>';
          return;
        }
        
        if (!data?.length) {
          cont.innerHTML = '<p>–ó–∞—è–≤–æ–∫ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ –Ω–µ—Ç</p>';
          return;
        }

        cont.innerHTML = '';
        
        data.forEach(user => {
          const d = document.createElement('div');
          d.className = 'pending-item';
          d.innerHTML = `
            <div class="user-info">
              <div>
                <strong>üë§ ${user.full_name}</strong><br>
                <small>Telegram: @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small><br>
                <small>ID: ${user.id.substring(0, 8)}...</small>
              </div>
              <div>
                <small>üìß ${user.email || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small><br>
                <small>üìÖ ${new Date(user.created_at).toLocaleDateString('ru-RU')}</small><br>
                <small>‚≠ê –û—á–∫–æ–≤: ${user.points || 0}</small>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn-approve" onclick="approveApplicationModal('${user.id}')">
                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å (+100 –æ—á–∫–æ–≤)
              </button>
              <button class="btn-reject" onclick="rejectApplicationModal('${user.id}')">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
              </button>
            </div>
          `;
          cont.appendChild(d);
        });
      } catch (error) {
        console.error('Error loading pending applications:', error);
        document.getElementById('pending-list-modal').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>';
      }
    }

    // –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    async function loadAllUsersModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      try {
        const { data, error } = await supabaseClient
          .from('users')
          .select('id, full_name, username, telegram_id, phone, points, membership_status, created_at')
          .order('created_at', { ascending: false });

        const cont = document.getElementById('all-users-list-modal');
        
        if (error) {
          cont.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
          return;
        }
        
        if (!data?.length) {
          cont.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</p>';
          return;
        }

        window.allUsersModal = data;
        renderUsersModal(data);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('all-users-list-modal').innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
      }
    }

    function renderUsersModal(users) {
      const cont = document.getElementById('all-users-list-modal');
      cont.innerHTML = '';
      
      users.forEach(user => {
        const statusColor = {
          'New': '#2196F3',
          'pending': '#FFC107',
          'approved': '#4CAF50',
          'rejected': '#F44336'
        }[user.membership_status] || '#9E9E9E';
        
        const statusText = {
          'New': '–ù–æ–≤—ã–π',
          'pending': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
          'approved': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
          'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω'
        }[user.membership_status] || user.membership_status;
        
        const d = document.createElement('div');
        d.className = 'event-item';
        d.style.borderLeftColor = statusColor;
        d.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="flex: 1;">
              <div style="margin-bottom: 8px;">
                <strong style="font-size: 1.1rem;">üë§ ${user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                <div>
                  <div style="color: #aaa; font-size: 0.8rem;">Username:</div>
                  <div style="font-weight: 500; word-break: break-all;">
                    @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
                  </div>
                </div>
                <div>
                  <div style="color: #aaa; font-size: 0.8rem;">Telegram ID:</div>
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-weight: 500;">${user.telegram_id || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                    ${user.telegram_id ? `<button onclick="copyTelegramIdModal('${user.telegram_id}', '${user.full_name || user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}')" style="background: #2196F3; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 0.7rem; cursor: pointer; white-space: nowrap;">üìã</button>` : ''}
                  </div>
                </div>
                <div>
                  <div style="color: #aaa; font-size: 0.8rem;">–¢–µ–ª–µ—Ñ–æ–Ω:</div>
                  <div style="font-weight: 500;">${user.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                </div>
                <div>
                  <div style="color: #aaa; font-size: 0.8rem;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</div>
                  <div style="font-weight: 500;">${new Date(user.created_at).toLocaleDateString('ru-RU')}</div>
                </div>
              </div>
            </div>
            <div style="text-align: right; min-width: 120px; margin-left: 15px;">
              <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; display: inline-block; margin-bottom: 10px;">
                ${statusText}
              </span>
              <br>
              <div style="font-size: 0.9rem; color: #aaa;">–û—á–∫–∏:</div>
              <strong style="font-size: 1.3rem; color: #D4A017;">‚≠ê ${user.points || 0}</strong>
            </div>
          </div>
        `;
        cont.appendChild(d);
      });
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    async function searchUserForManageModal() {
      const searchTerm = document.getElementById('search-user-manage-modal').value.trim();
      const resultsContainer = document.getElementById('user-search-results-modal');
      
      if (searchTerm.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }
      
      try {
        const isNumericSearch = !isNaN(searchTerm) && searchTerm.trim() !== '';
        
        let query = supabaseClient
          .from('users')
          .select('id, full_name, username, telegram_id, phone, points, membership_status')
          .limit(10);
        
        if (isNumericSearch) {
          query = query.or(`username.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,telegram_id.eq.${parseInt(searchTerm)}`);
        } else {
          query = query.or(`username.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);
        }
        
        const { data, error } = await query;
        
        if (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
          resultsContainer.innerHTML = '<div style="padding: 10px; color: #ff6666; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
          resultsContainer.style.display = 'block';
          return;
        }
        
        if (!data || data.length === 0) {
          resultsContainer.innerHTML = '<div style="padding: 10px; color: #aaa; text-align: center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
          resultsContainer.style.display = 'block';
          return;
        }
        
        let html = '';
        data.forEach(user => {
          html += `
            <div class="search-result-item"
                 onclick="selectUserForManageModal(${user.telegram_id}, '${user.username || '–ù–µ—Ç username'}', '${(user.full_name || '').replace(/'/g, "\\'")}')"
                 style="padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='rgba(3,70,148,0.3)'"
                 onmouseout="this.style.background='transparent'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong><br>
                  <small style="color: #aaa;">
                    @${user.username || '–Ω–µ—Ç username'} ‚Ä¢ ID: ${user.telegram_id} ‚Ä¢ ${user.phone || '–Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞'}
                  </small>
                </div>
                <div style="text-align: right;">
                  <span style="background: ${getStatusColor(user.membership_status)}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
                    ${user.membership_status}
                  </span><br>
                  <small style="color: #D4A017;">‚≠ê ${user.points || 0}</small>
                </div>
              </div>
            </div>
          `;
        });
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        resultsContainer.innerHTML = '<div style="padding: 10px; color: #ff6666; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
        resultsContainer.style.display = 'block';
      }
    }

    function selectUserForManageModal(telegramId, username, fullName) {
      document.getElementById('user-id-input-modal').value = telegramId;
      document.getElementById('user-name-display-modal').value = fullName || username || '';
      document.getElementById('search-user-manage-modal').value = '';
      document.getElementById('user-search-results-modal').style.display = 'none';
      
      updateBlacklistButtonsModal(telegramId);
      
      showSelectionNotificationModal(telegramId, username || fullName);
    }

    async function updateBlacklistButtonsModal(telegramId) {
      const blacklistButtons = document.getElementById('blacklist-buttons-modal');
      const addToBlacklistBtn = document.getElementById('add-to-blacklist-modal');
      const removeFromBlacklistBtn = document.getElementById('remove-from-blacklist-modal');
      
      if (!telegramId) {
        blacklistButtons.style.display = 'none';
        return;
      }
      
      const blacklistData = await checkBlacklistStatus(telegramId);
      
      if (blacklistData) {
        addToBlacklistBtn.style.display = 'none';
        removeFromBlacklistBtn.style.display = 'block';
        removeFromBlacklistBtn.innerHTML = `‚úÖ –£–±—Ä–∞—Ç—å –∏–∑ BlackList (–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${new Date(blacklistData.created_at).toLocaleDateString('ru-RU')}${blacklistData.reason ? ` - ${blacklistData.reason}` : ''})`;
      } else {
        addToBlacklistBtn.style.display = 'block';
        removeFromBlacklistBtn.style.display = 'none';
      }
      
      blacklistButtons.style.display = 'block';
    }

    async function addToBlacklistModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const telegramIdInput = document.getElementById('user-id-input-modal').value.trim();
      
      if (!telegramIdInput) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      const reason = prompt('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ BlackList (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º):');
      
      const existing = await checkBlacklistStatus(telegramId);
      if (existing) {
        alert('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ BlackList');
        return;
      }
      
      try {
        const { data: userData } = await supabaseClient
          .from('users')
          .select('username, full_name')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        const { error } = await supabaseClient
          .from('blacklisted_users')
          .insert({
            telegram_id: telegramId,
            reason: reason || null,
            banned_by: 'admin',
            created_at: new Date().toISOString()
          });
        
        if (error) throw error;
        
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #dc3545;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-size: 0.9rem;
          border: 1px solid #ff4444;
        `;
        notification.innerHTML = `
          üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ BlackList<br>
          <small>${userData?.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: ${telegramId})</small><br>
          <small>${reason ? `–ü—Ä–∏—á–∏–Ω–∞: ${reason}` : '–ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã'}</small>
        `;
        document.body.appendChild(notification);
        
        updateBlacklistButtonsModal(telegramId);
        
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 500);
        }, 4000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ BlackList:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ BlackList: ' + error.message);
      }
    }

    async function removeFromBlacklistModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const telegramIdInput = document.getElementById('user-id-input-modal').value.trim();
      
      if (!telegramIdInput) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–±—Ä–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ BlackList?')) {
        return;
      }
      
      try {
        const { data: userData } = await supabaseClient
          .from('users')
          .select('username, full_name')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        const { error } = await supabaseClient
          .from('blacklisted_users')
          .delete()
          .eq('telegram_id', telegramId);
        
        if (error) throw error;
        
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #28a745;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-size: 0.9rem;
        `;
        notification.innerHTML = `
          ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–±—Ä–∞–Ω –∏–∑ BlackList<br>
          <small>${userData?.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: ${telegramId})</small>
        `;
        document.body.appendChild(notification);
        
        updateBlacklistButtonsModal(telegramId);
        
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 500);
        }, 4000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ BlackList:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ BlackList: ' + error.message);
      }
    }

    async function refreshUserInfoModal() {
      const telegramIdInput = document.getElementById('user-id-input-modal').value.trim();
      
      if (!telegramIdInput) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      try {
        const { data: userData, error } = await supabaseClient
          .from('users')
          .select('username, full_name, membership_status, points')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        if (error) {
          alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
          return;
        }
        
        if (!userData) {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        document.getElementById('user-name-display-modal').value = userData.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        document.getElementById('user-status-select-modal').value = userData.membership_status || '';
        
        await updateBlacklistButtonsModal(telegramId);
        
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #17a2b8;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-size: 0.9rem;
        `;
        notification.innerHTML = `
          üîÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞<br>
          <small>${userData.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</small><br>
          <small>–°—Ç–∞—Ç—É—Å: ${userData.membership_status} | –û—á–∫–∏: ${userData.points || 0}</small>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 500);
        }, 3000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: ' + error.message);
      }
    }

    async function updateUserModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const telegramIdInput = document.getElementById('user-id-input-modal').value.trim();
      const addPoints = parseInt(document.getElementById('add-points-modal').value) || 0;
      const removePoints = parseInt(document.getElementById('remove-points-modal').value) || 0;
      const newStatus = document.getElementById('user-status-select-modal').value;
      
      if (!telegramIdInput) {
        alert('–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫');
        return;
      }
      
      const telegramId = parseInt(telegramIdInput);
      if (isNaN(telegramId)) {
        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
        return;
      }
      
      if (!addPoints && !removePoints && !newStatus) {
        alert('–£–∫–∞–∂–∏—Ç–µ —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å: –æ—á–∫–∏ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å');
        return;
      }
      
      try {
        const { data: userData, error: fetchError } = await supabaseClient
          .from('users')
          .select('id, points, username, full_name')
          .eq('telegram_id', telegramId)
          .maybeSingle();
        
        if (fetchError) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + fetchError.message);
          return;
        }
        
        if (!userData) {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        const updates = {};
        const currentPoints = userData.points || 0;
        
        if (addPoints > 0 || removePoints > 0) {
          updates.points = currentPoints + addPoints - removePoints;
          if (updates.points < 0) updates.points = 0;
        }
        
        if (newStatus) {
          updates.membership_status = newStatus;
        }
        
        updates.updated_at = new Date().toISOString();
        
        const { error } = await supabaseClient
          .from('users')
          .update(updates)
          .eq('id', userData.id);
        
        if (error) throw error;
        
        showUpdateNotificationModal(userData.username || userData.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', updates);
        
        document.getElementById('user-id-input-modal').value = '';
        document.getElementById('add-points-modal').value = '';
        document.getElementById('remove-points-modal').value = '';
        document.getElementById('user-status-select-modal').value = '';
        document.getElementById('search-user-manage-modal').value = '';
        document.getElementById('user-name-display-modal').value = '';
        document.getElementById('blacklist-buttons-modal').style.display = 'none';
        
        loadPendingModal();
        loadAllUsersModal();
        loadStatsModal();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
      }
    }

    function showUpdateNotificationModal(username, updates) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 0.9rem;
      `;
      
      let updateDetails = [];
      if (updates.points !== undefined) {
        updateDetails.push(`–æ—á–∫–∏: ${updates.points}`);
      }
      if (updates.membership_status) {
        const statusText = {
          'New': '–ù–æ–≤—ã–π',
          'pending': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
          'approved': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
          'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω'
        }[updates.membership_status] || updates.membership_status;
        updateDetails.push(`—Å—Ç–∞—Ç—É—Å: ${statusText}`);
      }
      
      notification.innerHTML = `
        ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!<br>
        <small>${username}</small><br>
        <small>${updateDetails.join(', ')}</small>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 500);
      }, 4000);
    }

    function showSelectionNotificationModal(telegramId, username) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--chelsea-blue);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 0.9rem;
        border: 1px solid var(--gold);
      `;
      notification.innerHTML = `
        ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω<br>
        <small>${username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: ${telegramId})</small>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 500);
      }, 3000);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    async function searchUserForNotificationModal() {
      const searchTerm = document.getElementById('notification-search-user-modal').value.trim();
      const resultsContainer = document.getElementById('notification-search-results-modal');
      
      if (searchTerm.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }
      
      try {
        const isNumericSearch = !isNaN(searchTerm) && searchTerm.trim() !== '';
        
        let query = supabaseClient
          .from('users')
          .select('id, full_name, username, telegram_id, phone, points, membership_status')
          .limit(10);
        
        if (isNumericSearch) {
          query = query.or(`username.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,telegram_id.eq.${parseInt(searchTerm)}`);
        } else {
          query = query.or(`username.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);
        }
        
        const { data, error } = await query;
        
        if (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
          resultsContainer.innerHTML = '<div style="padding: 10px; color: #ff6666; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
          resultsContainer.style.display = 'block';
          return;
        }
        
        if (!data || data.length === 0) {
          resultsContainer.innerHTML = '<div style="padding: 10px; color: #aaa; text-align: center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
          resultsContainer.style.display = 'block';
          return;
        }
        
        let html = '';
        data.forEach(user => {
          if (!user.telegram_id) return;
          
          html += `
            <div class="search-result-item"
                 onclick="selectUserForNotificationModal(${user.telegram_id}, '${user.username || '–ù–µ—Ç username'}', '${(user.full_name || '').replace(/'/g, "\\'")}')"
                 style="padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='rgba(156, 39, 176, 0.3)'"
                 onmouseout="this.style.background='transparent'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong><br>
                  <small style="color: #aaa;">
                    @${user.username || '–Ω–µ—Ç username'} ‚Ä¢ ID: ${user.telegram_id}
                  </small>
                </div>
                <div style="text-align: right;">
                  <span style="background: ${getStatusColor(user.membership_status)}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
                    ${user.membership_status}
                  </span><br>
                  <small style="color: #D4A017;">‚≠ê ${user.points || 0}</small>
                </div>
              </div>
            </div>
          `;
        });
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        resultsContainer.innerHTML = '<div style="padding: 10px; color: #ff6666; text-align: center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
        resultsContainer.style.display = 'block';
      }
    }

    function selectUserForNotificationModal(telegramId, username, fullName) {
      document.getElementById('notification-user-id-modal').value = telegramId;
      document.getElementById('notification-user-name-modal').value = fullName || username || '';
      document.getElementById('notification-search-user-modal').value = '';
      document.getElementById('notification-search-results-modal').style.display = 'none';
      
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #9C27B0;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 0.9rem;
      `;
      notification.innerHTML = `
        ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è<br>
        <small>${fullName || username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (ID: ${telegramId})</small>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 500);
      }, 3000);
    }

    function toggleSendToAllModal() {
      const sendToAllCheckbox = document.getElementById('notification-send-to-all-modal');
      const telegramIdInput = document.getElementById('notification-user-id-modal');
      const userNameInput = document.getElementById('notification-user-name-modal');
      const searchInput = document.getElementById('notification-search-user-modal');
      
      if (sendToAllCheckbox.checked) {
        telegramIdInput.value = '–í–°–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú';
        telegramIdInput.style.background = '#9C27B0';
        telegramIdInput.style.color = 'white';
        userNameInput.value = '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å Telegram ID';
        userNameInput.style.background = '#9C27B0';
        userNameInput.style.color = 'white';
        searchInput.disabled = true;
        searchInput.placeholder = '–ü–æ–∏—Å–∫ –æ—Ç–∫–ª—é—á–µ–Ω (–æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º)';
        searchInput.style.background = '#555';
      } else {
        telegramIdInput.value = '';
        telegramIdInput.style.background = '';
        telegramIdInput.style.color = '';
        userNameInput.value = '';
        userNameInput.style.background = '';
        userNameInput.style.color = '';
        searchInput.disabled = false;
        searchInput.placeholder = 'üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username –∏–ª–∏ ID';
        searchInput.style.background = '';
      }
    }

    async function sendTestNotificationModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const message = document.getElementById('notification-message-modal').value.trim();
      const sendToAllCheckbox = document.getElementById('notification-send-to-all-modal');
      const sendToAll = sendToAllCheckbox.checked;
      const telegramId = document.getElementById('notification-user-id-modal').value;
      
      if (!sendToAll && (!telegramId || telegramId === '–í–°–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú')) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º"');
        return;
      }
      
      if (!message) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        return;
      }
      
      const testText = "üîî *–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞*\n\n" + message + "\n\n_–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ_";
      
      if (sendToAll) {
        const myTelegramId = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID –¥–ª—è —Ç–µ—Å—Ç–∞:");
        if (!myTelegramId) return;
        
        showNotificationStatusModal('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
        
        try {
          const result = await sendTelegramMessage(myTelegramId, testText);
          
          if (result.success) {
            showNotificationStatusModal('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–∞–º! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.', 'success');
          } else {
            showNotificationStatusModal(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
          }
        } catch (error) {
          showNotificationStatusModal(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
      } else {
        showNotificationStatusModal('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
        
        try {
          const result = await sendTelegramMessage(telegramId, testText);
          
          if (result.success) {
            showNotificationStatusModal(`‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!`, 'success');
          } else {
            showNotificationStatusModal(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
          }
        } catch (error) {
          showNotificationStatusModal(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
      }
    }

    async function sendNotificationModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const message = document.getElementById('notification-message-modal').value.trim();
      const sendToAllCheckbox = document.getElementById('notification-send-to-all-modal');
      const sendToAll = sendToAllCheckbox.checked;
      const telegramId = document.getElementById('notification-user-id-modal').value;
      
      if (!sendToAll && (!telegramId || telegramId === '–í–°–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú')) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º"');
        return;
      }
      
      if (!message) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        return;
      }
      
      const formattedMessage = "üîî *–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ Almablues*\n\n" + message + "";
      
      if (sendToAll) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å Telegram ID? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.`)) {
          return;
        }
        
        showNotificationStatusModal('üì§ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...', 'info');
        
        try {
          const { data: users, error } = await supabaseClient
            .from('users')
            .select('telegram_id, full_name, username, membership_status')
            .not('telegram_id', 'is', null);
          
          if (error) throw error;
          
          if (!users || users.length === 0) {
            showNotificationStatusModal('‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å Telegram ID –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
            return;
          }
          
          showNotificationStatusModal(`üì§ –ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º...`, 'info');
          
          let successCount = 0;
          let errorCount = 0;
          let currentIndex = 0;
          const errors = [];
          
          for (const user of users) {
            currentIndex++;
            const progress = Math.round((currentIndex / users.length) * 100);
            showNotificationStatusModal(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${currentIndex}/${users.length} (${progress}%) - ${user.username || user.full_name}...`, 'info');
            
            try {
              const result = await sendTelegramMessage(user.telegram_id, formattedMessage);
              
              if (result.success) {
                successCount++;
                console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${user.username || user.full_name} (${user.telegram_id})`);
              } else {
                errorCount++;
                errors.push(`${user.username || user.full_name}: ${result.error}`);
                console.log(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${user.username || user.full_name}: ${result.error}`);
              }
            } catch (error) {
              errorCount++;
              errors.push(`${user.username || user.full_name}: ${error.message}`);
              console.log(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${user.username || user.full_name}: ${error.message}`);
            }
            
            await new Promise(resolve => setTimeout(resolve, 50));
          }
          
          let resultMessage = `‚úÖ –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!<br>`;
          resultMessage += `–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${successCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>`;
          resultMessage += `–° –æ—à–∏–±–∫–∞–º–∏: ${errorCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>`;
          
          if (errors.length > 0) {
            resultMessage += `<br><small>–û—Å–Ω–æ–≤–Ω—ã–µ –æ—à–∏–±–∫–∏:<br>`;
            errors.slice(0, 5).forEach(err => {
              resultMessage += `‚Ä¢ ${err}<br>`;
            });
            if (errors.length > 5) {
              resultMessage += `... –∏ –µ—â–µ ${errors.length - 5} –æ—à–∏–±–æ–∫`;
            }
            resultMessage += `</small>`;
          }
          
          showNotificationStatusModal(resultMessage, successCount > 0 ? 'success' : 'error');
          
          await saveNotificationLog({
            type: 'mass',
            message: message,
            sent_count: successCount,
            failed_count: errorCount,
            total_users: users.length
          });
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
          showNotificationStatusModal(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
      } else {
        showNotificationStatusModal('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'info');
        
        try {
          const result = await sendTelegramMessage(telegramId, formattedMessage);
          
          if (result.success) {
            showNotificationStatusModal(`‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!`, 'success');
            
            await saveNotificationLog({
              type: 'single',
              message: message,
              telegram_id: telegramId,
              user_name: document.getElementById('notification-user-name-modal').value
            });
            
            document.getElementById('notification-message-modal').value = '';
          } else {
            showNotificationStatusModal(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
          }
        } catch (error) {
          showNotificationStatusModal(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
      }
    }

    function showNotificationStatusModal(message, type = 'info') {
      const statusEl = document.getElementById('notification-status-modal');
      const colors = {
        'info': '#2196F3',
        'success': '#4CAF50',
        'error': '#f44336',
        'warning': '#FF9800'
      };
      
      statusEl.innerHTML = message;
      statusEl.style.color = colors[type] || colors.info;
      statusEl.style.fontWeight = '500';
      
      if (type !== 'info') {
        setTimeout(() => {
          statusEl.innerHTML = '';
        }, 10000);
      }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    async function loadEventsForFilterModal() {
      try {
        const { data, error } = await supabaseClient
          .from('events')
          .select('id, match_name, match_date')
          .order('match_date', { ascending: false });

        if (error) return;

        const filterSelect = document.getElementById('filter-event-modal');
        filterSelect.innerHTML = '<option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>';
        
        data.forEach(event => {
          const formattedDate = formatDateTimeInAlmaty(event.match_date);
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = `${event.match_name} (${formattedDate})`;
          filterSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading events for filter:', error);
      }
    }

    function switchEventTabModal(tabName) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      document.querySelectorAll('#modal-events .event-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('#modal-events .event-tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`#modal-events [onclick="switchEventTabModal('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-events-modal`).classList.add('active');
    }

    async function deleteEventModal(eventId, eventName) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏!`)) {
        return;
      }
      
      try {
        const { error: registrationsError } = await supabaseClient
          .from('registrations')
          .delete()
          .eq('event_id', eventId);
        
        if (registrationsError) {
          console.error('Error deleting registrations:', registrationsError);
        }
        
        const { error } = await supabaseClient
          .from('events')
          .delete()
          .eq('id', eventId);
        
        if (error) throw error;
        
        alert(`‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!`);
        
        loadStatsModal();
        loadAllEventsModal();
        loadRegistrationsModal();
        loadEventsForFilterModal();
        
      } catch (error) {
        console.error('Error deleting event:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ' + error.message);
      }
    }

    async function deleteRegistrationModal(registrationId, userName, eventName) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .delete()
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" —É–¥–∞–ª–µ–Ω–∞`);
        loadRegistrationsModal();
        loadStatsModal();
        
      } catch (error) {
        console.error('Error deleting registration:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    async function reRegisterUserModal(registrationId, userName, eventName) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${eventName}"?`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('registrations')
          .update({
            status: 'registered',
            checkin_time: null,
            updated_at: new Date().toISOString()
          })
          .eq('id', registrationId);

        if (error) throw error;

        alert(`‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`);
        loadRegistrationsModal();
        loadStatsModal();
        
      } catch (error) {
        console.error('Error re-registering user:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
      }
    }

    async function approveApplicationModal(userId) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å 100 –±–æ–Ω—É—Å–Ω—ã—Ö –æ—á–∫–æ–≤?')) return;
      
      try {
        const { data: userData, error: fetchError } = await supabaseClient
          .from('users')
          .select('points')
          .eq('id', userId)
          .single();

        if (fetchError) throw fetchError;
        
        const currentPoints = userData.points || 0;
        const newPoints = currentPoints + 100;
        
        const { error: updateError } = await supabaseClient
          .from('users')
          .update({
            membership_status: 'approved',
            points: newPoints,
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (updateError) throw updateError;
        
        alert('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∞! +100 –æ—á–∫–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω—ã.');
        
        loadPendingModal();
        loadAllUsersModal();
        loadStatsModal();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      }
    }

    async function rejectApplicationModal(userId) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('users')
          .update({
            membership_status: 'rejected',
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (error) throw error;
        
        alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.');
        
        loadPendingModal();
        loadAllUsersModal();
        loadStatsModal();
        
      } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
      }
    }

    function copyTelegramIdModal(telegramId, userName) {
      navigator.clipboard.writeText(telegramId).then(() => {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #4CAF50;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-size: 0.9rem;
        `;
        notification.innerHTML = `
          ‚úÖ Telegram ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!<br>
          <small>${userName}: ${telegramId}</small>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.5s';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 500);
        }, 3000);
      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Telegram ID. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + telegramId);
      });
    }

    function searchUsersModal() {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const searchTerm = document.getElementById('search-user-modal').value.toLowerCase();
      if (!window.allUsersModal) return;
      
      const filtered = window.allUsersModal.filter(user =>
        (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
        (user.username && user.username.toLowerCase().includes(searchTerm)) ||
        (user.telegram_id && user.telegram_id.toString().includes(searchTerm)) ||
        (user.phone && user.phone.toLowerCase().includes(searchTerm))
      );
      
      renderUsersModal(filtered);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é openModal –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    const originalOpenModal = openModal;
    openModal = function(modalId) {
      if (localStorage.getItem('adminLoggedIn') !== 'true') {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        
        switch(modalId) {
    case 'modal-stats':
        loadStatsModal(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        break;
    case 'modal-create-event':
        // –ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
        break;
    case 'modal-registrations':
        loadRegistrationsModal();
        loadEventsForFilterModal();
        break;
    case 'modal-events':
        loadAllEventsModal();
        break;
    case 'modal-pending':
        loadPendingModal();
        break;
    case 'modal-users':
        loadAllUsersModal();
        break;
    case 'modal-manage-user':
        // –ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
        break;
    case 'modal-notifications':
        // –ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
        break;
}
        
        document.body.style.overflow = 'hidden';
      }
    };
  </script>

</body>
</html>
