<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äî Chelsea FC KZ</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-dark: #001028;
      --chelsea-blue: #034694;
      --chelsea-blue-dark: #002366;
      --gold: #D4A017;
      --gold-hover: #E8B923;
      --text-light: #e0e0e0;
      --white: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      color: var(--gold);
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .user-info {
      background: rgba(3, 70, 148, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .user-name {
      font-weight: bold;
      font-size: 1.1rem;
      word-break: break-word;
    }

    .user-points {
      background: var(--gold);
      color: var(--bg-dark);
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      white-space: nowrap;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.08);
    }

    .card-title {
      font-family: 'Oswald', sans-serif;
      font-size: 1.2rem;
      color: var(--white);
      margin-bottom: 10px;
      line-height: 1.3;
    }

    .card-description {
      color: #aaa;
      font-size: 0.9rem;
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: var(--chelsea-blue);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .btn:hover {
      background: var(--chelsea-blue-dark);
    }

    .btn-gold {
      background: var(--gold);
      color: var(--bg-dark);
    }

    .btn-gold:hover {
      background: var(--gold-hover);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
      width: auto;
    }

    .btn-red {
      background: #f44336;
      color: white;
    }

    .btn-red:hover {
      background: #d32f2f;
    }

    .btn-green {
      background: #4CAF50;
      color: white;
    }

    .btn-green:hover {
      background: #388E3C;
    }

    .btn-disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
    }

    .btn-disabled:hover {
      background: #666;
    }

    .events-list {
      margin-top: 10px;
    }

    .event-item {
      background: rgba(3, 70, 148, 0.1);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .event-info h4 {
      color: var(--white);
      margin-bottom: 5px;
      font-size: 1.1rem;
    }

    .event-date {
      color: var(--gold);
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .event-address {
      color: #aaa;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .countdown {
      background: rgba(212, 160, 23, 0.1);
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 8px;
      font-family: monospace;
      font-size: 1.1rem;
      color: var(--gold);
      text-align: center;
      border: 1px solid rgba(212, 160, 23, 0.3);
    }

    .countdown.ended {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
      border-color: rgba(244, 67, 54, 0.3);
    }

    .registration-closed {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-top: 8px;
      text-align: center;
      border-left: 3px solid #f44336;
    }

    .status-info {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      border-left: 4px solid #FFC107;
    }

    .status-approved {
      background: rgba(0, 200, 83, 0.2);
      border-left: 4px solid #00C853;
    }

    .status-rejected {
      background: rgba(244, 67, 54, 0.2);
      border-left: 4px solid #F44336;
    }

    .status-new {
      background: rgba(33, 150, 243, 0.2);
      border-left: 4px solid #2196F3;
    }

    footer {
      text-align: center;
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: #777;
      font-size: 0.9rem;
    }

    .back-btn {
      display: inline-block;
      margin-top: 1rem;
      color: var(--gold);
      text-decoration: none;
      font-weight: 500;
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .event-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .event-actions .btn-small {
      flex: 1;
      min-width: 100px;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
    @media (max-width: 480px) {
      .container {
        padding: 0 10px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .card {
        padding: 15px;
      }
      
      .btn {
        padding: 12px;
        font-size: 0.95rem;
      }
      
      .user-info {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-points {
        align-self: flex-end;
      }
      
      .event-actions .btn-small {
        min-width: 100%;
      }
    }
  </style>
</head>

<body>
<div class="container">
  <header>
    <h1>Chelsea FC KZ</h1>
    <p>–§–∞–Ω-–∫–ª—É–± –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ</p>
  </header>

  <div class="user-info">
    <div>
      <div class="user-name" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div id="user-status" style="font-size: 0.9rem; color: #aaa;">–°—Ç–∞—Ç—É—Å: New</div>
    </div>
    <div class="user-points">
      <span id="user-points">0</span> –æ—á–∫–æ–≤
    </div>
  </div>

  <div class="dashboard-grid">
    
    <!-- –ó–∞—è–≤–∫–∞ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ -->
    <div class="card" id="membership-card">
      <h3 class="card-title">üë• –ó–∞—è–≤–∫–∞ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ</h3>
      <p class="card-description">–ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —á–ª–µ–Ω—Å—Ç–≤–æ –≤ —Ñ–∞–Ω-–∫–ª—É–±–µ</p>
      
      <div id="membership-status-info"></div>
      
      <div id="membership-actions">
        <button class="btn btn-gold" id="membership-btn">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        <button class="btn btn-red" id="cancel-membership-btn" style="display: none; margin-top: 10px;">–û—Ç–æ–∑–≤–∞—Ç—å –∑–∞—è–≤–∫—É</button>
      </div>
    </div>

    <!-- –†–µ–π—Ç–∏–Ω–≥–∏ -->
    <div class="card">
      <h3 class="card-title">üèÜ –†–µ–π—Ç–∏–Ω–≥–∏</h3>
      <p class="card-description">–¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ñ–∞–Ω-–∫–ª—É–±–∞</p>
      <a href="ratings.html" class="btn" id="ratings-btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥</a>
    </div>

    <!-- –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
    <div class="card">
      <h3 class="card-title">üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
      <p class="card-description">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–∞—Ç—á–∏ –∏ –≤—Å—Ç—Ä–µ—á–∏ —Ñ–∞–Ω–∞—Ç–æ–≤</p>
      
      <div class="events-list" id="events-list">
        <div class="event-item">
          <div class="event-info">
            <h4>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</h4>
          </div>
        </div>
      </div>
      
      <a href="all-events.html" class="btn" style="margin-top: 15px;">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
    </div>

    <!-- –ú–æ–∏ –∑–∞–ø–∏—Å–∏ -->
    <div class="card">
      <h3 class="card-title">üé´ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</h3>
      <p class="card-description">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
      <div class="event-actions">
        <a href="my-registrations.html" class="btn btn-small" id="my-registrations-btn">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</a>
        <button class="btn btn-small" id="edit-registration-btn" onclick="openEditModal()">–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </div>
    </div>

    <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
    <div class="card">
      <h3 class="card-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h3>
      <p class="card-description">–°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
      <button class="btn" id="participants-btn" onclick="openParticipantsModal()">–ü–æ–∫–∞–∑–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
    </div>

    <!-- QR –∫–æ–¥ -->
    <div class="card">
      <h3 class="card-title">üì± QR –∫–æ–¥</h3>
      <p class="card-description">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π QR –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö</p>
      <div class="event-actions">
        <button class="btn btn-small" id="show-qr-btn" onclick="showMyQR()">–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π QR</button>
        <button class="btn btn-small" id="scan-qr-btn" onclick="scanQR()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
      </div>
    </div>

  </div>

  <footer>
    <p>Chelsea FC Supporters Club Kazakhstan ‚Ä¢ 2025</p>
    <a href="profile.html" class="back-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
  </footer>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<!-- (–ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏) -->

<script>
  // === Telegram ===
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  // === Supabase ===
  const supabaseUrl = 'https://zuapiixwzkleygaijulx.supabase.co';
  const supabaseKey = 'sb_publishable_Jsth-2GViNz5Ev3UWtrWTg_fbg4GAKx';

  const supabaseClient = supabase.createClient(
    supabaseUrl,
    supabaseKey
  );

  const userId = localStorage.getItem('userId');

  if (!userId) {
    alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    location.href = 'index.html';
  }

  // === –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å UTC+5 –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ (–ê–ª–º–∞—Ç—ã/–ê—Å—Ç–∞–Ω–∞) ===
  const TIMEZONE_OFFSET = 5 * 60 * 60 * 1000; // 5 —á–∞—Å–æ–≤ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
  function getCurrentTimeUTC5() {
    const now = new Date();
    return new Date(now.getTime() + TIMEZONE_OFFSET);
  }
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ UTC –≤ UTC+5
  function convertToUTC5(dateString) {
    const date = new Date(dateString);
    return new Date(date.getTime() + TIMEZONE_OFFSET);
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  function formatDateTimeUTC5(dateString) {
    const date = convertToUTC5(dateString);
    return date.toLocaleString('ru-RU', {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'UTC'
    });
  }
  
  // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞ (2 —á–∞—Å–∞ –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
  function getDeadlineTime(eventTime) {
    const deadline = new Date(eventTime.getTime() - (2 * 60 * 60 * 1000));
    return deadline;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –µ—â–µ –∑–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
  function isRegistrationOpen(eventTime) {
    const now = getCurrentTimeUTC5();
    const deadline = getDeadlineTime(eventTime);
    return now < deadline;
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
  function formatTimeRemaining(ms) {
    if (ms <= 0) return '00:00:00';
    
    const seconds = Math.floor((ms / 1000) % 60);
    const minutes = Math.floor((ms / (1000 * 60)) % 60);
    const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
    const days = Math.floor(ms / (1000 * 60 * 60 * 24));
    
    if (days > 0) {
      return `${days}–¥ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–ª–µ–Ω—Å—Ç–≤–æ–º ===
  function getStatusText(status, points) {
    if (status === 'approved') {
      if (points < 100) {
        return '–ù–æ–≤–∏—á–æ–∫';
      } else if (points < 500) {
        return '–§–∞–Ω–∞—Ç';
      } else {
        return '–£–ª—å—Ç—Ä–∞—Å';
      }
    } else {
      const statusMap = {
        'New': '–ù–æ–≤—ã–π',
        'pending': '–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
      };
      return statusMap[status] || status;
    }
  }

  async function updateMembershipStatus() {
    const { data, error } = await supabaseClient
      .from('users')
      .select('membership_status, points')
      .eq('id', userId)
      .single();

    if (!error && data) {
      const statusElement = document.getElementById('user-status');
      const pointsElement = document.getElementById('user-points');
      const membershipBtn = document.getElementById('membership-btn');
      const cancelBtn = document.getElementById('cancel-membership-btn');
      const statusInfo = document.getElementById('membership-status-info');
      
      const status = data.membership_status || 'New';
      const points = data.points || 0;
      
      statusElement.textContent = `–°—Ç–∞—Ç—É—Å: ${getStatusText(status, points)}`;
      pointsElement.textContent = points;
      
      switch(status) {
        case 'New':
          membershipBtn.textContent = '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ';
          membershipBtn.disabled = false;
          membershipBtn.style.display = 'block';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = '<div class="status-info status-new">üéØ –í—ã –µ—â–µ –Ω–µ –ø–æ–¥–∞–≤–∞–ª–∏ –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ</div>';
          break;
          
        case 'pending':
          membershipBtn.style.display = 'none';
          cancelBtn.style.display = 'block';
          statusInfo.innerHTML = `
            <div class="status-info status-pending">
              ‚è≥ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
            </div>
          `;
          break;
          
        case 'approved':
          membershipBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = `
            <div class="status-info status-approved">
              ‚úÖ –í–∞—à–µ —á–ª–µ–Ω—Å—Ç–≤–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–∞–Ω-–∫–ª—É–±!
            </div>
          `;
          break;
          
        case 'rejected':
          membershipBtn.textContent = '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ';
          membershipBtn.disabled = false;
          membershipBtn.style.display = 'block';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = `
            <div class="status-info status-rejected">
              ‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∞—Ç—å –µ–µ —Å–Ω–æ–≤–∞.
            </div>
          `;
          break;
      }
    }
  }

  async function applyForMembership() {
    if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ –≤ —Ñ–∞–Ω-–∫–ª—É–±–µ?')) {
      return;
    }
    
    const { error } = await supabaseClient
      .from('users')
      .update({ 
        membership_status: 'pending',
        updated_at: new Date().toISOString()
      })
      .eq('id', userId);

    if (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏: ' + error.message);
    } else {
      alert('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ–µ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
      await updateMembershipStatus();
    }
  }

  async function cancelMembershipApplication() {
    if (!confirm('–û—Ç–æ–∑–≤–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ?')) {
      return;
    }
    
    const { error } = await supabaseClient
      .from('users')
      .update({ 
        membership_status: 'New',
        updated_at: new Date().toISOString()
      })
      .eq('id', userId);

    if (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ –∑–∞—è–≤–∫–∏: ' + error.message);
    } else {
      alert('–ó–∞—è–≤–∫–∞ –æ—Ç–æ–∑–≤–∞–Ω–∞.');
      await updateMembershipStatus();
    }
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∏ –∑–∞–ø–∏—Å–µ–π ===
  async function loadEvents() {
    try {
      const { data, error } = await supabaseClient
        .from('events')
        .select('*')
        .eq('is_open', true)
        .gte('match_date', new Date().toISOString())
        .order('match_date', { ascending: true })
        .limit(3);

      const eventsList = document.getElementById('events-list');
      
      if (error) {
        eventsList.innerHTML = '<div class="event-item"><div class="event-info"><h4>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h4></div></div>';
        return;
      }
      
      if (!data || data.length === 0) {
        eventsList.innerHTML = '<div class="event-item"><div class="event-info"><h4>–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h4></div></div>';
        return;
      }

      eventsList.innerHTML = '';
      
      for (const event of data) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–∏—Å–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const { data: registration } = await supabaseClient
          .from('registrations')
          .select('id, status')
          .eq('user_id', userId)
          .eq('event_id', event.id)
          .maybeSingle();
        
        const isRegistered = registration && registration.status === 'registered';
        const isCancelled = registration && registration.status === 'cancelled';
        
        const eventTimeUTC5 = convertToUTC5(event.match_date);
        const formattedDate = formatDateTimeUTC5(event.match_date);
        const now = getCurrentTimeUTC5();
        const timeRemaining = eventTimeUTC5 - now;
        const registrationOpen = isRegistrationOpen(eventTimeUTC5);
        
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event-item';
        eventDiv.id = `event-${event.id}`;
        
        let buttonHtml = '';
        let registrationStatusHtml = '';
        
        if (isRegistered) {
          buttonHtml = `<button class="btn btn-small btn-disabled" disabled>‚úì –ó–∞–ø–∏—Å–∞–Ω</button>`;
        } else if (isCancelled) {
          if (registrationOpen) {
            buttonHtml = `<button class="btn btn-small btn-green" onclick="registerForEvent('${event.id}')">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞</button>`;
          } else {
            buttonHtml = `<button class="btn btn-small btn-disabled" disabled>–ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞</button>`;
          }
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞
          const { count: registeredCount } = await supabaseClient
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .eq('event_id', event.id)
            .eq('status', 'registered');
          
          const isFull = event.max_participants && registeredCount >= event.max_participants;
          
          if (isFull) {
            buttonHtml = `<button class="btn btn-small btn-disabled" disabled>–ú–µ—Å—Ç –Ω–µ—Ç</button>`;
          } else if (registrationOpen) {
            buttonHtml = `<button class="btn btn-small btn-green" onclick="registerForEvent('${event.id}')">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>`;
          } else {
            buttonHtml = `<button class="btn btn-small btn-disabled" disabled>–ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞</button>`;
            registrationStatusHtml = '<div class="registration-closed">‚ùå –ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞ (–∑–∞ 2 —á–∞—Å–∞ –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)</div>';
          }
        }
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
        const countdownId = `countdown-${event.id}`;
        let countdownHtml = '';
        
        if (timeRemaining > 0) {
          countdownHtml = `
            <div class="countdown" id="${countdownId}">
              –î–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ${formatTimeRemaining(timeRemaining)}
            </div>
          `;
        } else if (timeRemaining > -2 * 60 * 60 * 1000) { // –í —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞
          countdownHtml = `
            <div class="countdown ended" id="${countdownId}">
              –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–∞—á–∞–ª–æ—Å—å
            </div>
          `;
        } else {
          countdownHtml = `
            <div class="countdown ended">
              –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            </div>
          `;
        }
        
        eventDiv.innerHTML = `
          <div class="event-info">
            <h4>${event.match_name}</h4>
            <div class="event-date">üìÖ ${formattedDate} (UTC+5)</div>
            <div class="event-address">üìç ${event.bar_address}</div>
            ${event.max_participants ? `<div style="font-size: 0.8rem; color: #FFC107;">üë• –ú–µ—Å—Ç: ${event.max_participants}</div>` : ''}
          </div>
          ${countdownHtml}
          ${registrationStatusHtml}
          <div class="event-actions">
            ${buttonHtml}
            <a href="event-participants.html?event_id=${event.id}" class="btn btn-small">–£—á–∞—Å—Ç–Ω–∏–∫–∏</a>
          </div>
        `;
        eventsList.appendChild(eventDiv);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
        if (timeRemaining > 0) {
          startCountdown(event.id, eventTimeUTC5);
        }
      }
    } catch (err) {
      console.error('Error loading events:', err);
    }
  }

  // –¢–∞–π–º–µ—Ä—ã –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
  const countdownTimers = {};
  
  function startCountdown(eventId, eventTimeUTC5) {
    const countdownElement = document.getElementById(`countdown-${eventId}`);
    if (!countdownElement) return;
    
    function updateCountdown() {
      const now = getCurrentTimeUTC5();
      const timeRemaining = eventTimeUTC5 - now;
      
      if (timeRemaining > 0) {
        countdownElement.textContent = `–î–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ${formatTimeRemaining(timeRemaining)}`;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫—Ä—ã–ª–∞—Å—å –ª–∏ –∑–∞–ø–∏—Å—å
        const registrationOpen = isRegistrationOpen(eventTimeUTC5);
        const registerButton = document.querySelector(`#event-${eventId} .btn-green`);
        const disabledButton = document.querySelector(`#event-${eventId} .btn-disabled`);
        
        if (!registrationOpen && registerButton) {
          registerButton.disabled = true;
          registerButton.classList.remove('btn-green');
          registerButton.classList.add('btn-disabled');
          registerButton.textContent = '–ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞';
          
          // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–ø–∏—Å–∏
          const registrationStatus = document.createElement('div');
          registrationStatus.className = 'registration-closed';
          registrationStatus.textContent = '‚ùå –ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞ (–∑–∞ 2 —á–∞—Å–∞ –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)';
          countdownElement.parentNode.insertBefore(registrationStatus, countdownElement.nextSibling);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
        countdownTimers[eventId] = setTimeout(updateCountdown, 1000);
      } else if (timeRemaining > -2 * 60 * 60 * 1000) {
        countdownElement.textContent = '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–∞—á–∞–ª–æ—Å—å';
        countdownElement.classList.add('ended');
        clearTimeout(countdownTimers[eventId]);
      } else {
        countdownElement.textContent = '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ';
        countdownElement.classList.add('ended');
        clearTimeout(countdownTimers[eventId]);
      }
    }
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –±—ã–ª
    if (countdownTimers[eventId]) {
      clearTimeout(countdownTimers[eventId]);
    }
    
    updateCountdown();
  }

  async function registerForEvent(eventId) {
    try {
      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏
      const { data: event } = await supabaseClient
        .from('events')
        .select('match_name, match_date')
        .eq('id', eventId)
        .single();
      
      if (!event) {
        alert('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–¥–ª–∞–π–Ω (–∑–∞ 2 —á–∞—Å–∞ –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
      const eventTimeUTC5 = convertToUTC5(event.match_date);
      const registrationOpen = isRegistrationOpen(eventTimeUTC5);
      
      if (!registrationOpen) {
        alert('‚ùå –ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è –∑–∞ 2 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å
      const { data: existing } = await supabaseClient
        .from('registrations')
        .select('id, status')
        .eq('user_id', userId)
        .eq('event_id', eventId)
        .maybeSingle();
      
      if (existing) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        const { error } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'registered',
            updated_at: new Date().toISOString()
          })
          .eq('id', existing.id);
        
        if (error) throw error;
        alert(`‚úÖ –í—ã —Å–Ω–æ–≤–∞ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${event.match_name}"!`);
      } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        const { error } = await supabaseClient
          .from('registrations')
          .insert({
            user_id: userId,
            event_id: eventId,
            status: 'registered'
          });
        
        if (error) throw error;
        alert(`‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${event.match_name}"!`);
      }
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
      await loadEvents();
      
    } catch (error) {
      console.error('Error registering for event:', error);
      alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
    }
  }

  // === –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
  async function loadUserData() {
    try {
      const { data, error } = await supabaseClient
        .from('users')
        .select('full_name, points, membership_status')
        .eq('id', userId)
        .single();

      if (error || !data) {
        console.error('Error loading user:', error);
        document.getElementById('user-name').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        return;
      }

      document.getElementById('user-name').textContent = data.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      document.getElementById('user-points').textContent = data.points || 0;
      document.getElementById('user-status').textContent = `–°—Ç–∞—Ç—É—Å: ${getStatusText(data.membership_status || 'New', data.points || 0)}`;
      
      await updateMembershipStatus();
      
    } catch (err) {
      console.error('Unexpected error:', err);
    }
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  async function init() {
    await loadUserData();
    await loadEvents();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —á–ª–µ–Ω—Å—Ç–≤–∞
    document.getElementById('membership-btn').addEventListener('click', applyForMembership);
    document.getElementById('cancel-membership-btn').addEventListener('click', cancelMembershipApplication);
    
    // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
      Object.values(countdownTimers).forEach(timer => clearTimeout(timer));
    });
  }

  // –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  // ... (–ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)

  init();
</script>
</body>
</html>
