<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äî Chelsea FC KZ</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-dark: #001028;
      --chelsea-blue: #034694;
      --chelsea-blue-dark: #002366;
      --gold: #D4A017;
      --gold-hover: #E8B923;
      --text-light: #e0e0e0;
      --white: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      color: var(--gold);
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .user-info {
      background: rgba(3, 70, 148, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-name {
      font-weight: bold;
      font-size: 1.1rem;
    }

    .user-points {
      background: var(--gold);
      color: var(--bg-dark);
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.08);
    }

    .card-title {
      font-family: 'Oswald', sans-serif;
      font-size: 1.2rem;
      color: var(--white);
      margin-bottom: 10px;
    }

    .card-description {
      color: #aaa;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .btn {
      display: inline-block;
      width: 100%;
      padding: 14px;
      background: var(--chelsea-blue);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--chelsea-blue-dark);
    }

    .btn-gold {
      background: var(--gold);
      color: var(--bg-dark);
    }

    .btn-gold:hover {
      background: var(--gold-hover);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
      width: auto;
    }

    .btn-red {
      background: #f44336;
      color: white;
    }

    .btn-red:hover {
      background: #d32f2f;
    }

    .btn-green {
      background: #4CAF50;
      color: white;
    }

    .btn-green:hover {
      background: #388E3C;
    }

    .btn-disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
    }

    .btn-disabled:hover {
      background: #666;
    }

    .events-list {
      margin-top: 10px;
    }

    .event-item {
      background: rgba(3, 70, 148, 0.1);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .event-info h4 {
      color: var(--white);
      margin-bottom: 5px;
    }

    .event-date {
      color: var(--gold);
      font-size: 0.9rem;
    }

    .status-info {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      border-left: 4px solid #FFC107;
    }

    .status-approved {
      background: rgba(0, 200, 83, 0.2);
      border-left: 4px solid #00C853;
    }

    .status-rejected {
      background: rgba(244, 67, 54, 0.2);
      border-left: 4px solid #F44336;
    }

    .status-new {
      background: rgba(33, 150, 243, 0.2);
      border-left: 4px solid #2196F3;
    }

    footer {
      text-align: center;
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: #777;
      font-size: 0.9rem;
    }

    .back-btn {
      display: inline-block;
      margin-top: 1rem;
      color: var(--gold);
      text-decoration: none;
      font-weight: 500;
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    .notification.success {
      background: #4CAF50;
    }

    .notification.error {
      background: #f44336;
    }

    .notification.info {
      background: #2196F3;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--bg-dark);
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid var(--chelsea-blue);
    }

    .close-modal {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gold);
    }
  </style>
</head>

<body>
<div class="container">
  <header>
    <h1>Chelsea FC KZ</h1>
    <p>–§–∞–Ω-–∫–ª—É–± –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ</p>
  </header>

  <div class="user-info">
    <div>
      <div class="user-name" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div id="user-status" style="font-size: 0.9rem; color: #aaa;">–°—Ç–∞—Ç—É—Å: New</div>
    </div>
    <div class="user-points">
      <span id="user-points">0</span> –æ—á–∫–æ–≤
    </div>
  </div>

  <div class="dashboard-grid">
    
    <!-- –ó–∞—è–≤–∫–∞ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ -->
    <div class="card" id="membership-card">
      <h3 class="card-title">üë• –ó–∞—è–≤–∫–∞ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ</h3>
      <p class="card-description">–ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —á–ª–µ–Ω—Å—Ç–≤–æ –≤ —Ñ–∞–Ω-–∫–ª—É–±–µ</p>
      
      <div id="membership-status-info"></div>
      
      <div id="membership-actions">
        <button class="btn btn-gold" id="membership-btn">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        <button class="btn btn-red" id="cancel-membership-btn" style="display: none; margin-top: 10px;">–û—Ç–æ–∑–≤–∞—Ç—å –∑–∞—è–≤–∫—É</button>
      </div>
    </div>

    <!-- –†–µ–π—Ç–∏–Ω–≥–∏ -->
    <div class="card">
      <h3 class="card-title">üèÜ –†–µ–π—Ç–∏–Ω–≥–∏</h3>
      <p class="card-description">–¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ñ–∞–Ω-–∫–ª—É–±–∞</p>
      <a href="ratings.html" class="btn" id="ratings-btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥</a>
    </div>

    <!-- –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
    <div class="card">
      <h3 class="card-title">üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
      <p class="card-description">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–∞—Ç—á–∏ –∏ –≤—Å—Ç—Ä–µ—á–∏ —Ñ–∞–Ω–∞—Ç–æ–≤</p>
      
      <div class="events-list" id="events-list">
        <div class="event-item">
          <div class="event-info">
            <h4>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</h4>
          </div>
        </div>
      </div>
      
      <a href="all-events.html" class="btn" style="margin-top: 15px;">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
    </div>

    <!-- –ú–æ–∏ –∑–∞–ø–∏—Å–∏ -->
    <div class="card">
      <h3 class="card-title">üé´ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</h3>
      <p class="card-description">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
        <a href="my-registrations.html" class="btn btn-small" id="my-registrations-btn">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</a>
        <button class="btn btn-small" id="edit-registration-btn" onclick="openEditModal()">–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </div>
    </div>

    <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
    <div class="card">
      <h3 class="card-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h3>
      <p class="card-description">–°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
      <button class="btn" id="participants-btn" onclick="openParticipantsModal()">–ü–æ–∫–∞–∑–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
    </div>

    <!-- QR –∫–æ–¥ -->
    <div class="card">
      <h3 class="card-title">üì± QR –∫–æ–¥</h3>
      <p class="card-description">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π QR –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö</p>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
        <button class="btn btn-small" id="show-qr-btn" onclick="showMyQR()">–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π QR</button>
        <button class="btn btn-small" id="scan-qr-btn" onclick="scanQR()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
      </div>
    </div>

  </div>

  <footer>
    <p>Chelsea FC Supporters Club Kazakhstan ‚Ä¢ 2025</p>
    <a href="profile.html" class="back-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
  </footer>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
<div id="edit-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeEditModal()">&times;</span>
    <h3>üìù –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h3>
    <div id="edit-modal-content">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–∏—Ö –∑–∞–ø–∏—Å–µ–π...</p>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
<div id="participants-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeParticipantsModal()">&times;</span>
    <h3>üë• –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h3>
    <div id="participants-modal-content">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</p>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è QR –∫–æ–¥–∞ -->
<div id="qr-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeQRModal()">&times;</span>
    <h3>üì± –í–∞—à QR –∫–æ–¥</h3>
    <div id="qr-modal-content" style="text-align: center;">
      <div id="qr-code"></div>
      <p style="margin-top: 15px; color: #aaa;">–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR –∫–æ–¥ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –æ –ø–æ—Å–µ—â–µ–Ω–∏–∏</p>
    </div>
  </div>
</div>

<script>
  // === Telegram ===
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  // === Supabase ===
  const supabaseUrl = 'https://zuapiixwzkleygaijulx.supabase.co';
  const supabaseKey = 'sb_publishable_Jsth-2GViNz5Ev3UWtrWTg_fbg4GAKx';

  const supabaseClient = supabase.createClient(
    supabaseUrl,
    supabaseKey
  );

  const userId = localStorage.getItem('userId');

  if (!userId) {
    alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    location.href = 'index.html';
  }

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–ª–µ–Ω—Å—Ç–≤–æ–º ===
  function getStatusText(status, points) {
    if (status === 'approved') {
      if (points < 100) {
        return '–ù–æ–≤–∏—á–æ–∫';
      } else if (points < 500) {
        return '–§–∞–Ω–∞—Ç';
      } else {
        return '–£–ª—å—Ç—Ä–∞—Å';
      }
    } else {
      const statusMap = {
        'New': '–ù–æ–≤—ã–π',
        'pending': '–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
      };
      return statusMap[status] || status;
    }
  }

  async function updateMembershipStatus() {
    const { data, error } = await supabaseClient
      .from('users')
      .select('membership_status, points')
      .eq('id', userId)
      .single();

    if (!error && data) {
      const statusElement = document.getElementById('user-status');
      const pointsElement = document.getElementById('user-points');
      const membershipBtn = document.getElementById('membership-btn');
      const cancelBtn = document.getElementById('cancel-membership-btn');
      const statusInfo = document.getElementById('membership-status-info');
      
      const status = data.membership_status || 'New';
      const points = data.points || 0;
      
      statusElement.textContent = `–°—Ç–∞—Ç—É—Å: ${getStatusText(status, points)}`;
      pointsElement.textContent = points;
      
      switch(status) {
        case 'New':
          membershipBtn.textContent = '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ';
          membershipBtn.disabled = false;
          membershipBtn.style.display = 'block';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = '<div class="status-info status-new">üéØ –í—ã –µ—â–µ –Ω–µ –ø–æ–¥–∞–≤–∞–ª–∏ –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ</div>';
          break;
          
        case 'pending':
          membershipBtn.style.display = 'none';
          cancelBtn.style.display = 'block';
          statusInfo.innerHTML = `
            <div class="status-info status-pending">
              ‚è≥ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
            </div>
          `;
          break;
          
        case 'approved':
          membershipBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = `
            <div class="status-info status-approved">
              ‚úÖ –í–∞—à–µ —á–ª–µ–Ω—Å—Ç–≤–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–∞–Ω-–∫–ª—É–±!
            </div>
          `;
          break;
          
        case 'rejected':
          membershipBtn.textContent = '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ';
          membershipBtn.disabled = false;
          membershipBtn.style.display = 'block';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = `
            <div class="status-info status-rejected">
              ‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∞—Ç—å –µ–µ —Å–Ω–æ–≤–∞.
            </div>
          `;
          break;
      }
    }
  }

  async function applyForMembership() {
    if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ –≤ —Ñ–∞–Ω-–∫–ª—É–±–µ?')) {
      return;
    }
    
    const { error } = await supabaseClient
      .from('users')
      .update({ 
        membership_status: 'pending',
        updated_at: new Date().toISOString()
      })
      .eq('id', userId);

    if (error) {
      showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏: ' + error.message, 'error');
    } else {
      showNotification('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ–µ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.', 'success');
      await updateMembershipStatus();
    }
  }

  async function cancelMembershipApplication() {
    if (!confirm('–û—Ç–æ–∑–≤–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ?')) {
      return;
    }
    
    const { error } = await supabaseClient
      .from('users')
      .update({ 
        membership_status: 'New',
        updated_at: new Date().toISOString()
      })
      .eq('id', userId);

    if (error) {
      showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ –∑–∞—è–≤–∫–∏: ' + error.message, 'error');
    } else {
      showNotification('–ó–∞—è–≤–∫–∞ –æ—Ç–æ–∑–≤–∞–Ω–∞.', 'success');
      await updateMembershipStatus();
    }
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∏ –∑–∞–ø–∏—Å–µ–π ===
  async function loadEvents() {
    try {
      const { data, error } = await supabaseClient
        .from('events')
        .select('*')
        .eq('is_open', true)
        .gte('match_date', new Date().toISOString())
        .order('match_date', { ascending: true })
        .limit(3);

      const eventsList = document.getElementById('events-list');
      
      if (error) {
        eventsList.innerHTML = '<div class="event-item"><div class="event-info"><h4>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h4></div></div>';
        return;
      }
      
      if (!data || data.length === 0) {
        eventsList.innerHTML = '<div class="event-item"><div class="event-info"><h4>–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h4></div></div>';
        return;
      }

      eventsList.innerHTML = '';
      
      for (const event of data) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–∏—Å–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const { data: registration } = await supabaseClient
          .from('registrations')
          .select('id, status')
          .eq('user_id', userId)
          .eq('event_id', event.id)
          .maybeSingle();
        
        const isRegistered = registration && registration.status === 'registered';
        const isCancelled = registration && registration.status === 'cancelled';
        
        const eventDate = new Date(event.match_date);
        const formattedDate = eventDate.toLocaleDateString('ru-RU', {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event-item';
        
        let buttonHtml = '';
        if (isRegistered) {
          buttonHtml = `<button class="btn btn-small btn-disabled" disabled>‚úì –ó–∞–ø–∏—Å–∞–Ω</button>`;
        } else if (isCancelled) {
          buttonHtml = `<button class="btn btn-small btn-red" onclick="registerForEvent('${event.id}')">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞</button>`;
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞
          const { count: registeredCount } = await supabaseClient
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .eq('event_id', event.id)
            .eq('status', 'registered');
          
          const isFull = event.max_participants && registeredCount >= event.max_participants;
          
          if (isFull) {
            buttonHtml = `<button class="btn btn-small btn-disabled" disabled>–ú–µ—Å—Ç –Ω–µ—Ç</button>`;
          } else {
            buttonHtml = `<button class="btn btn-small btn-green" onclick="registerForEvent('${event.id}')">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>`;
          }
        }
        
        eventDiv.innerHTML = `
          <div class="event-info">
            <h4>${event.match_name}</h4>
            <div class="event-date">${formattedDate}</div>
            <div style="font-size: 0.85rem; color: #aaa;">${event.bar_address}</div>
            ${event.max_participants ? `<div style="font-size: 0.8rem; color: #FFC107;">üë• –ú–µ—Å—Ç: ${event.max_participants}</div>` : ''}
          </div>
          ${buttonHtml}
        `;
        eventsList.appendChild(eventDiv);
      }
    } catch (err) {
      console.error('Error loading events:', err);
    }
  }

  async function registerForEvent(eventId) {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å
      const { data: existing } = await supabaseClient
        .from('registrations')
        .select('id, status')
        .eq('user_id', userId)
        .eq('event_id', eventId)
        .maybeSingle();
      
      if (existing) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        const { error } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'registered',
            updated_at: new Date().toISOString()
          })
          .eq('id', existing.id);
        
        if (error) throw error;
        showNotification('‚úÖ –í—ã —Å–Ω–æ–≤–∞ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ!', 'success');
      } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        const { error } = await supabaseClient
          .from('registrations')
          .insert({
            user_id: userId,
            event_id: eventId,
            status: 'registered'
          });
        
        if (error) throw error;
        showNotification('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ!', 'success');
      }
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
      await loadEvents();
      
    } catch (error) {
      console.error('Error registering for event:', error);
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏: ' + error.message, 'error');
    }
  }

  // === –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ===
  function openEditModal() {
    loadMyRegistrationsForEdit();
    document.getElementById('edit-modal').style.display = 'flex';
  }

  function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
  }

  function openParticipantsModal() {
    loadEventsForParticipants();
    document.getElementById('participants-modal').style.display = 'flex';
  }

  function closeParticipantsModal() {
    document.getElementById('participants-modal').style.display = 'none';
  }

  function openQRModal() {
    document.getElementById('qr-modal').style.display = 'flex';
  }

  function closeQRModal() {
    document.getElementById('qr-modal').style.display = 'none';
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ===
  async function loadMyRegistrationsForEdit() {
    try {
      const { data, error } = await supabaseClient
        .from('registrations')
        .select(`
          id,
          status,
          created_at,
          events (
            id,
            match_name,
            match_date,
            bar_address
          )
        `)
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

      const modalContent = document.getElementById('edit-modal-content');
      
      if (error) {
        modalContent.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
        return;
      }
      
      if (!data || data.length === 0) {
        modalContent.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>';
        return;
      }

      let html = '<div style="max-height: 400px; overflow-y: auto;">';
      
      data.forEach(reg => {
        const event = reg.events;
        if (!event) return;
        
        const eventDate = new Date(event.match_date);
        const formattedDate = eventDate.toLocaleDateString('ru-RU', {
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const statusText = reg.status === 'registered' ? '–ó–∞–ø–∏—Å–∞–Ω' : 
                          reg.status === 'cancelled' ? '–û—Ç–º–µ–Ω–µ–Ω–æ' : 
                          reg.status === 'checked_in' ? '–ü–æ—Å–µ—Ç–∏–ª' : reg.status;
        
        const statusClass = reg.status === 'registered' ? 'btn-green' :
                           reg.status === 'cancelled' ? 'btn-red' : 'btn';
        
        html += `
          <div class="event-item" style="margin-bottom: 15px;">
            <div>
              <strong>${event.match_name}</strong><br>
              <small>üìÖ ${formattedDate}</small><br>
              <small>üìç ${event.bar_address}</small>
            </div>
            <div style="text-align: right;">
              <span class="btn-small ${statusClass}" style="margin-bottom: 5px; display: block;">
                ${statusText}
              </span>
              ${reg.status === 'registered' ? `
                <button class="btn-small btn-red" onclick="cancelRegistration('${reg.id}', '${event.match_name}')">
                  –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
              ` : ''}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      modalContent.innerHTML = html;
      
    } catch (err) {
      console.error('Error loading registrations:', err);
      modalContent.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    }
  }

  async function cancelRegistration(registrationId, eventName) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞ "${eventName}"?`)) {
      return;
    }
    
    try {
      const { error } = await supabaseClient
        .from('registrations')
        .update({ 
          status: 'cancelled',
          updated_at: new Date().toISOString()
        })
        .eq('id', registrationId);
      
      if (error) throw error;
      
      showNotification('‚úÖ –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
      await loadMyRegistrationsForEdit();
      await loadEvents(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
      
    } catch (error) {
      console.error('Error cancelling registration:', error);
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏', 'error');
    }
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ===
  async function loadEventsForParticipants() {
    try {
      const { data, error } = await supabaseClient
        .from('events')
        .select('id, match_name, match_date')
        .gte('match_date', new Date().toISOString())
        .order('match_date', { ascending: true });

      const modalContent = document.getElementById('participants-modal-content');
      
      if (error) {
        modalContent.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>';
        return;
      }
      
      if (!data || data.length === 0) {
        modalContent.innerHTML = '<p>–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>';
        return;
      }

      let html = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</p>';
      html += '<div style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">';
      
      data.forEach(event => {
        const eventDate = new Date(event.match_date);
        const formattedDate = eventDate.toLocaleDateString('ru-RU', {
          day: 'numeric',
          month: 'short'
        });
        
        html += `
          <a href="event-participants.html?event_id=${event.id}" class="btn">
            ${event.match_name} (${formattedDate})
          </a>
        `;
      });
      
      html += '</div>';
      modalContent.innerHTML = html;
      
    } catch (err) {
      console.error('Error loading events:', err);
      modalContent.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    }
  }

  // === QR –∫–æ–¥ ===
  async function showMyQR() {
    try {
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const { data: user } = await supabaseClient
        .from('users')
        .select('id, telegram_id, full_name')
        .eq('id', userId)
        .single();
      
      if (!user) {
        showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º QR –∫–æ–¥ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const qrData = JSON.stringify({
        user_id: user.id,
        telegram_id: user.telegram_id,
        name: user.full_name,
        timestamp: Date.now()
      });
      
      // –ö–æ–¥–∏—Ä—É–µ–º –≤ base64 –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
      const qrText = btoa(qrData);
      
      // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π QR (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É)
      const qrContent = document.getElementById('qr-modal-content');
      qrContent.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; display: inline-block;">
          <div style="font-family: monospace; font-size: 10px; letter-spacing: 2px; line-height: 10px;">
            <!-- –ü—Ä–æ—Å—Ç–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è QR -->
            <div>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>
            <div>‚ñà‚ñà          ‚ñà‚ñà</div>
            <div>‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà</div>
            <div>‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà</div>
            <div>‚ñà‚ñà          ‚ñà‚ñà</div>
            <div>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>
          </div>
        </div>
        <p style="margin-top: 15px; color: #aaa;">ID: ${user.id.substring(0, 8)}...</p>
        <p style="font-size: 0.9rem; color: #ccc;">${user.full_name}</p>
      `;
      
      openQRModal();
      
    } catch (error) {
      console.error('Error generating QR:', error);
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ QR –∫–æ–¥–∞', 'error');
    }
  }

  function scanQR() {
    showNotification('üì± –§—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR –∫–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
  }

  // === –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
  async function loadUserData() {
    try {
      const { data, error } = await supabaseClient
        .from('users')
        .select('full_name, points, membership_status')
        .eq('id', userId)
        .single();

      if (error || !data) {
        console.error('Error loading user:', error);
        document.getElementById('user-name').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        return;
      }

      document.getElementById('user-name').textContent = data.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      document.getElementById('user-points').textContent = data.points || 0;
      document.getElementById('user-status').textContent = `–°—Ç–∞—Ç—É—Å: ${getStatusText(data.membership_status || 'New', data.points || 0)}`;
      
      await updateMembershipStatus();
      
    } catch (err) {
      console.error('Unexpected error:', err);
    }
  }

  // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ ===
  function setupButtonHandlers() {
    document.getElementById('membership-btn').addEventListener('click', applyForMembership);
    document.getElementById('cancel-membership-btn').addEventListener('click', cancelMembershipApplication);
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  async function init() {
    await loadUserData();
    await loadEvents();
    setupButtonHandlers();
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    });
  }

  init();
</script>
</body>
</html>
