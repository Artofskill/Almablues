<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äî AlmaBlues</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    :root {
      --bg-dark: #001028;
      --chelsea-blue: #034694;
      --chelsea-blue-dark: #002366;
      --gold: #D4A017;
      --gold-hover: #E8B923;
      --text-light: #e0e0e0;
      --white: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      color: var(--gold);
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .user-info {
      background: rgba(3, 70, 148, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .user-name {
      font-weight: bold;
      font-size: 1.1rem;
      word-break: break-word;
    }

    .user-points {
      background: var(--gold);
      color: var(--bg-dark);
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      white-space: nowrap;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.08);
    }

    .card-title {
      font-family: 'Oswald', sans-serif;
      font-size: 1.2rem;
      color: var(--white);
      margin-bottom: 10px;
      line-height: 1.3;
    }

    .card-description {
      color: #aaa;
      font-size: 0.9rem;
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: var(--chelsea-blue);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .btn:hover {
      background: var(--chelsea-blue-dark);
    }

    .btn-gold {
      background: var(--gold);
      color: var(--bg-dark);
    }

    .btn-gold:hover {
      background: var(--gold-hover);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
      width: auto;
    }

    .btn-red {
      background: #f44336;
      color: white;
    }

    .btn-red:hover {
      background: #d32f2f;
    }

    .btn-green {
      background: #4CAF50;
      color: white;
    }

    .btn-green:hover {
      background: #388E3C;
    }

    .btn-disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
    }

    .btn-disabled:hover {
      background: #666;
    }

    .events-list {
      margin-top: 10px;
    }

    .event-item {
      background: rgba(3, 70, 148, 0.1);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .event-info h4 {
      color: var(--white);
      margin-bottom: 5px;
      font-size: 1.1rem;
    }

    .event-date {
      color: var(--gold);
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .event-address {
      color: #aaa;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .countdown {
      background: rgba(212, 160, 23, 0.1);
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 8px;
      font-family: monospace;
      font-size: 1.1rem;
      color: var(--gold);
      text-align: center;
      border: 1px solid rgba(212, 160, 23, 0.3);
    }

    .countdown.ended {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
      border-color: rgba(244, 67, 54, 0.3);
    }

    .registration-closed {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-top: 8px;
      text-align: center;
      border-left: 3px solid #f44336;
    }

    .status-info {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      border-left: 4px solid #FFC107;
    }

    .status-approved {
      background: rgba(0, 200, 83, 0.2);
      border-left: 4px solid #00C853;
    }

    .status-rejected {
      background: rgba(244, 67, 54, 0.2);
      border-left: 4px solid #F44336;
    }

    .status-new {
      background: rgba(33, 150, 243, 0.2);
      border-left: 4px solid #2196F3;
    }

    footer {
      text-align: center;
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: #777;
      font-size: 0.9rem;
    }

    .back-btn {
      display: inline-block;
      margin-top: 1rem;
      color: var(--gold);
      text-decoration: none;
      font-weight: 500;
    }

    .back-btn:hover {
      text-decoration: underline;
    }

    .event-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .event-actions .btn-small {
      flex: 1;
      min-width: 100px;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
    @media (max-width: 480px) {
      .container {
        padding: 0 10px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .card {
        padding: 15px;
      }
      
      .btn {
        padding: 12px;
        font-size: 0.95rem;
      }
      
      .user-info {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-points {
        align-self: flex-end;
      }
      
      .event-actions .btn-small {
        min-width: 100%;
      }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    .notification.success {
      background: #4CAF50;
    }

    .notification.error {
      background: #f44336;
    }

    .notification.info {
      background: #2196F3;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--bg-dark);
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid var(--chelsea-blue);
    }

    .close-modal {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gold);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .checkin-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    .scan-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }
    
    .scan-status.success {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      border: 1px solid #4CAF50;
    }
    
    .scan-status.error {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border: 1px solid #f44336;
    }
    
    .scan-status.info {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
      border: 1px solid #2196F3;
    }
  </style>
</head>

<body>
<div class="container">
  <header>
    <h1>AlmaBlues</h1>
    <p>Dashboard</p>
  </header>

  <div class="user-info">
    <div>
      <div class="user-name" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div id="user-status" style="font-size: 0.9rem; color: #aaa;">–°—Ç–∞—Ç—É—Å: New</div>
    </div>
    <div class="user-points">
      <span id="user-points">0</span> –æ—á–∫–æ–≤
    </div>
  </div>

  <div class="dashboard-grid">
    
    <!-- –ó–∞—è–≤–∫–∞ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ -->
    <div class="card" id="membership-card">
      <h3 class="card-title">üë• Membership</h3>
      <p class="card-description">–ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —á–ª–µ–Ω—Å—Ç–≤–æ –≤ AlmaBlues</p>
      
      <div id="membership-status-info"></div>
      
      <div id="membership-actions">
        <button class="btn btn-gold" id="membership-btn">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        <button class="btn btn-red" id="cancel-membership-btn" style="display: none; margin-top: 10px;">–û—Ç–æ–∑–≤–∞—Ç—å –∑–∞—è–≤–∫—É</button>
      </div>
    </div>

    <!-- –†–µ–π—Ç–∏–Ω–≥–∏ -->
    <div class="card">
      <h3 class="card-title">üèÜ –†–µ–π—Ç–∏–Ω–≥–∏</h3>
      <p class="card-description">–¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
      <a href="ratings.html" class="btn btn-gold" id="ratings-btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥</a>
    </div>

    <!-- –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
    <div class="card">
      <h3 class="card-title">üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
      <p class="card-description">–¢–µ–∫—É—â–µ–µ –∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
      
      <div class="events-list" id="events-list">
        <div class="event-item">
          <div class="event-info">
            <h4>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...</h4>
          </div>
        </div>
      </div>
      
      <a href="all-events.html" class="btn btn-gold" style="margin-top: 15px;">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
    </div>

    <!-- –ú–æ–∏ –∑–∞–ø–∏—Å–∏ -->
    <div class="card">
      <h3 class="card-title">üé´ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</h3>
      <p class="card-description">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
      <div class="event-actions">
        <a href="my-registrations.html" class="btn btn-small btn-gold" id="my-registrations-btn">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</a>
        <button class="btn btn-small" id="edit-registration-btn" onclick="openEditModal()">–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </div>
    </div>

    <!-- QR –∫–æ–¥ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ -->
    <div class="card">
      <h3 class="card-title">üì± –û—Ç–º–µ—Ç–∫–∞ –æ –ø–æ—Å–µ—â–µ–Ω–∏–∏</h3>
      <p class="card-description">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏</p>
      <div class="event-actions">
        <button class="btn btn-small btn-gold" id="scan-qr-btn" onclick="openQRScannerModal()">
          üì± –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥
        </button>
      </div>
      <div id="checkin-status" style="margin-top: 10px; font-size: 0.9rem;"></div>
    </div>
    
    <!-- –ß–∞–Ω—Ç—ã -->
    <div class="card">
      <h3 class="card-title">üéµ –ß–∞–Ω—Ç—ã</h3>
      <p class="card-description">–¢–µ–∫—Å—Ç—ã –∏ –∞—É–¥–∏–æ —á–∞–Ω—Ç–æ–≤ Chelsea FC</p>
      <a href="chants.html" class="btn btn-gold">–û—Ç–∫—Ä—ã—Ç—å —á–∞–Ω—Ç—ã</a>
    </div>

    <!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
    <div class="card">
      <h3 class="card-title">üìä –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h3>
      <p class="card-description">–¢–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ Chelsea –≤ –ê–ü–õ</p>
      <a href="table.html" class="btn btn-gold">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É</a>
    </div>
  </div>

  <footer>
    <p>Chelsea FC Supporters Club Kazakhstan ‚Ä¢ 2026 by @Artofskill</p>
    <a href="profile.html" class="back-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
  </footer>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
<div id="edit-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeEditModal()">&times;</span>
    <h3>üìù –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h3>
    <div id="edit-modal-content">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–∏—Ö –∑–∞–ø–∏—Å–µ–π...</p>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è QR —Å–∫–∞–Ω–µ—Ä–∞ -->
<div id="qr-scanner-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeQRScannerModal()">&times;</span>
    <h3>üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞</h3>
    <div id="scanner-container" style="text-align: center; margin: 20px 0;">
      <div id="qr-reader" style="width: 100%; max-width: 300px; margin: 0 auto;"></div>
      <div style="margin-top: 15px;">
        <p style="color: #FFC107;">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
        <p style="color: #aaa; font-size: 0.9rem;">
          ‚ö†Ô∏è –ß–µ–∫–∏–Ω–∏—Ç—å—Å—è –º–æ–∂–Ω–æ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –¥–æ –∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        </p>
      </div>
    </div>
    <div id="scanner-result" style="margin-top: 15px; text-align: center;"></div>
    <div style="margin-top: 20px;">
      <p>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤—Ä—É—á–Ω—É—é:</p>
      <input type="text" id="manual-event-code" placeholder='–í–≤–µ–¥–∏—Ç–µ {"e": "event_id"}' style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; background: #112; color: white; border: 1px solid #444;">
      <button class="btn" onclick="processManualCode()" style="margin-top: 10px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  // === Telegram ===
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  // === Supabase ===
  const supabaseUrl = 'https://zuapiixwzkleygaijulx.supabase.co';
  const supabaseKey = 'sb_publishable_Jsth-2GViNz5Ev3UWtrWTg_fbg4GAKx';

  const supabaseClient = supabase.createClient(
    supabaseUrl,
    supabaseKey
  );

  const userId = localStorage.getItem('userId');

  if (!userId) {
    alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    location.href = 'index.html';
  }

  // === –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å UTC+5 –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ ===
  const TIMEZONE_OFFSET = 5 * 60 * 60 * 1000;
  
  function getCurrentTimeUTC5() {
    const now = new Date();
    return new Date(now.getTime() + TIMEZONE_OFFSET);
  }
  
  function convertToUTC5(dateString) {
    const date = new Date(dateString);
    return new Date(date.getTime() + TIMEZONE_OFFSET);
  }
  
  function formatDateTimeUTC5(dateString) {
    const date = convertToUTC5(dateString);
    return date.toLocaleString('ru-RU', {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ–∫–∏–Ω–∞ (–≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –¥–æ –∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ)
  function isCheckinAvailable(eventTime) {
    const now = getCurrentTimeUTC5();
    const eventTimeUTC5 = convertToUTC5(eventTime);
    
    // –ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    const twoHoursAfter = new Date(eventTimeUTC5.getTime() + (2 * 60 * 60 * 1000));
    
    return now <= twoHoursAfter;
  }
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ–∫–∏–Ω–∞
  function getCheckinWindowText(eventTime) {
    const now = getCurrentTimeUTC5();
    const eventTimeUTC5 = convertToUTC5(eventTime);
    
    const twoHoursAfter = new Date(eventTimeUTC5.getTime() + (2 * 60 * 60 * 1000));
    
    if (now > twoHoursAfter) {
      return '–ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç (–ø—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)';
    } else {
      return '–ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω (–¥–æ 2 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)';
    }
  }
  
  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
  function getEventStatus(eventTime) {
    const now = getCurrentTimeUTC5();
    const eventTimeUTC5 = convertToUTC5(eventTime);
    const diff = eventTimeUTC5 - now;
    const twoHours = 2 * 60 * 60 * 1000;
    
    if (diff > 0) {
      return 'future'; // –ï—â–µ –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å
    } else if (diff > -twoHours) {
      return 'current'; // –ù–∞—á–∞–ª–æ—Å—å, –Ω–æ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 2 —á–∞—Å–æ–≤
    } else {
      return 'past'; // –ü—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 2 —á–∞—Å–æ–≤
    }
  }
  
  // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —á–µ–∫–∏–Ω–µ
  function showCheckinNotification(message, points = 0) {
    const notification = document.createElement('div');
    notification.className = 'checkin-notification';
    notification.innerHTML = `
      <div style="text-align: center;">
        <div style="font-size: 1.2rem; margin-bottom: 5px;">‚úÖ ${message}</div>
        ${points > 0 ? `<div style="font-size: 1rem;">üèÜ +${points} –±–∞–ª–ª–æ–≤!</div>` : ''}
      </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(-50%) translateY(-20px)';
      notification.style.transition = 'all 0.3s ease-out';
      
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–ª–µ–Ω—Å—Ç–≤–æ–º ===
  function getStatusText(status, points) {
    if (status === 'approved') {
      if (points < 100) {
        return '–ù–æ–≤–∏—á–æ–∫';
      } else if (points < 500) {
        return '–§–∞–Ω–∞—Ç';
      } else {
        return '–£–ª—å—Ç—Ä–∞—Å';
      }
    } else {
      const statusMap = {
        'New': '–ù–æ–≤—ã–π',
        'pending': '–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
      };
      return statusMap[status] || status;
    }
  }

  async function updateMembershipStatus() {
    const { data, error } = await supabaseClient
      .from('users')
      .select('membership_status, points')
      .eq('id', userId)
      .single();

    if (!error && data) {
      const statusElement = document.getElementById('user-status');
      const pointsElement = document.getElementById('user-points');
      const membershipBtn = document.getElementById('membership-btn');
      const cancelBtn = document.getElementById('cancel-membership-btn');
      const statusInfo = document.getElementById('membership-status-info');
      
      const status = data.membership_status || 'New';
      const points = data.points || 0;
      
      statusElement.textContent = `–°—Ç–∞—Ç—É—Å: ${getStatusText(status, points)}`;
      pointsElement.textContent = points;
      
      switch(status) {
        case 'New':
          membershipBtn.textContent = '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ';
          membershipBtn.disabled = false;
          membershipBtn.style.display = 'block';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = '<div class="status-info status-new">üéØ –í—ã –µ—â–µ –Ω–µ –ø–æ–¥–∞–≤–∞–ª–∏ –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ</div>';
          break;
          
        case 'pending':
          membershipBtn.style.display = 'none';
          cancelBtn.style.display = 'block';
          statusInfo.innerHTML = `
            <div class="status-info status-pending">
              ‚è≥ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
            </div>
          `;
          break;
          
        case 'approved':
          membershipBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = `
            <div class="status-info status-approved">
              ‚úÖ –í–∞—à–µ —á–ª–µ–Ω—Å—Ç–≤–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–∞–Ω-–∫–ª—É–±!
            </div>
          `;
          break;
          
        case 'rejected':
          membershipBtn.textContent = '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ';
          membershipBtn.disabled = false;
          membershipBtn.style.display = 'block';
          cancelBtn.style.display = 'none';
          statusInfo.innerHTML = `
            <div class="status-info status-rejected">
              ‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∞—Ç—å –µ–µ —Å–Ω–æ–≤–∞.
            </div>
          `;
          break;
      }
    }
  }

  async function applyForMembership() {
    if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ –≤ —Ñ–∞–Ω-–∫–ª—É–±–µ?')) {
      return;
    }
    
    const { error } = await supabaseClient
      .from('users')
      .update({ 
        membership_status: 'pending',
        updated_at: new Date().toISOString()
      })
      .eq('id', userId);

    if (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏: ' + error.message);
    } else {
      alert('‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ–µ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
      await updateMembershipStatus();
    }
  }

  async function cancelMembershipApplication() {
    if (!confirm('–û—Ç–æ–∑–≤–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ?')) {
      return;
    }
    
    const { error } = await supabaseClient
      .from('users')
      .update({ 
        membership_status: 'New',
        updated_at: new Date().toISOString()
      })
      .eq('id', userId);

    if (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ –∑–∞—è–≤–∫–∏: ' + error.message);
    } else {
      alert('–ó–∞—è–≤–∫–∞ –æ—Ç–æ–∑–≤–∞–Ω–∞.');
      await updateMembershipStatus();
    }
  }

  // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∏ –∑–∞–ø–∏—Å–µ–π ===
  async function loadEvents() {
    try {
      const now = getCurrentTimeUTC5();
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è –∑–∞–ø–∏—Å–∏
      const { data, error } = await supabaseClient
        .from('events')
        .select('*')
        .eq('is_open', true)
        .order('match_date', { ascending: true });

      const eventsList = document.getElementById('events-list');
      
      if (error) {
        eventsList.innerHTML = '<div class="event-item"><div class="event-info"><h4>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h4></div></div>';
        return;
      }
      
      if (!data || data.length === 0) {
        eventsList.innerHTML = '<div class="event-item"><div class="event-info"><h4>–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∏–ª–∏ —Ç–µ–∫—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h4></div></div>';
        return;
      }

      eventsList.innerHTML = '';
      
      let eventsCount = 0;
      
      for (const event of data) {
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∫–∞–∑ 4 –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏
        if (eventsCount >= 4) break;
        
        const eventTimeUTC5 = convertToUTC5(event.match_date);
        const now = getCurrentTimeUTC5();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Ç–µ–∫—É—â–∏–º –∏–ª–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–º
        const isPast = eventTimeUTC5 < now;
        const timeDiff = eventTimeUTC5 - now;
        const twoHours = 2 * 60 * 60 * 1000;
        
        // –ï—Å–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 2 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ
        if (isPast && Math.abs(timeDiff) > twoHours) {
          continue;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–∏—Å–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const { data: registration } = await supabaseClient
          .from('registrations')
          .select('id, status')
          .eq('user_id', userId)
          .eq('event_id', event.id)
          .maybeSingle();
        
        const isRegistered = registration && registration.status === 'registered';
        const isCancelled = registration && registration.status === 'cancelled';
        const isCheckedIn = registration && registration.status === 'checked_in';
        
        const formattedDate = formatDateTimeUTC5(event.match_date);
        const eventStatus = getEventStatus(event.match_date);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —á–µ–∫–∏–Ω–∞
        const checkinAvailable = isCheckinAvailable(event.match_date);
        
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event-item';
        eventDiv.id = `event-${event.id}`;
        
        let buttonHtml = '';
        let statusBadge = '';
        let checkinStatusHtml = '';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        if (eventStatus === 'current') {
          statusBadge = '<span style="background: #FF9800; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">–°–ï–ô–ß–ê–°</span>';
        } else if (eventStatus === 'future') {
          statusBadge = '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">–°–ö–û–†–û</span>';
        } else {
          statusBadge = '<span style="background: #666; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">–ü–†–û–®–ï–õ</span>';
        }
        
        if (isCheckedIn) {
          buttonHtml = `<button class="btn btn-small btn-disabled" disabled>‚úÖ –ü–æ—Å–µ—Ç–∏–ª</button>`;
          checkinStatusHtml = `<div style="color: #4CAF50; margin-top: 5px; font-size: 0.9rem;">–í—ã —É–∂–µ –æ—Ç–º–µ—Ç–∏–ª–∏—Å—å –Ω–∞ —ç—Ç–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</div>`;
        } else if (isRegistered) {
          if (checkinAvailable) {
            buttonHtml = `<button class="btn btn-small btn-green" onclick="showCheckinReminder('${event.id}', '${event.match_name}')">–û—Ç–º–µ—Ç–∏—Ç—å—Å—è</button>`;
            checkinStatusHtml = `<div style="color: #4CAF50; margin-top: 5px; font-size: 0.9rem;">–ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω! –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>`;
          } else {
            buttonHtml = `<button class="btn btn-small btn-disabled" disabled>–ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç</button>`;
            checkinStatusHtml = `<div style="color: #f44336; margin-top: 5px; font-size: 0.9rem;">${getCheckinWindowText(event.match_date)}</div>`;
          }
        } else if (isCancelled) {
          buttonHtml = `<button class="btn btn-small btn-disabled" disabled>–û—Ç–º–µ–Ω–µ–Ω–æ</button>`;
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞
          const { count: registeredCount } = await supabaseClient
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .eq('event_id', event.id)
            .eq('status', 'registered');
          
          const isFull = event.max_participants && registeredCount >= event.max_participants;
          
          if (isFull) {
            buttonHtml = `<button class="btn btn-small btn-disabled" disabled>–ú–µ—Å—Ç –Ω–µ—Ç</button>`;
          } else {
            buttonHtml = `<button class="btn btn-small btn-green" onclick="registerForEvent('${event.id}')">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>`;
          }
        }
        
        eventDiv.innerHTML = `
          <div class="event-info">
            <h4>${event.match_name} ${statusBadge}</h4>
            <div class="event-date">üìÖ ${formattedDate} (UTC+5)</div>
            <div class="event-address">üìç ${event.bar_address}</div>
            ${event.description ? `<div style="font-size: 0.85rem; color: #aaa; margin-top: 5px;">üìù ${event.description}</div>` : ''}
            ${event.max_participants ? `<div style="font-size: 0.8rem; color: #FFC107; margin-top: 5px;">üë• –ú–µ—Å—Ç: ${event.max_participants}</div>` : ''}
            ${event.points_award ? `<div style="font-size: 0.8rem; color: #D4A017; margin-top: 5px;">üèÜ –ë–∞–ª–ª–æ–≤ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ: ${event.points_award}</div>` : ''}
          </div>
          ${checkinStatusHtml}
          <div class="event-actions">
            ${buttonHtml}
            <a href="event-participants.html?event_id=${event.id}" class="btn btn-small">–£—á–∞—Å—Ç–Ω–∏–∫–∏</a>
          </div>
        `;
        eventsList.appendChild(eventDiv);
        eventsCount++;
      }
      
      if (eventsCount === 0) {
        eventsList.innerHTML = '<div class="event-item"><div class="event-info"><h4>–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∏–ª–∏ —Ç–µ–∫—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h4></div></div>';
      }
    } catch (err) {
      console.error('Error loading events:', err);
    }
  }
  
  // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —á–µ–∫–∏–Ω–µ
  function showCheckinReminder(eventId, eventName) {
    const reminder = document.createElement('div');
    reminder.className = 'notification info';
    reminder.innerHTML = `
      <div style="text-align: center;">
        <div style="font-size: 1.1rem; margin-bottom: 5px;">üì± ${eventName}</div>
        <div>–ß—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ, –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <button style="background: var(--gold); color: var(--bg-dark); border: none; padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer;" onclick="openQRScannerModal(); document.querySelector('.notification').remove();">
          –û—Ç–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–µ—Ä
        </button>
      </div>
    `;
    
    document.body.appendChild(reminder);
    
    setTimeout(() => {
      reminder.remove();
    }, 5000);
  }

  async function registerForEvent(eventId) {
    try {
      const { data: event } = await supabaseClient
        .from('events')
        .select('match_name')
        .eq('id', eventId)
        .single();
      
      if (!event) {
        alert('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å
      const { data: existing } = await supabaseClient
        .from('registrations')
        .select('id, status')
        .eq('user_id', userId)
        .eq('event_id', eventId)
        .maybeSingle();
      
      if (existing) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        const { error } = await supabaseClient
          .from('registrations')
          .update({ 
            status: 'registered',
            updated_at: new Date().toISOString()
          })
          .eq('id', existing.id);
        
        if (error) throw error;
        showNotification(`‚úÖ –í—ã —Å–Ω–æ–≤–∞ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${event.match_name}"!`, 'success');
      } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        const { error } = await supabaseClient
          .from('registrations')
          .insert({
            user_id: userId,
            event_id: eventId,
            status: 'registered'
          });
        
        if (error) throw error;
        showNotification(`‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${event.match_name}"!`, 'success');
      }
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
      await loadEvents();
      
    } catch (error) {
      console.error('Error registering for event:', error);
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏: ' + error.message, 'error');
    }
  }

  // === –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ===
  function openEditModal() {
    loadMyRegistrationsForEdit();
    document.getElementById('edit-modal').style.display = 'flex';
  }

  function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
  }

  function openQRScannerModal() {
    document.getElementById('qr-scanner-modal').style.display = 'flex';
    document.getElementById('scanner-result').innerHTML = '';
    document.getElementById('manual-event-code').value = '';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫–∞–Ω–µ—Ä
    if (typeof Html5Qrcode !== 'undefined') {
      initQRScanner();
    } else {
      document.getElementById('scanner-container').innerHTML = 
        '<p style="color: #FFC107;">‚ö†Ô∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</p>' +
        '<p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ</p>';
    }
  }

  function closeQRScannerModal() {
    document.getElementById('qr-scanner-modal').style.display = 'none';
    stopQRScanner();
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  async function loadMyRegistrationsForEdit() {
    try {
      const { data, error } = await supabaseClient
        .from('registrations')
        .select(`
          id,
          status,
          created_at,
          events (
            id,
            match_name,
            match_date,
            bar_address,
            description
          )
        `)
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

      const modalContent = document.getElementById('edit-modal-content');
      
      if (error) {
        modalContent.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π</p>';
        return;
      }
      
      if (!data || data.length === 0) {
        modalContent.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>';
        return;
      }

      let html = '<div style="max-height: 400px; overflow-y: auto;">';
      
      data.forEach(reg => {
        const event = reg.events;
        if (!event) return;
        
        const eventDate = convertToUTC5(event.match_date);
        const formattedDate = eventDate.toLocaleDateString('ru-RU', {
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const statusText = reg.status === 'registered' ? '–ó–∞–ø–∏—Å–∞–Ω' : 
                          reg.status === 'cancelled' ? '–û—Ç–º–µ–Ω–µ–Ω–æ' : 
                          reg.status === 'checked_in' ? '–ü–æ—Å–µ—Ç–∏–ª' : reg.status;
        
        const statusClass = reg.status === 'registered' ? 'btn-green' :
                           reg.status === 'cancelled' ? 'btn-red' : 'btn';
        
        const checkinAvailable = isCheckinAvailable(event.match_date);
        
        html += `
          <div class="event-item" style="margin-bottom: 15px;">
            <div>
              <strong>${event.match_name}</strong><br>
              <small>üìÖ ${formattedDate} (UTC+5)</small><br>
              <small>üìç ${event.bar_address}</small><br>
              ${event.description ? `<small style="color: #aaa; display: block; margin-top: 5px;">üìù ${event.description}</small>` : ''}
              <small style="color: ${checkinAvailable ? '#4CAF50' : '#f44336'}; display: block; margin-top: 5px;">
                ${checkinAvailable ? '‚úÖ –ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ß–µ–∫–∏–Ω –∑–∞–∫—Ä—ã—Ç'}
              </small>
            </div>
            <div style="text-align: right;">
              <span class="btn-small ${statusClass}" style="margin-bottom: 5px; display: block;">
                ${statusText}
              </span>
              ${reg.status === 'registered' ? `
                <button class="btn-small btn-red" onclick="cancelRegistration('${reg.id}', '${event.match_name}')">
                  –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
              ` : ''}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      modalContent.innerHTML = html;
      
    } catch (err) {
      console.error('Error loading registrations:', err);
      modalContent.innerHTML = '<p style="color: #ff6666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    }
  }

  async function cancelRegistration(registrationId, eventName) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞ "${eventName}"?`)) {
      return;
    }
    
    try {
      const { error } = await supabaseClient
        .from('registrations')
        .update({ 
          status: 'cancelled',
          updated_at: new Date().toISOString()
        })
        .eq('id', registrationId);
      
      if (error) throw error;
      
      showNotification('‚úÖ –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
      await loadMyRegistrationsForEdit();
      await loadEvents();
      
    } catch (error) {
      console.error('Error cancelling registration:', error);
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏', 'error');
    }
  }

  // === QR —Å–∫–∞–Ω–µ—Ä ===
  let html5QrCode = null;
  let isScanning = false;
  let lastScannedCode = '';

  function initQRScanner() {
    try {
      if (!html5QrCode && typeof Html5Qrcode !== 'undefined') {
        html5QrCode = new Html5Qrcode("qr-reader");
        
        const config = { 
          fps: 10, 
          qrbox: { width: 250, height: 250 },
          formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE]
        };
        
        html5QrCode.start(
          { facingMode: "environment" },
          config,
          onQRCodeScanned
        ).catch(err => {
          console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
          document.getElementById('scanner-container').innerHTML = 
            '<p style="color: #ff6666;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ</p>' +
            '<p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ</p>';
        });
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞:", error);
    }
  }

  function stopQRScanner() {
    if (html5QrCode && isScanning) {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        html5QrCode = null;
        isScanning = false;
      }).catch(err => {
        console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:", err);
        html5QrCode = null;
        isScanning = false;
      });
    }
  }

  function onQRCodeScanned(decodedText, decodedResult) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–∫–∞–Ω–∏—Ä—É–µ–º –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç –∫–æ–¥
    if (isScanning || lastScannedCode === decodedText) {
      return;
    }
    
    lastScannedCode = decodedText;
    isScanning = true;
    
    console.log("QR –∫–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω:", decodedText);
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        html5QrCode = null;
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        processScannedCode(decodedText);
      }).catch(err => {
        console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:", err);
        html5QrCode = null;
        processScannedCode(decodedText);
      });
    } else {
      processScannedCode(decodedText);
    }
  }

function processScannedCode(decodedText) {
  const scannerResult = document.getElementById('scanner-result');
  scannerResult.innerHTML = '<p>‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ QR –∫–æ–¥–∞...</p>';
  
  try {
    const eventData = JSON.parse(decodedText);
    processCheckin(eventData, 'scanner');
  } catch (error) {
    scannerResult.innerHTML = 
      '<div class="scan-status error">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞</div>';
    isScanning = false;
    lastScannedCode = '';
    
    // –£–ë–ò–†–ê–ï–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö - —Ç–µ–ø–µ—Ä—å —Å–∫–∞–Ω–µ—Ä –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∞–º
    // setTimeout(() => {
    //   if (document.getElementById('qr-scanner-modal').style.display === 'flex') {
    //     initQRScanner();
    //   }
    // }, 2000);
  }
}

function restartScanner() {
  const scannerResult = document.getElementById('scanner-result');
  scannerResult.innerHTML = '';
  isScanning = false;
  lastScannedCode = '';
  
  if (document.getElementById('qr-scanner-modal').style.display === 'flex') {
    initQRScanner();
  }
}

  function processManualCode() {
    const manualCode = document.getElementById('manual-event-code').value.trim();
    
    if (!manualCode) {
      showNotification('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', 'error');
      return;
    }
    
    try {
      const eventData = JSON.parse(manualCode);
      processCheckin(eventData, 'manual');
    } catch (error) {
      showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞', 'error');
    }
  }

  // === –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —á–µ–∫–∏–Ω–∞ ===
  async function processCheckin(eventData, source = 'manual') {
    if (!eventData.e) {
      const message = '‚ùå –í QR –∫–æ–¥–µ –Ω–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è';

if (source === 'scanner') {
  document.getElementById('scanner-result').innerHTML = 
    `<div class="scan-status error">${message}</div>
     <button class="btn" onclick="restartScanner()" style="margin-top: 10px;">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>`;
  isScanning = false;
  lastScannedCode = '';
  
}
    
    const eventId = eventData.e;
    
    if (source === 'scanner') {
      document.getElementById('scanner-result').innerHTML = 
        '<div class="scan-status info">‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–∏–Ω–∞...</div>';
    }
    
    try {
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
      const { data: event, error: eventError } = await supabaseClient
        .from('events')
        .select('id, match_name, match_date, points_award')
        .eq('id', eventId)
        .single();
      
      if (eventError || !event) {
        const message = '‚ùå –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
        if (source === 'scanner') {
          document.getElementById('scanner-result').innerHTML = 
            `<div class="scan-status error">${message}</div>`;
          isScanning = false;
          lastScannedCode = '';
          
          setTimeout(() => {
            if (document.getElementById('qr-scanner-modal').style.display === 'flex') {
              initQRScanner();
            }
          }, 2000);
        } else {
          showNotification(message, 'error');
        }
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è —á–µ–∫–∏–Ω–∞
      const checkinAvailable = isCheckinAvailable(event.match_date);
      if (!checkinAvailable) {
        const message = `‚ùå ${getCheckinWindowText(event.match_date)}`;
        if (source === 'scanner') {
          document.getElementById('scanner-result').innerHTML = 
            `<div class="scan-status error">${message}</div>`;
          isScanning = false;
          lastScannedCode = '';
          
          setTimeout(() => {
            if (document.getElementById('qr-scanner-modal').style.display === 'flex') {
              initQRScanner();
            }
          }, 2000);
        } else {
          showNotification(message, 'error');
        }
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–∏—Å–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
      const { data: registration } = await supabaseClient
        .from('registrations')
        .select('id, status')
        .eq('user_id', userId)
        .eq('event_id', eventId)
        .maybeSingle();
      
      if (!registration) {
        const message = `‚ùå –í—ã –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${event.match_name}"`;
        if (source === 'scanner') {
          document.getElementById('scanner-result').innerHTML = 
            `<div class="scan-status error">${message}</div>`;
          isScanning = false;
          lastScannedCode = '';
          
          setTimeout(() => {
            if (document.getElementById('qr-scanner-modal').style.display === 'flex') {
              initQRScanner();
            }
          }, 2000);
        } else {
          showNotification(message, 'error');
        }
        return;
      }
      
      if (registration.status === 'checked_in') {
        const message = `‚ö†Ô∏è –í—ã —É–∂–µ –æ—Ç–º–µ—Ç–∏–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ "${event.match_name}"`;
        if (source === 'scanner') {
          document.getElementById('scanner-result').innerHTML = 
            `<div class="scan-status info">${message}</div>`;
          isScanning = false;
          lastScannedCode = '';
          
          setTimeout(() => {
            if (document.getElementById('qr-scanner-modal').style.display === 'flex') {
              initQRScanner();
            }
          }, 2000);
        } else {
          showNotification(message, 'info');
        }
        return;
      }
      
      if (registration.status === 'cancelled') {
        const message = `‚ùå –í–∞—à–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "${event.match_name}" –æ—Ç–º–µ–Ω–µ–Ω–∞`;
        if (source === 'scanner') {
          document.getElementById('scanner-result').innerHTML = 
            `<div class="scan-status error">${message}</div>`;
          isScanning = false;
          lastScannedCode = '';
          
          setTimeout(() => {
            if (document.getElementById('qr-scanner-modal').style.display === 'flex') {
              initQRScanner();
            }
          }, 2000);
        } else {
          showNotification(message, 'error');
        }
        return;
      }
      
      // –û—Ç–º–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –ø–æ—Å–µ—Ç–∏–≤—à–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
      const { error: updateError } = await supabaseClient
        .from('registrations')
        .update({ 
          status: 'checked_in',
          checkin_time: new Date().toISOString(),
          updated_at: new Date().toISOString()
        })
        .eq('id', registration.id);
      
      if (updateError) throw updateError;
      
      // –ù–ê–ß–ò–°–õ–Ø–ï–ú –ë–ê–õ–õ–´ –ó–ê –ü–û–°–ï–©–ï–ù–ò–ï
      const pointsAward = event.points_award || 10;
      
      // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const { data: userData, error: userError } = await supabaseClient
        .from('users')
        .select('points')
        .eq('id', userId)
        .single();
      
      if (userError) throw userError;
      
      const currentPoints = userData.points || 0;
      const newPoints = currentPoints + pointsAward;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const { error: pointsError } = await supabaseClient
        .from('users')
        .update({
          points: newPoints,
          updated_at: new Date().toISOString()
        })
        .eq('id', userId);
      
      if (pointsError) throw pointsError;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
if (source === 'scanner') {
  document.getElementById('scanner-result').innerHTML = 
    `<div class="scan-status success">
      <div style="font-size: 1.2rem; margin-bottom: 10px;">‚úÖ –£—Å–ø–µ—à–Ω–æ!</div>
      <div>–í—ã –æ—Ç–º–µ—Ç–∏–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</div>
      <div style="font-weight: bold; margin: 5px 0;">${event.match_name}</div>
      <div style="color: #D4A017; margin-top: 10px;">üèÜ +${pointsAward} –±–∞–ª–ª–æ–≤</div>
      <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">–í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤: ${newPoints}</div>
      <button class="btn" onclick="closeQRScannerModal()" style="margin-top: 10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showCheckinNotification(`–í—ã –æ—Ç–º–µ—Ç–∏–ª–∏—Å—å –Ω–∞ "${event.match_name}"!`, pointsAward);
        
        // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        await loadUserData();
        await loadEvents();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          closeQRScannerModal();
        }, 3000);
      } else {
        showNotification(`‚úÖ –í—ã –æ—Ç–º–µ—Ç–∏–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ "${event.match_name}"! +${pointsAward} –±–∞–ª–ª–æ–≤`, 'success');
        await loadUserData();
        await loadEvents();
      }
      
    } catch (error) {
      console.error('Error processing checkin:', error);
      const message = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–∏–Ω–∞';
      if (source === 'scanner') {
        document.getElementById('scanner-result').innerHTML = 
          `<div class="scan-status error">${message}</div>`;
        isScanning = false;
        lastScannedCode = '';
        
        setTimeout(() => {
          if (document.getElementById('qr-scanner-modal').style.display === 'flex') {
            initQRScanner();
          }
        }, 2000);
      } else {
        showNotification(message, 'error');
      }
    }
  }

  // === –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
  async function loadUserData() {
    try {
      const { data, error } = await supabaseClient
        .from('users')
        .select('full_name, points, membership_status')
        .eq('id', userId)
        .single();

      if (error || !data) {
        console.error('Error loading user:', error);
        document.getElementById('user-name').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        return;
      }

      document.getElementById('user-name').textContent = data.full_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      document.getElementById('user-points').textContent = data.points || 0;
      document.getElementById('user-status').textContent = `–°—Ç–∞—Ç—É—Å: ${getStatusText(data.membership_status || 'New', data.points || 0)}`;
      
      await updateMembershipStatus();
      
    } catch (err) {
      console.error('Unexpected error:', err);
    }
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  async function init() {
    await loadUserData();
    await loadEvents();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —á–ª–µ–Ω—Å—Ç–≤–∞
    document.getElementById('membership-btn').addEventListener('click', applyForMembership);
    document.getElementById('cancel-membership-btn').addEventListener('click', cancelMembershipApplication);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
          if (modal.id === 'qr-scanner-modal') {
            stopQRScanner();
            isScanning = false;
            lastScannedCode = '';
          }
        }
      });
    });
  }

  init();
</script>
</body>
</html>
